<!DOCTYPE html>
<html lang="id" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Dokter | KonsulSehat</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --font-primary: 'Inter', 'Poppins', sans-serif;
            --bg-primary-light: #f7f9fc; /* Slightly off-white */
            --bg-secondary-light: #ffffff;
            --bg-muted-light: #eef2f7; /* Softer muted */
            --text-primary-light: #1a202c; /* Darker text for better contrast */
            --text-secondary-light: #4a5568;
            --text-muted-light: #718096;
            --border-color-light: #e2e8f0;
            --card-shadow-light: 0 4px 6px -1px rgba(0, 0, 0, 0.07), 0 2px 4px -1px rgba(0, 0, 0, 0.04);
            --card-shadow-hover-light: 0 10px 15px -3px rgba(0, 0, 0, 0.07), 0 4px 6px -2px rgba(0, 0, 0, 0.03);
            --navbar-bg-light: #ffffff; /* White navbar for a cleaner look */
            --navbar-text-light: #2d3748; /* Darker navbar text */
            --accent-color-light: #4F46E5; /* Indigo */
            --accent-color-darker-light: #4338CA;
            --success-color-light: #10B981; /* Emerald */
            --warning-color-light: #F59E0B; /* Amber */
            --danger-color-light: #EF4444; /* Red */
            --info-color-light: #3B82F6; /* Blue 500 */
            --sidebar-width: 16rem;
            --active-nav-bg-light: #e0e7ff; /* Lighter active nav */
            --active-nav-text-light: var(--accent-color-light);
            --queue-button-bg-light: var(--accent-color-light);
            --queue-button-text-light: #ffffff;
            --queue-button-hover-bg-light: var(--accent-color-darker-light);
        }

        html.dark {
            --bg-primary-dark: #0f172a; /* Very dark blue */
            --bg-secondary-dark: #1e293b; /* Dark slate */
            --bg-muted-dark: #334155; /* Slate */
            --text-primary-dark: #f1f5f9; /* Light gray */
            --text-secondary-dark: #cbd5e1; /* Slate 300 */
            --text-muted-dark: #94a3b8; /* Slate 400 */
            --border-color-dark: #3e4c5f; /* Darker border */
            --card-shadow-dark: 0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -1px rgba(0, 0, 0, 0.16);
            --card-shadow-hover-dark: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.13);
            --navbar-bg-dark: #1a2332; /* Slightly lighter than primary bg */
            --navbar-text-dark: #e2e8f0;
            --accent-color-dark: #6366F1; /* Brighter Indigo for dark mode */
            --accent-color-darker-dark: #4F46E5;
            --success-color-dark: #34D399; /* Brighter Emerald */
            --warning-color-dark: #FBBF24; /* Brighter Amber */
            --danger-color-dark: #F87171; /* Brighter Red */
            --info-color-dark: #60A5FA; /* Blue 400 */
            --active-nav-bg-dark: #312e81; /* Darker active nav */
            --active-nav-text-dark: #c7d2fe; /* Lighter active text */
            --queue-button-bg-dark: var(--accent-color-dark);
            --queue-button-text-dark: #0f172a; /* Dark text on bright button */
            --queue-button-hover-bg-dark: var(--accent-color-darker-dark);
        }

        body {
            font-family: var(--font-primary);
            background-color: var(--bg-primary-light);
            color: var(--text-primary-light);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s ease, color 0.3s ease;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        html.dark body {
            background-color: var(--bg-primary-dark);
            color: var(--text-primary-dark);
        }

        nav {
            background-color: var(--navbar-bg-light);
            color: var(--navbar-text-light);
            padding: 0; /* Removed padding, handled by container */
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            position: fixed;
            top: 0; left: 0; right: 0;
            z-index: 1000; /* Ensure navbar is on top */
            height: 4.5rem; /* Standard height */
            display: flex;
            align-items: center;
            border-bottom: 1px solid var(--border-color-light);
        }
        html.dark nav {
            background-color: var(--navbar-bg-dark);
            color: var(--navbar-text-dark);
            border-bottom: 1px solid var(--border-color-dark);
        }
        nav .container {
            padding: 0 1.5rem; /* Horizontal padding for container */
            width: 100%;
        }
        nav a {
            color: var(--navbar-text-light);
            text-decoration: none;
            font-weight: 600;
            transition: color 0.2s ease;
        }
        html.dark nav a { color: var(--navbar-text-dark); }
        nav a:hover { color: var(--accent-color-light); }
        html.dark nav a:hover { color: var(--accent-color-dark); }

        #sidebarToggleBtn {
            padding: 0.5rem;
            border-radius: 0.375rem;
            transition: background-color 0.2s ease, color 0.2s ease;
            margin-right: 1rem;
            color: var(--text-secondary-light);
        }
        html.dark #sidebarToggleBtn { color: var(--text-secondary-dark); }
        #sidebarToggleBtn:hover {
            background-color: var(--bg-muted-light);
            color: var(--accent-color-light);
        }
        html.dark #sidebarToggleBtn:hover {
            background-color: var(--bg-muted-dark);
            color: var(--accent-color-dark);
        }
        #sidebarToggleBtn i { font-size: 1.25rem; }

        .content-area {
            display: flex;
            flex-grow: 1;
            padding-top: 4.5rem; /* Space for fixed navbar */
        }

        aside {
            width: var(--sidebar-width);
            background-color: var(--bg-secondary-light);
            border-right: 1px solid var(--border-color-light);
            padding: 1.5rem 1rem; /* Adjusted padding */
            flex-shrink: 0;
            transition: transform 0.3s ease-in-out, width 0.3s ease-in-out, opacity 0.3s ease-in-out;
            overflow-y: auto;
            position: fixed;
            top: 4.5rem; bottom: 0; left: 0;
            z-index: 990; /* Below navbar */
        }
        html.dark aside {
            background-color: var(--bg-secondary-dark);
            border-right: 1px solid var(--border-color-dark);
        }
        aside.collapsed {
            transform: translateX(-100%);
            width: 0;
            padding: 1.5rem 0;
            opacity: 0;
            pointer-events: none;
        }
        aside h3 {
            font-size: 0.75rem; /* Smaller heading */
            text-transform: uppercase;
            letter-spacing: 0.075em; /* Wider spacing */
            margin-bottom: 1rem;
            color: var(--text-muted-light);
            font-weight: 700; /* Bolder */
            padding: 0 0.5rem;
        }
        html.dark aside h3 { color: var(--text-muted-dark); }

        aside .nav-button {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            border-radius: 0.5rem;
            color: var(--text-secondary-light);
            transition: background-color 0.2s ease, color 0.2s ease, transform 0.1s ease;
            cursor: pointer;
            font-weight: 500;
        }
        html.dark aside .nav-button { color: var(--text-secondary-dark); }
        aside .nav-button i {
            margin-right: 0.875rem; /* Increased icon margin */
            width: 20px; /* Fixed width for icon alignment */
            text-align: center;
            color: var(--text-muted-light);
            font-size: 0.9rem; /* Slightly smaller icon */
        }
        html.dark aside .nav-button i { color: var(--text-muted-dark); }
        aside .nav-button:hover {
            background-color: var(--bg-muted-light);
            color: var(--accent-color-light);
        }
        html.dark aside .nav-button:hover {
            background-color: var(--bg-muted-dark);
            color: var(--accent-color-dark);
        }
        aside .nav-button.active {
            background-color: var(--active-nav-bg-light);
            color: var(--active-nav-text-light);
            font-weight: 600;
        }
        html.dark aside .nav-button.active {
            background-color: var(--active-nav-bg-dark);
            color: var(--active-nav-text-dark);
        }
        aside .nav-button.active i { color: var(--active-nav-text-light); }
        html.dark aside .nav-button.active i { color: var(--active-nav-text-dark); }

        aside .nav-button-queue {
            background-color: var(--queue-button-bg-light);
            color: var(--queue-button-text-light);
        }
        html.dark aside .nav-button-queue {
            background-color: var(--queue-button-bg-dark);
            color: var(--queue-button-text-dark);
        }
        aside .nav-button-queue i { color: var(--queue-button-text-light); }
        html.dark aside .nav-button-queue i { color: var(--queue-button-text-dark); }
        aside .nav-button-queue:hover {
            background-color: var(--queue-button-hover-bg-light);
            color: var(--queue-button-text-light);
        }
        html.dark aside .nav-button-queue:hover {
            background-color: var(--queue-button-hover-bg-dark);
            color: var(--queue-button-text-dark);
        }
        aside .nav-button-queue.active {
            background-color: var(--queue-button-hover-bg-light); /* Use hover color for active */
            color: var(--queue-button-text-light);
        }
        html.dark aside .nav-button-queue.active {
            background-color: var(--queue-button-hover-bg-dark);
            color: var(--queue-button-text-dark);
        }
         aside .nav-button-queue.active i { color: var(--queue-button-text-light); }
        html.dark aside .nav-button-queue.active i { color: var(--queue-button-text-dark); }


        main {
            flex-grow: 1;
            padding: 2rem; /* Increased padding */
            transition: margin-left 0.3s ease-in-out;
            margin-left: var(--sidebar-width);
            overflow-y: auto;
        }
        main.sidebar-collapsed { margin-left: 0; }

        #sidebarOverlay {
            position: fixed; inset: 0;
            background-color: rgba(0,0,0,0.5);
            z-index: 980; /* Below sidebar, above content */
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        #sidebarOverlay.active { display: block; opacity: 1; }


        @media (max-width: 767px) {
            aside {
                transform: translateX(-100%);
                opacity: 0;
                box-shadow: 0 0 20px rgba(0,0,0,0.1);
            }
            aside.open-mobile {
                transform: translateX(0);
                opacity: 1;
            }
            main { margin-left: 0; padding: 1.5rem; }
            body.overflow-hidden-custom { overflow: hidden; }
        }
        @media (min-width: 768px) {
            aside {
                position: sticky; top: 4.5rem;
                height: calc(100vh - 4.5rem);
                transform: translateX(0) !important;
                opacity: 1 !important;
                pointer-events: auto !important;
            }
            aside.collapsed {
                width: 0;
                padding: 1.5rem 0;
                overflow: hidden;
            }
            main.sidebar-collapsed { margin-left: 0; }
            main:not(.sidebar-collapsed) { margin-left: var(--sidebar-width); }
            #sidebarOverlay { display: none !important; }
            body.overflow-hidden-custom { overflow: auto !important; }
        }

        .card {
            background-color: var(--bg-secondary-light);
            padding: 1.5rem; /* Standardized padding */
            border-radius: 0.75rem; /* Softer radius */
            box-shadow: var(--card-shadow-light);
            transition: background-color 0.3s ease, box-shadow 0.2s ease, transform 0.2s ease;
            margin-bottom: 1.5rem;
        }
        html.dark .card {
            background-color: var(--bg-secondary-dark);
            box-shadow: var(--card-shadow-dark);
        }
        .card:hover {
            box-shadow: var(--card-shadow-hover-light);
            transform: translateY(-2px);
        }
        html.dark .card:hover {
            box-shadow: var(--card-shadow-hover-dark);
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color-light);
        }
        html.dark .card-header { border-bottom: 1px solid var(--border-color-dark); }
        .card-title {
            font-size: 1.25rem; /* Larger title */
            font-weight: 700; /* Bolder title */
            color: var(--text-primary-light);
        }
        html.dark .card-title { color: var(--text-primary-dark); }


        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: var(--accent-color-light);
            border-radius: 50%;
            width: 36px; height: 36px;
            animation: spin 0.8s linear infinite;
        }
        html.dark .loading-spinner { border-left-color: var(--accent-color-dark); }
        @keyframes spin { to { transform: rotate(360deg); } }

        .content-section { display: none; }
        .content-section.active { display: block; }
        .content-view { display: none; } /* For sub-sections within a content-section */
        .content-view.active { display: block; }


        #appointmentList li, #detectionHistoryTable tbody tr {
            background-color: var(--bg-secondary-light);
            border: 1px solid var(--border-color-light);
            box-shadow: var(--card-shadow-light);
            padding: 1.25rem;
            margin-bottom: 1rem;
            border-radius: 0.5rem; /* Slightly smaller radius for list items */
            list-style: none; padding-left: 0; margin-left: 0;
            color: var(--text-secondary-light);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-wrap: wrap;
            transition: box-shadow 0.2s ease, transform 0.2s ease;
        }
        html.dark #appointmentList li, html.dark #detectionHistoryTable tbody tr {
            background-color: var(--bg-secondary-dark);
            border: 1px solid var(--border-color-dark);
            box-shadow: var(--card-shadow-dark);
            color: var(--text-secondary-dark);
        }
        #appointmentList li:hover, #detectionHistoryTable tbody tr:hover {
            box-shadow: var(--card-shadow-hover-light);
            transform: translateY(-2px);
        }
        html.dark #appointmentList li:hover, html.dark #detectionHistoryTable tbody tr:hover {
            box-shadow: var(--card-shadow-hover-dark);
        }

        #appointmentList li .appointment-details {
            flex-grow: 1; margin-right: 1rem;
            min-width: 180px; flex-basis: 45%;
        }
        #appointmentList li strong {
            color: var(--text-primary-light); font-weight: 600;
            display: block; margin-bottom: 0.375rem; font-size: 1.05em;
        }
        html.dark #appointmentList li strong { color: var(--text-primary-dark); }
        #appointmentList li span {
            color: var(--text-muted-light); font-size: 0.875em;
            display: flex; align-items: center; margin-bottom: 0.25rem;
        }
        html.dark #appointmentList li span { color: var(--text-muted-dark); }
        #appointmentList li span i {
            margin-right: 0.5rem; color: var(--text-secondary-light); font-size: 0.9em;
        }
        html.dark #appointmentList li span i { color: var(--text-secondary-dark); }
        #appointmentList li .text-gray-500 { color: var(--text-secondary-light); } /* Deprecated, use CSS var */
        html.dark #appointmentList li .text-gray-500 { color: var(--text-secondary-dark); } /* Deprecated, use CSS var */
        #appointmentList li .catatan-pasien { /* New class for notes */
            color: var(--text-secondary-light);
            font-size: 0.875em;
            margin-top: 0.25rem;
        }
        html.dark #appointmentList li .catatan-pasien { color: var(--text-secondary-dark); }


        #appointmentList li .action-buttons {
            display: flex; flex-direction: column;
            align-items: stretch; gap: 0.5rem;
            width: 100%; flex-basis: 100%; margin-top: 1rem;
        }
        @media (min-width: 768px) { /* md breakpoint */
            #appointmentList li .action-buttons {
                flex-direction: column; align-items: flex-end;
                width: auto; flex-basis: auto;
                margin-top: 0; margin-left: 1rem; min-width: 130px; /* Slightly wider for two buttons */
            }
        }
        #appointmentList li .action-buttons button {
            width: 100%; padding: 0.5rem 0.75rem;
            font-size: 0.875rem; justify-content: center;
            border-radius: 0.375rem;
            transition: background-color 0.2s ease, transform 0.1s ease;
        }
        #appointmentList li .action-buttons button.btn-selesai {
            background-color: var(--success-color-light); color: white;
        }
        html.dark #appointmentList li .action-buttons button.btn-selesai { background-color: var(--success-color-dark); }
        #appointmentList li .action-buttons button.btn-selesai:hover {
            background-color: color-mix(in srgb, var(--success-color-light) 85%, black);
            transform: translateY(-1px);
        }
        html.dark #appointmentList li .action-buttons button.btn-selesai:hover {
            background-color: color-mix(in srgb, var(--success-color-dark) 85%, black);
        }
        /* Style for Ubah Dokter button */
        #appointmentList li .action-buttons button.btn-edit-doctor {
            background-color: var(--info-color-light);
            color: white;
        }
        html.dark #appointmentList li .action-buttons button.btn-edit-doctor {
            background-color: var(--info-color-dark);
        }
        #appointmentList li .action-buttons button.btn-edit-doctor:hover {
            background-color: color-mix(in srgb, var(--info-color-light) 85%, black);
            transform: translateY(-1px);
        }
        html.dark #appointmentList li .action-buttons button.btn-edit-doctor:hover {
            background-color: color-mix(in srgb, var(--info-color-dark) 85%, black);
        }


        #appointmentList li .status-completed {
            color: var(--success-color-light); font-weight: 600; font-style: italic;
            flex-shrink: 0; margin-top: 0.5rem; align-self: center;
            font-size: 0.9em;
        }
        html.dark #appointmentList li .status-completed { color: var(--success-color-dark); }
        @media (min-width: 768px) {
            #appointmentList li .status-completed { align-self: flex-end; margin-top: 0; }
        }

        #scheduleInfo { color: var(--text-secondary-light); }
        html.dark #scheduleInfo { color: var(--text-secondary-dark); }
        #scheduleInfo strong { color: var(--text-primary-light); font-weight: 600; }
        html.dark #scheduleInfo strong { color: var(--text-primary-dark); }

        #countdownTimer {
            font-size: 1.125rem; /* Adjusted size */
            font-weight: 600; /* Semi-bold */
            color: var(--accent-color-light);
            margin-top: 1rem; text-align: center;
            padding: 0.75rem;
            background-color: var(--bg-muted-light);
            border-radius: 0.5rem;
        }
        html.dark #countdownTimer {
            color: var(--accent-color-dark);
            background-color: var(--bg-muted-dark);
        }
        #countdownTimer i { margin-right: 0.5rem; }

        #customTimerSection h3, #prayerTimesSection h3 { /* Combined for consistency */
            color: var(--text-primary-light); font-weight: 700; /* Bolder title */ margin-bottom: 1rem;
            font-size: 1.125rem;
        }
        html.dark #customTimerSection h3, html.dark #prayerTimesSection h3 { color: var(--text-primary-dark); }

        #customTimerControls {
            display: flex; gap: 0.75rem; align-items: center; flex-wrap: wrap;
        }
        #customTimerControls input[type="time"], #customTimerControls input[type="text"] {
            padding: 0.6rem 0.75rem; border-radius: 0.375rem;
            border: 1px solid var(--border-color-light);
            background-color: var(--bg-secondary-light);
            color: var(--text-primary-light);
            font-size: 0.9rem;
        }
        html.dark #customTimerControls input[type="time"], html.dark #customTimerControls input[type="text"] {
            border: 1px solid var(--border-color-dark);
            background-color: var(--bg-secondary-dark);
            color: var(--text-primary-dark);
        }
        #customTimerControls input[type="time"] { width: auto; text-align: center; }
        #customTimerControls input[type="text"] { flex-grow: 1; min-width: 150px; }
        #customTimerControls button { /* Styled as a general button */
            background-color: var(--warning-color-light); color: white;
            font-weight: 500; padding: 0.6rem 1rem; border-radius: 0.375rem;
            transition: background-color 0.2s ease, transform 0.1s ease;
            flex-shrink: 0; font-size: 0.9rem;
        }
        html.dark #customTimerControls button { background-color: var(--warning-color-dark); }
        #customTimerControls button:hover {
            background-color: color-mix(in srgb, var(--warning-color-light) 85%, black);
            transform: translateY(-1px);
        }
        html.dark #customTimerControls button:hover {
             background-color: color-mix(in srgb, var(--warning-color-dark) 85%, black);
        }

        #customTimerDisplay {
            font-size: 1.25rem; font-weight: 700;
            color: var(--warning-color-light);
            margin-top: 1rem; text-align: center;
            padding: 0.75rem; background-color: var(--bg-muted-light); border-radius: 0.5rem;
        }
        html.dark #customTimerDisplay {
            color: var(--warning-color-dark);
            background-color: var(--bg-muted-dark);
        }
        #customTimerDisplay i { margin-right: 0.5rem; }
        #customTimerDisplay .timer-description {
            font-size: 0.875rem; font-weight: 500;
            color: var(--text-secondary-light); display: block; margin-top: 0.25rem;
        }
        html.dark #customTimerDisplay .timer-description { color: var(--text-secondary-dark); }

        #prayerTimesList { list-style: none; padding: 0; margin: 0; }
        #prayerTimesList li {
            padding: 0.75rem 0; border-bottom: 1px solid var(--border-color-light);
            color: var(--text-secondary-light); display: flex;
            justify-content: space-between; align-items: center; flex-wrap: wrap;
        }
        html.dark #prayerTimesList li {
            border-bottom: 1px solid var(--border-color-dark);
            color: var(--text-secondary-dark);
        }
        #prayerTimesList li:last-child { border-bottom: none; }
        #prayerTimesList li span { flex-grow: 1; margin-right: 1rem; min-width: 70px; font-size: 0.9rem; }
        #prayerTimesList li strong {
            color: var(--accent-color-light); font-weight: 600; flex-shrink: 0; font-size: 0.9rem;
        }
        html.dark #prayerTimesList li strong { color: var(--accent-color-dark); }
        #prayerTimesList li button { /* Styled as a general button */
            background-color: var(--accent-color-light); color: white;
            font-weight: 500; padding: 0.4rem 0.8rem; border-radius: 0.375rem;
            transition: background-color 0.2s ease, transform 0.1s ease;
            font-size: 0.8rem; margin-left: 0.75rem; flex-shrink: 0; margin-top: 0.25rem;
        }
        html.dark #prayerTimesList li button { background-color: var(--accent-color-dark); }
        #prayerTimesList li button:hover {
            background-color: var(--accent-color-darker-light); transform: translateY(-1px);
        }
        html.dark #prayerTimesList li button:hover { background-color: var(--accent-color-darker-dark); }

        #prayerTimesList .loading-prayer-times, #prayerTimesList .error-prayer-times {
            text-align: center; color: var(--text-muted-light); font-style: italic; padding: 1rem 0;
        }
        html.dark #prayerTimesList .loading-prayer-times, html.dark #prayerTimesList .error-prayer-times {
            color: var(--text-muted-dark);
        }
        #prayerTimesList .error-prayer-times { color: var(--danger-color-light); }
        html.dark #prayerTimesList .error-prayer-times { color: var(--danger-color-dark); }


        #errorState { color: var(--danger-color-light); }
        html.dark #errorState { color: var(--danger-color-dark); }
        #errorState i { color: var(--danger-color-light); }
        html.dark #errorState i { color: var(--danger-color-dark); }
        #errorState button { /* Styled as a general button */
            background-color: var(--accent-color-light); color: white;
            font-weight: 500; padding: 0.75rem 1.5rem; border-radius: 0.5rem;
            transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        html.dark #errorState button { background-color: var(--accent-color-dark); }
        #errorState button:hover {
            background-color: var(--accent-color-darker-light); transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.07);
        }
         html.dark #errorState button:hover { background-color: var(--accent-color-darker-dark); }


        footer {
            background-color: var(--bg-muted-light); color: var(--text-muted-light);
            padding: 1.5rem 0; text-align: center; font-size: 0.875rem;
            border-top: 1px solid var(--border-color-light);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
         html.dark footer {
            background-color: var(--bg-muted-dark); color: var(--text-muted-dark);
            border-top: 1px solid var(--border-color-dark);
        }

        /* General Button Styles */
        .btn {
            padding: 0.6rem 1.2rem;
            border-radius: 0.375rem;
            font-weight: 500;
            transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            text-decoration: none;
            border: none;
            box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05);
        }
        .btn:hover { transform: translateY(-1px); box-shadow: 0 2px 4px 0 rgba(0,0,0,0.07); }
        .btn-primary {
            background-color: var(--accent-color-light); color: white;
        }
        html.dark .btn-primary { background-color: var(--accent-color-dark); }
        .btn-primary:hover { background-color: var(--accent-color-darker-light); }
        html.dark .btn-primary:hover { background-color: var(--accent-color-darker-dark); }

        .btn-danger {
            background-color: var(--danger-color-light); color: white;
        }
        html.dark .btn-danger { background-color: var(--danger-color-dark); }
        .btn-danger:hover { background-color: color-mix(in srgb, var(--danger-color-light) 85%, black); }
        html.dark .btn-danger:hover { background-color: color-mix(in srgb, var(--danger-color-dark) 85%, black); }

        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--border-color-light);
            color: var(--text-secondary-light);
        }
        html.dark .btn-outline {
            border: 1px solid var(--border-color-dark);
            color: var(--text-secondary-dark);
        }
        .btn-outline:hover {
            background-color: var(--bg-muted-light);
            border-color: var(--accent-color-light);
            color: var(--accent-color-light);
        }
        html.dark .btn-outline:hover {
            background-color: var(--bg-muted-dark);
            border-color: var(--accent-color-dark);
            color: var(--accent-color-dark);
        }
         .btn-sm { /* For smaller buttons like Set Alarm */
            padding: 0.4rem 0.8rem;
            font-size: 0.8rem;
        }

        /* Filter button styling */
        #filterToday, #filterAll {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            border-radius: 0.375rem;
            transition: background-color 0.2s ease, color 0.2s ease, box-shadow 0.2s ease;
            border: 1px solid transparent;
        }
        /* Default state for filter buttons */
        #filterToday, #filterAll {
            background-color: var(--bg-muted-light);
            color: var(--text-secondary-light);
            border-color: var(--border-color-light);
        }
        html.dark #filterToday, html.dark #filterAll {
            background-color: var(--bg-muted-dark);
            color: var(--text-secondary-dark);
            border-color: var(--border-color-dark);
        }
        /* Hover state for filter buttons */
        #filterToday:hover, #filterAll:hover {
            background-color: color-mix(in srgb, var(--bg-muted-light) 90%, black);
            border-color: var(--accent-color-light);
            color: var(--accent-color-light);
        }
        html.dark #filterToday:hover, html.dark #filterAll:hover {
            background-color: color-mix(in srgb, var(--bg-muted-dark) 90%, white);
            border-color: var(--accent-color-dark);
            color: var(--accent-color-dark);
        }
        /* Active state for filter buttons */
        #filterToday.active-filter, #filterAll.active-filter {
            background-color: var(--accent-color-light);
            color: white;
            border-color: var(--accent-color-light);
            box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1), 0 1px 2px 0 rgba(0,0,0,0.06);
        }
        html.dark #filterToday.active-filter, html.dark #filterAll.active-filter {
            background-color: var(--accent-color-dark);
            color: var(--text-primary-dark); /* Or white depending on accent contrast */
            border-color: var(--accent-color-dark);
        }


        /* SweetAlert2 Customization */
        .swal2-popup {
            font-family: var(--font-primary) !important;
            border-radius: 0.75rem !important; /* Softer radius */
            background-color: var(--bg-secondary-light) !important;
            color: var(--text-primary-light) !important;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1) !important;
        }
        html.dark .swal2-popup {
            background-color: var(--bg-secondary-dark) !important;
            color: var(--text-primary-dark) !important;
        }
        .swal2-title {
            color: var(--text-primary-light) !important;
            font-weight: 600 !important;
        }
        html.dark .swal2-title { color: var(--text-primary-dark) !important; }
        .swal2-html-container {
            color: var(--text-secondary-light) !important;
            font-size: 0.95rem !important;
        }
        html.dark .swal2-html-container { color: var(--text-secondary-dark) !important; }
        .swal2-confirm, .swal2-cancel, .swal2-deny {
            border-radius: 0.375rem !important;
            padding: 0.6em 1.5em !important;
            font-weight: 500 !important;
            transition: background-color 0.2s ease, transform 0.1s ease !important;
        }
        .swal2-confirm { background-color: var(--accent-color-light) !important; }
        html.dark .swal2-confirm { background-color: var(--accent-color-dark) !important; }
        .swal2-confirm:hover { transform: translateY(-1px); }
        .swal2-cancel { background-color: var(--text-muted-light) !important; color: var(--bg-secondary-light) !important; }
        html.dark .swal2-cancel { background-color: var(--text-muted-dark) !important; color: var(--bg-secondary-dark) !important; }
        .swal2-cancel:hover { transform: translateY(-1px); }
        .swal2-icon.swal2-success .swal2-success-line-tip,
        .swal2-icon.swal2-success .swal2-success-line-long {
            background-color: var(--success-color-light) !important;
        }
        html.dark .swal2-icon.swal2-success .swal2-success-line-tip,
        html.dark .swal2-icon.swal2-success .swal2-success-line-long {
            background-color: var(--success-color-dark) !important;
        }
        .swal2-icon.swal2-error [class^=swal2-x-mark-line] {
            background-color: var(--danger-color-light) !important;
        }
        html.dark .swal2-icon.swal2-error [class^=swal2-x-mark-line] {
            background-color: var(--danger-color-dark) !important;
        }
        .swal2-icon.swal2-warning {
            border-color: var(--warning-color-light) !important;
            color: var(--warning-color-light) !important;
        }
         html.dark .swal2-icon.swal2-warning {
            border-color: var(--warning-color-dark) !important;
            color: var(--warning-color-dark) !important;
        }
        .swal2-icon.swal2-info {
             border-color: var(--accent-color-light) !important;
            color: var(--accent-color-light) !important;
        }
        html.dark .swal2-icon.swal2-info {
             border-color: var(--accent-color-dark) !important;
            color: var(--accent-color-dark) !important;
        }

    </style>
</head>
<body class="flex flex-col bg-[var(--bg-primary-light)] dark:bg-[var(--bg-primary-dark)]">

    <nav>
        <div class="container flex justify-between items-center">
            <div class="flex items-center">
                <button id="sidebarToggleBtn" aria-label="Toggle Sidebar">
                    <i class="fas fa-bars"></i>
                </button>
                <a href="#" class="text-xl font-bold flex items-center">
                    <i class="fas fa-stethoscope mr-2 text-2xl text-[var(--accent-color-light)] dark:text-[var(--accent-color-dark)]"></i>
                    <span class="hidden sm:inline">KonsulSehat Dokter</span>
                    <span class="inline sm:hidden">Dokter</span>
                </a>
            </div>
            <div class="flex items-center space-x-3 sm:space-x-4">
                <span id="doctorName" class="text-sm text-[var(--text-secondary-light)] dark:text-[var(--text-secondary-dark)]">Memuat...</span>
                <button onclick="logoutUser()" class="btn btn-danger text-xs sm:text-sm py-1.5 px-3 sm:px-4">
                    <i class="fas fa-sign-out-alt mr-1 sm:mr-1.5"></i> Logout
                </button>
            </div>
        </div>
    </nav>

    <div id="sidebarOverlay"></div>

    <div class="content-area">
        <aside id="mainSidebar">
            <div class="mb-8">
                <h3>Menu Utama</h3>
                <div class="flex flex-col space-y-1">
                    <button class="nav-button active" data-target="schedulePrayerSection"><i class="fas fa-calendar-check"></i> Jadwal & Pengingat</button>
                    <button class="nav-button nav-button-queue" data-target="todayQueueSection"><i class="fas fa-users"></i> Antrian Pasien</button>
                </div>
            </div>
            </aside>

        <main id="mainContent" class="flex-1">
            <h1 class="text-2xl sm:text-3xl font-bold mb-6 sm:mb-8 text-[var(--text-primary-light)] dark:text-[var(--text-primary-dark)]">Selamat Datang, <span id="greetingName">Dokter</span>!</h1>

            <div id="loadingState" class="flex flex-col items-center justify-center py-16 sm:py-20 content-section active">
                <div class="loading-spinner"></div>
                <p class="mt-4 text-base sm:text-lg text-[var(--text-muted-light)] dark:text-[var(--text-muted-dark)]">Memuat data dashboard...</p>
            </div>

            <div id="doctorContent" class="content-section">
                <div id="schedulePrayerSection" class="content-view active space-y-6">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Jadwal Praktik Anda</h2>
                            <button id="editScheduleBtn" class="btn btn-primary btn-sm text-xs px-3 py-1.5">Ubah Jadwal</button>
                        </div>
                        <p id="scheduleInfo" class="text-base">Memuat jadwal...</p>
                        <div id="countdownTimer" class="hidden mt-3">
                            <i class="fas fa-clock"></i> <span id="countdownText"></span>
                        </div>
                    </div>

                    <div class="card" id="customTimerSection">
                         <h3 class="card-title mb-4">Atur Pengingat Kustom</h3>
                        <div id="customTimerControls" class="space-y-3 sm:space-y-0 sm:flex sm:space-x-3">
                            <input type="time" id="targetTimeInput" class="w-full sm:w-auto">
                            <input type="text" id="timerDescription" placeholder="Keterangan pengingat (cth: Istirahat)" class="w-full sm:flex-1">
                            <button id="startTimerBtn" class="btn btn-primary w-full sm:w-auto">Set Pengingat</button>
                        </div>
                        <div id="customTimerDisplay" class="hidden mt-4">
                            <i class="fas fa-stopwatch"></i> <span id="timerCountdownText"></span>
                            <span id="timerDescriptionDisplay" class="timer-description"></span>
                        </div>
                    </div>

                    <div class="card" id="prayerTimesSection">
                        <h3 class="card-title mb-4">Waktu Sholat Hari Ini</h3>
                        <ul id="prayerTimesList">
                            <li class="loading-prayer-times">Memuat waktu sholat...</li>
                        </ul>
                    </div>
                </div>

                <div id="todayQueueSection" class="content-view space-y-6">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Antrian Pasien</h2>
                            <div class="flex space-x-2">
                                <button id="filterToday" class="active-filter">Hari Ini</button>
                                <button id="filterAll">Semua</button>
                            </div>
                        </div>
                        <div id="appointmentListContainer">
                            <ul id="appointmentList" class="space-y-3">
                                <li>Memuat antrian...</li>
                            </ul>
                        </div>
                        <p id="noAppointmentsMsg" class="text-[var(--text-muted-light)] dark:text-[var(--text-muted-dark)] italic hidden mt-6 text-center">Tidak ada antrian pasien untuk filter ini.</p>
                    </div>
                </div>
            </div>

            <div id="errorState" class="content-section text-center py-16 sm:py-20">
                <i class="fas fa-exclamation-triangle text-5xl sm:text-6xl mb-5 text-[var(--danger-color-light)] dark:text-[var(--danger-color-dark)]"></i>
                <p id="errorMessage" class="text-lg sm:text-xl mb-6">Terjadi kesalahan saat memuat halaman.</p>
                <button onclick="logoutUser()" class="btn btn-primary">
                    Kembali ke Halaman Login
                </button>
            </div>
        </main>
    </div>

    <footer class="mt-auto">
        <p>&copy; <span id="currentYear"></span> KonsulSehat. All rights reserved.</p>
    </footer>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        // Firebase instances (will be initialized after config fetch)
        let firebaseApp;
        let firebaseAuth;
        let firebaseDb;
        let allAppointments = [];
        let currentFilter = 'today';
        let doctorSchedule = null;
        let scheduleCountdownInterval = null;
        let customTimerInterval = null;
        let customTimerEndTime = null;
        let customTimerDescription = '';

        // --- DOM References ---
        const loadingState = document.getElementById('loadingState');
        const doctorContent = document.getElementById('doctorContent');
        const errorState = document.getElementById('errorState');
        const errorMessageElement = document.getElementById('errorMessage');
        const doctorNameSpan = document.getElementById('doctorName');
        const greetingNameSpan = document.getElementById('greetingName');
        const currentYearSpan = document.getElementById('currentYear');

        const schedulePrayerSection = document.getElementById('schedulePrayerSection');
        const scheduleInfoP = document.getElementById('scheduleInfo');
        const countdownTimerDiv = document.getElementById('countdownTimer');
        const countdownTextSpan = document.getElementById('countdownText');
        const customTimerSection = document.getElementById('customTimerSection');
        const targetTimeInput = document.getElementById('targetTimeInput');
        const timerDescriptionInput = document.getElementById('timerDescription');
        const startTimerBtn = document.getElementById('startTimerBtn');
        const customTimerDisplay = document.getElementById('customTimerDisplay');
        const timerCountdownTextSpan = document.getElementById('timerCountdownText');
        const timerDescriptionDisplaySpan = document.getElementById('timerDescriptionDisplay');
        const prayerTimesSection = document.getElementById('prayerTimesSection');
        const prayerTimesListUl = document.getElementById('prayerTimesList');
        const editScheduleBtn = document.getElementById('editScheduleBtn');

        const todayQueueSection = document.getElementById('todayQueueSection');
        const appointmentListUl = document.getElementById('appointmentList');
        const noAppointmentsMsgP = document.getElementById('noAppointmentsMsg');
        const filterTodayButton = document.getElementById('filterToday');
        const filterAllButton = document.getElementById('filterAll');

        const mainSidebar = document.getElementById('mainSidebar');
        const sidebarToggleBtn = document.getElementById('sidebarToggleBtn');
        const sidebarOverlay = document.getElementById('sidebarOverlay');
        const navButtons = document.querySelectorAll('.nav-button');
        const mainContent = document.getElementById('mainContent');


        // --- Utility Functions ---
        function showNotificationError(message) {
            console.error("Error:", message);
            Swal.fire({ title: 'Error', text: message, icon: 'error', confirmButtonColor: getComputedStyle(document.documentElement).getPropertyValue('--accent-color-light').trim() });
        }
        function showNotificationSuccess(message) {
            console.log("Success:", message);
            Swal.fire({ title: 'Berhasil!', text: message, icon: 'success', confirmButtonColor: getComputedStyle(document.documentElement).getPropertyValue('--accent-color-light').trim() });
        }

        function displayState(state, message = '') {
            loadingState.classList.add('hidden');
            doctorContent.classList.add('hidden');
            errorState.classList.add('hidden');
            document.querySelectorAll('.content-section').forEach(section => section.classList.remove('active'));

            if (state === 'loading') {
                loadingState.classList.remove('hidden');
                loadingState.classList.add('active');
            } else if (state === 'content') {
                doctorContent.classList.remove('hidden');
                doctorContent.classList.add('active');
            } else if (state === 'error') {
                errorState.classList.remove('hidden');
                errorState.classList.add('active');
                if (errorMessageElement) {
                    errorMessageElement.textContent = message || 'Terjadi kesalahan yang tidak diketahui.';
                }
            }
        }

        function showContentView(viewId) {
            document.querySelectorAll('.content-view').forEach(view => {
                view.classList.remove('active');
                view.style.display = 'none';
            });
            const activeView = document.getElementById(viewId);
            if (activeView) {
                activeView.classList.add('active');
                activeView.style.display = 'block';
                if (viewId === 'todayQueueSection') {
                    displayAppointments(currentFilter);
                }
            }
            navButtons.forEach(button => {
                button.classList.toggle('active', button.getAttribute('data-target') === viewId);
            });
        }

        function formatDate(date) {
            const year = date.getFullYear();
            const month = ('0' + (date.getMonth() + 1)).slice(-2);
            const day = ('0' + date.getDate()).slice(-2);
            return `${year}-${month}-${day}`;
        }
        function formatTime(date) {
            const hours = ('0' + date.getHours()).slice(-2);
            const minutes = ('0' + date.getMinutes()).slice(-2);
            return `${hours}:${minutes}`;
        }
        function formatTimeDifference(startDate, endDate) {
            let diff = (endDate.getTime() - startDate.getTime()) / 1000;
            if (diff < 0) return "Waktu telah berlalu.";
            const days = Math.floor(diff / (24 * 3600)); diff -= days * 24 * 3600;
            const hours = Math.floor(diff / 3600); diff -= hours * 3600;
            const minutes = Math.floor(diff / 60); diff -= minutes * 60;
            const seconds = Math.floor(diff);
            let parts = [];
            if (days > 0) parts.push(`${days} hari`);
            if (hours > 0) parts.push(`${hours} jam`);
            if (minutes > 0) parts.push(`${minutes} menit`);
            if (seconds >= 0 || parts.length === 0) parts.push(`${seconds} detik`); // Show seconds if less than a minute or exactly 0
            return parts.join(' ');
        }
        function getDayNumber(dayName) {
            const dayMap = { 'Minggu': 0, 'Senin': 1, 'Selasa': 2, 'Rabu': 3, 'Kamis': 4, 'Jumat': 5, 'Sabtu': 6 };
            return dayMap[dayName.trim()]; // Ensure to trim whitespace from dayName
        }

        // --- Firebase Initialization and Config Fetch ---
        async function fetchFirebaseConfig() {
            try {
                console.log("Mengambil konfigurasi Firebase...");
                const response = await fetch('/api/firebase-config');
                if (!response.ok) {
                    let errorDetail = `Status ${response.status}`;
                    try { const errJson = await response.json(); errorDetail = errJson.message || errJson.data?.message || errorDetail; } catch(e) {}
                    throw new Error(`Network response error: ${errorDetail}`);
                }
                const config = await response.json();
                if (!config || !config.apiKey) {
                    throw new Error("Konfigurasi Firebase tidak lengkap/valid dari API.");
                }
                console.log("Konfigurasi Firebase berhasil diambil.");
                return config;
            } catch (error) {
                console.error("Error fetching Firebase config:", error);
                displayState('error', `Gagal memuat konfigurasi: ${error.message}.`);
                return null;
            }
        }

        function initializeFirebase(config) {
            if (!config) {
                displayState('error', 'Gagal inisialisasi: Konfigurasi Firebase tidak valid.');
                return false;
            }
            try {
                if (typeof firebase === 'undefined' || !firebase.initializeApp) {
                    throw new Error("Firebase SDK (compat) belum dimuat.");
                }
                if (!firebase.apps.length) {
                    firebaseApp = firebase.initializeApp(config);
                    console.log("Firebase App diinisialisasi.");
                } else {
                    firebaseApp = firebase.app();
                    console.log("Menggunakan instance Firebase App yang sudah ada.");
                }
                firebaseAuth = firebase.auth();
                firebaseDb = firebase.database();
                console.log("Firebase Auth dan Database instance didapatkan.");
                return true;
            } catch (error) {
                console.error("Gagal inisialisasi Firebase:", error);
                displayState('error', `Gagal inisialisasi Firebase: ${error.message}`);
                return false;
            }
        }

        window.logoutUser = function() {
            console.log("Fungsi logoutUser dipanggil.");
            if (firebaseAuth && firebaseAuth.currentUser) {
                firebaseAuth.signOut().then(() => {
                    console.log("Logout berhasil.");
                    window.location.href = 'login.html';
                }).catch((error) => {
                    console.error("Error logout:", error);
                    showNotificationError('Gagal logout: ' + error.message);
                });
            } else {
                console.log("Tidak ada pengguna login/Firebase Auth belum siap. Redirecting...");
                window.location.href = 'login.html';
            }
        }

        // --- Data Loading and Display Functions ---
        async function loadDoctorData(doctorUid) {
            if (!firebaseDb) {
                displayState('error', 'Koneksi database belum siap.');
                return;
            }
            console.log(`Memuat data untuk dokter UID: ${doctorUid}`);
            try {
                const doctorProfileRef = firebaseDb.ref(`daftar_dokter/${doctorUid}`);
                const profileSnapshot = await doctorProfileRef.once('value');
                let doctorName = 'Dokter';
                doctorSchedule = null;

                if (profileSnapshot.exists()) {
                    const profileData = profileSnapshot.val();
                    console.log("Data profil dokter:", profileData);
                    doctorName = profileData.nama || 'Dokter';
                    doctorSchedule = profileData; // Store the entire schedule data, including hari_praktik, jam_mulai, jam_selesai
                    if (doctorNameSpan) doctorNameSpan.textContent = `Login sebagai ${doctorName}`;
                    if (greetingNameSpan) greetingNameSpan.textContent = doctorName;
                    if (scheduleInfoP) {
                        scheduleInfoP.innerHTML = `Jadwal: <strong>${profileData.hari_praktik || 'Belum diatur'}</strong>, Pukul: <strong>${profileData.jam_mulai || '--:--'} - ${profileData.jam_selesai || '--:--'}</strong>`;
                    }
                    startScheduleCountdown(); // Call this after doctorSchedule is set
                } else {
                    console.warn(`Profil dokter UID ${doctorUid} tidak ditemukan.`);
                    if (doctorNameSpan) doctorNameSpan.textContent = 'Dokter (Profil Tidak Ditemukan)';
                    if (greetingNameSpan) greetingNameSpan.textContent = 'Dokter';
                    if (scheduleInfoP) scheduleInfoP.innerHTML = "Jadwal tidak ditemukan.";
                    if (countdownTimerDiv) countdownTimerDiv.classList.add('hidden');
                }

                const appointmentsRef = firebaseDb.ref('reservasi');
                // Listen for real-time updates on appointments
                appointmentsRef.orderByChild('dokter_id').equalTo(doctorUid).on('value', (appointmentsSnapshot) => {
                    allAppointments = [];
                    if (appointmentsSnapshot.exists()) {
                        console.log("Data antrian pasien diperbarui (real-time).");
                        appointmentsSnapshot.forEach(snap => {
                            allAppointments.push({ id: snap.key, ...snap.val() });
                        });
                        console.log(`Total ${allAppointments.length} reservasi dimuat/diperbarui.`);
                    } else {
                        console.log("Tidak ada antrian pasien untuk dokter ini (real-time).");
                    }
                    // Re-display appointments whenever data changes, if the queue view is active
                    if(document.getElementById('todayQueueSection').classList.contains('active')) {
                        displayAppointments(currentFilter);
                    }
                }, (error) => {
                    console.error("Error listening to appointment updates:", error);
                    showNotificationError("Gagal memuat update antrian secara real-time.");
                });


                displayState('content');
                showContentView('schedulePrayerSection'); // Default view
                loadPrayerTimes();
            } catch (error) {
                console.error("Error memuat data dokter/antrian awal:", error);
                displayState('error', `Gagal memuat data: ${error.message}.`);
            }
        }

        function displayAppointments(filter) {
            if (!appointmentListUl || !noAppointmentsMsgP) return;
            currentFilter = filter;
            appointmentListUl.innerHTML = '<li><div class="loading-spinner mx-auto my-4"></div><p class="text-center text-[var(--text-muted-light)] dark:text-[var(--text-muted-dark)]">Memuat antrian...</p></li>';

            const today = formatDate(new Date());
            let filteredAppointments = [];

            if (filter === 'today') {
                // Filter for appointments scheduled for TODAY and status_pasien is 'checkin' AND not 'Selesai' (overall status)
                filteredAppointments = allAppointments.filter(appt =>
                    appt.tanggal === today &&
                    appt.status_pasien && appt.status_pasien.toLowerCase() === 'checkin' &&
                    appt.status !== 'Selesai'
                );
                 console.log(`Menampilkan ${filteredAppointments.length} antrian 'checkin' untuk Hari Ini.`);
            } else { // 'all'
                filteredAppointments = [...allAppointments]; // Create a shallow copy for sorting
                console.log(`Menampilkan semua (${filteredAppointments.length}) antrian.`);
            }
            
            // Sort logic:
            // For 'today' (checkin queue): sort by waktu_checkin (ascending), then by waktu (appointment time ascending)
            // For 'all': sort by status (not Selesai first), then by date & time (descending - most recent first)
            filteredAppointments.sort((a, b) => {
                if (filter === 'today') {
                    const timeA = a.waktu_checkin || a.waktu || "00:00";
                    const timeB = b.waktu_checkin || b.waktu || "00:00";
                    return timeA.localeCompare(timeB);
                } else { // 'all' filter
                    if (a.status !== 'Selesai' && b.status === 'Selesai') return -1;
                    if (a.status === 'Selesai' && b.status !== 'Selesai') return 1;
                    
                    const dateTimeA = new Date(`${a.tanggal}T${a.waktu || '00:00'}`);
                    const dateTimeB = new Date(`${b.tanggal}T${b.waktu || '00:00'}`);
                    return dateTimeB - dateTimeA; // Most recent first
                }
            });
            
            appointmentListUl.innerHTML = ''; // Clear loading

            if (filteredAppointments.length > 0) {
                filteredAppointments.forEach(appointment => {
                    const li = document.createElement('li');
                    const checkinTimeDisplay = appointment.waktu_checkin ? `<span><i class="fas fa-sign-in-alt mr-2 text-green-500"></i> Check-in: <strong>${appointment.waktu_checkin}</strong></span>` : '';
                    
                    li.innerHTML = `
                        <div class='appointment-details'>
                            <strong>${appointment.nama || 'Pasien Tanpa Nama'}</strong>
                            <span><i class="fas fa-phone-alt"></i> ${appointment.telepon || '-'}</span>
                            <span><i class="fas fa-calendar-alt"></i> ${appointment.tanggal} ${appointment.waktu || ''}</span>
                            ${checkinTimeDisplay}
                            <span><i class="fas fa-hospital"></i> RS: ${appointment.rumah_sakit || '-'}</span>
                            <div class='catatan-pasien mt-1'>Catatan: ${appointment.diagnosis || 'Tidak ada catatan'}</div>
                        </div>
                        <div class="action-buttons">
                            ${appointment.status !== 'Selesai' ? `<button onclick="editAppointmentDoctor('${appointment.id}')" class="btn btn-edit-doctor btn-sm text-xs"><i class="fas fa-user-edit mr-1"></i>Ubah Dokter</button>` : ''}
                            ${appointment.status === 'Selesai'
                                ? `<span class="status-completed"><i class="fas fa-check-circle mr-1"></i>Selesai</span>`
                                : `<button onclick="markAppointmentComplete('${appointment.id}')" class="btn btn-selesai"><i class="fas fa-check mr-1.5"></i>Selesai</button>`
                            }
                        </div>
                    `;
                    appointmentListUl.appendChild(li);
                });
                noAppointmentsMsgP.classList.add('hidden');
            } else {
                noAppointmentsMsgP.innerHTML = filter === 'today' ? "Tidak ada pasien yang check-in hari ini." : "Tidak ada data antrian.";
                noAppointmentsMsgP.classList.remove('hidden');
            }

            if (filterTodayButton && filterAllButton) {
                filterTodayButton.classList.toggle('active-filter', filter === 'today');
                filterAllButton.classList.toggle('active-filter', filter === 'all');
            }
        }
        
        window.editAppointmentDoctor = async (reservationId) => {
            // This is a placeholder. Full implementation would require fetching doctor lists,
            // updating Firebase, and potentially more complex logic.
            Swal.fire({
                title: 'Ubah Dokter',
                text: 'Fitur untuk mengubah dokter yang menangani pasien ini sedang dalam pengembangan. Untuk saat ini, silakan hubungi administrator.',
                icon: 'info',
                confirmButtonText: 'OK',
                confirmButtonColor: getComputedStyle(document.documentElement).getPropertyValue('--accent-color-light').trim()
            });
            console.log(`Placeholder: Request to edit doctor for reservation ID: ${reservationId}`);
            // Example of what might be needed:
            // 1. Fetch list of available doctors from Firebase: firebaseDb.ref('daftar_dokter').once('value')
            // 2. Create a select input for Swal.fire:
            //    const { value: newDoctorId } = await Swal.fire({ ..., input: 'select', inputOptions: doctorOptions })
            // 3. If newDoctorId is selected, update the reservation:
            //    await firebaseDb.ref(`reservasi/${reservationId}`).update({ dokter_id: newDoctorId, nama_dokter: newDoctorName });
            // 4. Refresh appointment list or update local data.
        };


        window.markAppointmentComplete = async (reservationId) => {
            if (!firebaseDb) {
                showNotificationError('Koneksi database belum siap.'); return;
            }
            console.log(`Menandai reservasi ${reservationId} sebagai Selesai.`);
            const confirmResult = await Swal.fire({
                title: 'Tandai Selesai?',
                text: "Anda yakin ingin menandai reservasi ini sebagai selesai?",
                icon: 'question', showCancelButton: true,
                confirmButtonText: 'Ya, Selesai!', cancelButtonText: 'Batal',
                confirmButtonColor: getComputedStyle(document.documentElement).getPropertyValue('--success-color-light').trim(),
                cancelButtonColor: getComputedStyle(document.documentElement).getPropertyValue('--text-muted-light').trim(),
            });
            if (!confirmResult.isConfirmed) return;

            try {
                await firebaseDb.ref(`reservasi/${reservationId}`).update({
                    status: 'Selesai',
                    status_pasien: 'selesai_konsultasi', // Optionally update patient status too
                    completed_at: new Date().toISOString()
                });
                console.log(`Reservasi ${reservationId} berhasil ditandai Selesai.`);
                showNotificationSuccess('Reservasi berhasil ditandai selesai.');
                // Data will be re-rendered by the real-time listener on `loadDoctorData`
                // No need to manually update `allAppointments` and call `displayAppointments` here if using .on()
            } catch (error) {
                console.error(`Gagal menandai reservasi ${reservationId} Selesai:`, error);
                showNotificationError(`Gagal menandai selesai: ${error.message}`);
            }
        }

        // --- Schedule & Timer Functions ---
        function startScheduleCountdown() {
            if (!doctorSchedule || !doctorSchedule.hari_praktik || !doctorSchedule.jam_mulai || !countdownTimerDiv || !countdownTextSpan) {
                console.warn("Data jadwal tidak lengkap atau elemen DOM tidak ditemukan untuk countdown jadwal.");
                if (countdownTimerDiv) countdownTimerDiv.classList.add('hidden');
                if (scheduleInfoP && (!doctorSchedule || !doctorSchedule.hari_praktik)) { // If hari_praktik is missing
                     scheduleInfoP.innerHTML = `Jadwal: <strong>Belum diatur</strong>`;
                }
                return;
            }
            if (scheduleCountdownInterval) clearInterval(scheduleCountdownInterval);
            countdownTimerDiv.classList.remove('hidden');

            const updateScheduleTimer = () => {
                const now = new Date();
                const daysOfWeek = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
                
                // Handle potentially undefined or empty hari_praktik
                const practiceDaysString = doctorSchedule.hari_praktik || "";
                const practiceDayNumbers = practiceDaysString.split(',')
                    .map(day => getDayNumber(day.trim())) // Trim whitespace before getting day number
                    .filter(dayNum => dayNum !== undefined && dayNum !== null); // Filter out invalid day numbers

                if (practiceDayNumbers.length === 0) {
                    countdownTextSpan.textContent = "Hari praktik tidak valid atau belum diatur.";
                    if (scheduleCountdownInterval) clearInterval(scheduleCountdownInterval);
                    return;
                }

                const jamMulaiString = doctorSchedule.jam_mulai || "00:00"; // Default if missing
                const [startHour, startMinute] = jamMulaiString.split(':').map(Number);

                if (isNaN(startHour) || isNaN(startMinute)) {
                    countdownTextSpan.textContent = "Jam mulai praktik tidak valid.";
                    if (scheduleCountdownInterval) clearInterval(scheduleCountdownInterval);
                    return;
                }

                let nextPracticeTime = null;

                for (let i = 0; i < 7; i++) { // Check for the next 7 days
                    const nextDate = new Date(now);
                    nextDate.setDate(now.getDate() + i);
                    if (practiceDayNumbers.includes(nextDate.getDay())) {
                        const potentialPracticeTime = new Date(nextDate);
                        potentialPracticeTime.setHours(startHour, startMinute, 0, 0);
                        if (potentialPracticeTime > now) {
                            nextPracticeTime = potentialPracticeTime;
                            break;
                        }
                    }
                }
                if (nextPracticeTime) {
                    const timeRemaining = formatTimeDifference(now, nextPracticeTime);
                    countdownTextSpan.innerHTML = `Praktik berikutnya: <strong>${daysOfWeek[nextPracticeTime.getDay()]}, ${formatTime(nextPracticeTime)}</strong> (dalam ${timeRemaining})`;
                } else {
                    // If no upcoming practice in the next 7 days, try finding one further out (e.g., next week's first practice day)
                    let foundFurther = false;
                    for (let i = 7; i < 14; i++) { // Check the week after
                         const nextDate = new Date(now);
                         nextDate.setDate(now.getDate() + i);
                         if (practiceDayNumbers.includes(nextDate.getDay())) {
                            const potentialPracticeTime = new Date(nextDate);
                            potentialPracticeTime.setHours(startHour, startMinute, 0, 0);
                            nextPracticeTime = potentialPracticeTime;
                            foundFurther = true;
                            break;
                         }
                    }
                    if(foundFurther && nextPracticeTime){
                        const timeRemaining = formatTimeDifference(now, nextPracticeTime);
                        countdownTextSpan.innerHTML = `Praktik berikutnya: <strong>${daysOfWeek[nextPracticeTime.getDay()]}, ${formatTime(nextPracticeTime)}</strong> (dalam ${timeRemaining})`;
                    } else {
                        countdownTextSpan.textContent = "Tidak ada jadwal praktik mendatang yang terdeteksi.";
                        if (scheduleCountdownInterval) clearInterval(scheduleCountdownInterval);
                    }
                }
            };
            updateScheduleTimer();
            scheduleCountdownInterval = setInterval(updateScheduleTimer, 1000);
        }

        function startCustomTimer(prefillTime = null, prefillDescription = null) {
            if (prefillTime) targetTimeInput.value = prefillTime;
            if (prefillDescription) timerDescriptionInput.value = prefillDescription;

            const targetTimeString = targetTimeInput.value;
            const description = timerDescriptionInput.value.trim();
            if (!targetTimeString) { Swal.fire('Input Tidak Valid', 'Masukkan waktu target.', 'warning'); return; }
            if (!description) { Swal.fire('Keterangan Kosong', 'Masukkan keterangan pengingat.', 'warning'); return; }

            const now = new Date();
            const [targetHour, targetMinute] = targetTimeString.split(':').map(Number);
            let targetDateTime = new Date(now);
            targetDateTime.setHours(targetHour, targetMinute, 0, 0);
            if (targetDateTime <= now) targetDateTime.setDate(targetDateTime.getDate() + 1);

            customTimerEndTime = targetDateTime;
            customTimerDescription = description;
            console.log(`Timer kustom: ${targetTimeString} (${customTimerDescription}). Berakhir: ${customTimerEndTime}`);
            customTimerDisplay.classList.remove('hidden');
            timerDescriptionDisplaySpan.textContent = `(${customTimerDescription})`;
            if (customTimerInterval) clearInterval(customTimerInterval);

            const updateCustomTimer = () => {
                const now = new Date();
                const timeRemaining = formatTimeDifference(now, customTimerEndTime);
                if (customTimerEndTime > now) {
                    timerCountdownTextSpan.textContent = timeRemaining;
                } else {
                    timerCountdownTextSpan.textContent = "Waktu habis!";
                    clearInterval(customTimerInterval); customTimerInterval = null; customTimerEndTime = null;
                    Swal.fire({ title: 'Pengingat Selesai!', text: `Waktu untuk "${customTimerDescription}" telah tiba.`, icon: 'info' });
                    console.log(`Pengingat "${customTimerDescription}" selesai!`);
                    customTimerDescription = '';
                    setTimeout(() => {
                        customTimerDisplay.classList.add('hidden');
                        targetTimeInput.value = ''; timerDescriptionInput.value = '';
                        timerDescriptionDisplaySpan.textContent = '';
                    }, 5000);
                }
            };
            updateCustomTimer();
            customTimerInterval = setInterval(updateCustomTimer, 1000);
        }

        async function loadPrayerTimes() {
            if (!prayerTimesListUl) return;
            prayerTimesListUl.innerHTML = '<li class="loading-prayer-times">Memuat waktu sholat...</li>';
            const latitude = -7.7956; const longitude = 110.3695; // Yogyakarta
            const method = 11; // Kemenag
            const date = formatDate(new Date());
            const apiUrl = `https://api.aladhan.com/v1/timings/${date}?latitude=${latitude}&longitude=${longitude}&method=${method}`;

            try {
                console.log(`Mengambil waktu sholat dari: ${apiUrl}`);
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    let errorDetail = `Status ${response.status}`;
                    try { const errJson = await response.json(); errorDetail = errJson.data?.message || errorDetail; } catch(e) {}
                    throw new Error(`Network error: ${errorDetail}`);
                }
                const data = await response.json();
                if (data.status !== 'OK' || !data.data || !data.data.timings) {
                    throw new Error(`API response error: ${data.status} - ${data.data?.message || 'Unknown error'}`);
                }
                const timings = data.data.timings;
                console.log("Waktu sholat:", timings);
                prayerTimesListUl.innerHTML = '';
                const prayerNames = { Fajr: 'Subuh', Sunrise: 'Terbit', Dhuhr: 'Dzuhur', Asr: 'Ashar', Sunset: 'Maghrib', Isha: 'Isya', Imsak: 'Imsak' };
                ['Imsak', 'Fajr', 'Sunrise', 'Dhuhr', 'Asr', 'Sunset', 'Isha'].forEach(key => {
                    if (timings[key] && prayerNames[key]) {
                        const li = document.createElement('li');
                        const prayerTime = timings[key];
                        const prayerName = prayerNames[key];
                        li.innerHTML = `
                            <span>${prayerName}</span>
                            <strong>${prayerTime}</strong>
                            <button onclick="startCustomTimer('${prayerTime}', 'Pengingat Sholat ${prayerName}')" class="btn btn-sm btn-outline"><i class="fas fa-bell mr-1"></i>Set Alarm</button>
                        `;
                        prayerTimesListUl.appendChild(li);
                    }
                });
            } catch (error) {
                console.error("Gagal memuat waktu sholat:", error);
                prayerTimesListUl.innerHTML = `<li class="error-prayer-times">Gagal memuat waktu sholat: ${error.message}</li>`;
                showNotificationError(`Waktu sholat: ${error.message}`);
            }
        }

        // --- Main Initialization Logic ---
        async function main() {
            console.log("DOM Siap. Memulai inisialisasi dashboard...");
            if (currentYearSpan) currentYearSpan.textContent = new Date().getFullYear();
            displayState('loading');
            const firebaseConfig = await fetchFirebaseConfig();
            if (firebaseConfig && initializeFirebase(firebaseConfig)) {
                console.log("Firebase OK. Cek autentikasi...");
                firebaseAuth.onAuthStateChanged(async (user) => {
                    if (user) {
                        console.log("Pengguna terautentikasi:", user.email, "UID:", user.uid);
                        try {
                            const idTokenResult = await user.getIdTokenResult(true);
                            console.log("Custom Claims:", idTokenResult.claims);
                            if (idTokenResult.claims.doctor === true) {
                                console.log("Pengguna terverifikasi sebagai dokter.");
                                await loadDoctorData(user.uid); // This will now set up real-time listener for appointments
                            } else {
                                console.warn("Akses ditolak: Pengguna", user.uid, "bukan dokter.");
                                displayState('error', "Anda tidak memiliki hak akses dokter. Mengarahkan ke login...");
                                setTimeout(logoutUser, 3000);
                            }
                        } catch (error) {
                            console.error("Error cek custom claims:", error);
                            displayState('error', `Gagal verifikasi status dokter: ${error.message}. Coba login lagi.`);
                            setTimeout(logoutUser, 3000);
                        }
                    } else {
                        console.log("Tidak ada pengguna login. Mengarahkan ke login...");
                        window.location.href = 'login.html';
                    }
                });
            } else {
                console.error("Inisialisasi Firebase gagal. Halaman tidak dapat dimuat.");
            }
        }

        // --- Event Listeners ---
        navButtons.forEach(button => {
            button.addEventListener('click', () => {
                const targetId = button.getAttribute('data-target');
                if (targetId) {
                    showContentView(targetId);
                    if (window.innerWidth < 768 && mainSidebar.classList.contains('open-mobile')) {
                        mainSidebar.classList.remove('open-mobile');
                        sidebarOverlay.classList.remove('active');
                        document.body.classList.remove('overflow-hidden-custom');
                    }
                }
            });
        });

        if (sidebarToggleBtn && mainSidebar && mainContent && sidebarOverlay) {
            sidebarToggleBtn.addEventListener('click', () => {
                const isMobile = window.innerWidth < 768;
                if (isMobile) {
                    mainSidebar.classList.toggle('open-mobile');
                    sidebarOverlay.classList.toggle('active');
                    document.body.classList.toggle('overflow-hidden-custom');
                } else {
                    mainSidebar.classList.toggle('collapsed');
                    mainContent.classList.toggle('sidebar-collapsed');
                }
                console.log("Sidebar toggled. Collapsed:", mainSidebar.classList.contains('collapsed'), "Mobile Open:", mainSidebar.classList.contains('open-mobile'));
            });
            sidebarOverlay.addEventListener('click', () => {
                if (window.innerWidth < 768) {
                    mainSidebar.classList.remove('open-mobile');
                    sidebarOverlay.classList.remove('active');
                    document.body.classList.remove('overflow-hidden-custom');
                }
            });
        }

        if (filterTodayButton) filterTodayButton.addEventListener('click', () => displayAppointments('today'));
        if (filterAllButton) filterAllButton.addEventListener('click', () => displayAppointments('all'));
        if (editScheduleBtn) {
            editScheduleBtn.addEventListener('click', () => {
                Swal.fire({ title: 'Ubah Jadwal Praktik', html: 'Untuk mengubah jadwal praktik, silakan hubungi administrator sistem.', icon: 'info' });
            });
        }
        if (startTimerBtn) startTimerBtn.addEventListener('click', () => startCustomTimer());

        document.addEventListener('DOMContentLoaded', main);
        window.addEventListener('beforeunload', () => {
            if (scheduleCountdownInterval) clearInterval(scheduleCountdownInterval);
            if (customTimerInterval) clearInterval(customTimerInterval);
            // Detach Firebase listeners if any were attached with .on() and not .once()
            if (firebaseDb) {
                const user = firebaseAuth.currentUser;
                if (user) {
                     firebaseDb.ref('reservasi').orderByChild('dokter_id').equalTo(user.uid).off();
                     console.log("Firebase listener for appointments detached.");
                }
            }
        });
        window.addEventListener('resize', () => {
            const isMobile = window.innerWidth < 768;
            if (!isMobile) {
                mainSidebar.classList.remove('open-mobile');
                sidebarOverlay.classList.remove('active');
                document.body.classList.remove('overflow-hidden-custom');
                mainContent.classList.toggle('sidebar-collapsed', mainSidebar.classList.contains('collapsed'));
            } else {
                 mainContent.classList.remove('sidebar-collapsed'); // Ensure no margin on mobile
            }
        });
    </script>
</body>
</html>