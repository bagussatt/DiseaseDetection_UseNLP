<!DOCTYPE html>
<html lang="id" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Kelola Dokter | KonsulSehat</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --font-primary: 'Inter', 'Poppins', sans-serif;
            --bg-primary: #f4f7f6;
            --bg-secondary: #ffffff;
            --bg-muted: #e9ecef;
            --text-primary: #212529;
            --text-secondary: #495057;
            --text-muted: #6c757d;
            --border-color: #dee2e6;
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.04);
            --card-shadow-hover: 0 10px 15px -3px rgba(0, 0, 0, 0.07), 0 4px 6px -4px rgba(0, 0, 0, 0.05);
            --navbar-bg: #2c3e50;
            --navbar-text: #ecf0f1;
            --active-filter-bg: #3498db;
            --active-filter-text: #ffffff;
            --accent-color: #3498db;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --info-color: #3498db;
            --sidebar-width: 16rem;
        }
        html.dark {
            --bg-primary: #1a202c;
            --bg-secondary: #2d3748;
            --bg-muted: #4a5568;
            --text-primary: #e2e8f0;
            --text-secondary: #a0aec0;
            --text-muted: #718096;
            --border-color: #4a5568;
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            --card-shadow-hover: 0 10px 15px -3px rgba(0, 0, 0, 0.15), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
            --navbar-bg: #171923;
            --navbar-text: #cbd5e0;
            --active-filter-bg: #2b6cb0;
            --active-filter-text: #ffffff;
            --accent-color: #4299e1;
        }

        body { font-family: var(--font-primary); background-color: var(--bg-primary); color: var(--text-primary); transition: background-color 0.3s ease, color 0.3s ease; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        nav { background: var(--navbar-bg); color: var(--navbar-text); }
        main h1, main h2, main h3, aside h3 { color: var(--text-primary); font-weight: 600; }
        main p, main span, main label, main td, main th, aside p, aside span, aside label { color: var(--text-secondary); }
        main p i, main span i, aside p i, aside span i { color: var(--text-muted); }
        main pre { background-color: var(--bg-muted); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 0.375rem; padding: 0.5rem; font-size: 0.875rem;}
        main input, main select, main textarea, aside input, .modal input { background-color: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 0.375rem; padding: 0.5rem 0.75rem; }
        main input::placeholder, aside input::placeholder, .modal input::placeholder { color: var(--text-muted); }
        main .border-b, main .border-t, aside .border-t, .modal .border-b, .modal .border-t { border-color: var(--border-color); }

        #filterSidebar h3 { font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.75rem; color: var(--text-muted); font-weight: 600; }
        .filter-btn { border-width: 1px; transition: background-color 0.15s ease-in-out, border-color 0.15s ease-in-out, color 0.15s ease-in-out, transform 0.1s ease; text-align: left; width: 100%; padding: 0.6rem 0.85rem; font-size: 0.875rem; font-weight: 500; border-radius: 0.5rem; display: flex; align-items: center; }
        .filter-btn i { margin-right: 0.6rem; width: 16px; text-align: center; color: var(--text-muted); }
        .filter-btn.active i { color: var(--active-filter-text); }
        .filter-btn:not(.active) { background-color: transparent; border-color: var(--border-color); color: var(--text-secondary); }
        .filter-btn:not(.active):hover { background-color: var(--bg-muted); border-color: var(--border-color); color: var(--text-primary); transform: translateX(2px); }
        .filter-btn.active { background-color: var(--active-filter-bg); color: var(--active-filter-text); border-color: var(--active-filter-bg); box-shadow: 0 2px 4px rgba(52, 152, 219, 0.2); }
        html.dark .filter-btn:not(.active) { border-color: var(--border-color); }
        html.dark .filter-btn:not(.active):hover { background-color: var(--bg-muted); color: var(--text-primary); }

        .action-btn { font-size: 0.8rem; font-weight: 600; padding: 0.4rem 0.9rem; border-radius: 0.375rem; transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease; display: inline-flex; align-items: center; justify-content: center; text-transform: uppercase; letter-spacing: 0.5px; border: none; }
        .action-btn i { margin-right: 0.4rem; font-size: 0.8em; }
        .action-btn:hover { transform: translateY(-1px); box-shadow: 0 2px 5px rgba(0,0,0,0.15); }
        .btn-simpan { background-color: var(--info-color); color: white; } .btn-simpan:hover { background-color: #2980b9; }
        .btn-tambah { background-color: var(--success-color); color: white; } .btn-tambah:hover { background-color: #27ae60; }
        .btn-edit { background-color: var(--info-color); color: white; } .btn-edit:hover { background-color: #2980b9; }
        .btn-hapus { background-color: var(--danger-color); color: white; } .btn-hapus:hover { background-color: #c0392b; }

        html.dark .btn-simpan { background-color: #2b6cb0; } html.dark .btn-simpan:hover { background-color: #2c5282; }
        html.dark .btn-tambah { background-color: #2f855a; } html.dark .btn-tambah:hover { background-color: #276749; }
        html.dark .btn-edit { background-color: #2b6cb0; } html.dark .btn-edit:hover { background-color: #2c5282; }
        html.dark .btn-hapus { background-color: #c53030; } html.dark .btn-hapus:hover { background-color: #9b2c2c; }

        .btn-kelola-dokter {
            background-color: var(--success-color);
            color: white;
            border-color: var(--success-color);
        }
        .btn-kelola-dokter:hover {
            background-color: #27ae60;
            border-color: #27ae60;
        }
        html.dark .btn-kelola-dokter {
            background-color: #38a169;
            border-color: #38a169;
        }
        html.dark .btn-kelola-dokter:hover {
            background-color: #2f855a;
            border-color: #2f855a;
        }

        #doctorListTable { width: 100%; border-collapse: collapse; margin-top: 1.5rem; }
        #doctorListTable th, #doctorListTable td { padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--border-color); font-size: 0.875rem; }
        #doctorListTable th { font-weight: 600; color: var(--text-primary); background-color: var(--bg-muted); }
        #doctorListTable td { color: var(--text-secondary); }
        #doctorListTable tr:last-child td { border-bottom: none; }
        #doctorListTable .action-buttons button { padding: 0.25rem 0.5rem; font-size: 0.75rem; margin-left: 0.5rem; }
        html.dark #doctorListTable th { background-color: var(--bg-muted); }
        html.dark #doctorListTable td { color: var(--text-secondary); }

        #doctorCrudForm { background-color: var(--bg-secondary); padding: 1.5rem; border-radius: 0.75rem; box-shadow: var(--card-shadow); }
        #doctorCrudForm label { font-size: 0.8rem; font-weight: 500; margin-bottom: 0.25rem; color: var(--text-secondary); display: block; }
        #doctorCrudForm input[type="text"],
        #doctorCrudForm input[type="time"],
        #doctorCrudForm select {
             background-color: var(--bg-primary);
             border: 1px solid var(--border-color);
             color: var(--text-primary);
             border-radius: 0.375rem;
             padding: 0.5rem 0.75rem;
             width: 100%;
             box-sizing: border-box;
             margin-top: 0.25rem;
             transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }
         #doctorCrudForm input[type="text"]:focus,
         #doctorCrudForm input[type="time"]:focus,
         #doctorCrudForm select:focus {
             outline: none;
             border-color: var(--accent-color);
             box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
         }
         html.dark #doctorCrudForm input[type="text"],
         html.dark #doctorCrudForm input[type="time"],
         html.dark #doctorCrudForm select {
             background-color: var(--bg-muted);
             border-color: var(--border-color);
             color: var(--text-primary);
         }
         html.dark #doctorCrudForm input[type="text"]:focus,
         html.dark #doctorCrudForm input[type="time"]:focus,
         html.dark #doctorCrudForm select:focus {
             border-color: var(--accent-color);
             box-shadow: 0 0 0 0.2rem rgba(66, 153, 225, 0.25);
         }

        #doctorListContainer {
            background-color: var(--bg-secondary);
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: var(--card-shadow);
        }

        .content-section {
            display: none;
        }
        .content-section.active {
            display: block;
        }


        @keyframes spin { to { transform: rotate(360deg); } }
        .animate-spin-slow { animation: spin 1.5s linear infinite; }
        button:disabled { opacity: 0.6; cursor: not-allowed; }
        button:disabled:hover { background-color: initial !important; transform: none; box-shadow: none; }
        body.overflow-hidden-custom { overflow: hidden; }

        #filterSidebar { background-color: var(--bg-secondary); border-right: 1px solid var(--border-color); box-shadow: 2px 0 15px -3px rgba(0,0,0,0.05); width: var(--sidebar-width); transition: width 0.3s ease-in-out, transform 0.3s ease-in-out, padding 0.3s ease-in-out, border 0.3s ease-in-out; }
        #filterSidebar.collapsed { width: 0; padding-left: 0; padding-right: 0; overflow: hidden; border-right: none; transform: translateX(-100%); }
        main { transition: margin-left 0.3s ease-in-out; }
        main.sidebar-open { margin-left: var(--sidebar-width); }
        main.sidebar-collapsed { margin-left: 0; }
        @media (max-width: 767px) { #filterSidebar { transform: translateX(-100%); width: var(--sidebar-width); } #filterSidebar.open-mobile { transform: translateX(0); } #filterSidebar.collapsed { transform: translateX(-100%); } main.sidebar-open, main.sidebar-collapsed { margin-left: 0; } }
        html.dark #filterSidebar { box-shadow: 2px 0 15px -3px rgba(0,0,0,0.2); }


    </style>
</head>
<body class="min-h-screen">

    <nav class="fixed top-0 left-0 right-0 z-50 shadow-lg h-16 flex items-center">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center">
            <button id="sidebarToggleBtn" class="p-2 rounded-md hover:bg-white hover:bg-opacity-20 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-white mr-3" aria-label="Toggle Sidebar">
                <i class="fas fa-bars text-xl text-white"></i>
            </button>
            <a class="text-xl font-bold flex items-center tracking-tight mr-auto" href="homepage_admin.html"> <i class="fas fa-stethoscope mr-2 text-2xl" style="color: var(--accent-color);"></i>
                <span>Admin KonsulSehat</span>
            </a>
            <div class="flex items-center space-x-3 sm:space-x-4">
                <button id="theme-toggle" type="button" class="text-gray-300 hover:text-white focus:outline-none text-xl p-1.5 rounded-lg hover:bg-opacity-20 hover:bg-white transition-colors duration-200">
                    <i class="fas fa-moon" id="theme-toggle-dark-icon"></i>
                    <i class="fas fa-sun hidden" id="theme-toggle-light-icon"></i>
                </button>
                <button onclick="logoutUser()" class="bg-red-500 hover:bg-red-600 text-white text-xs sm:text-sm font-medium py-2 px-3 sm:px-4 rounded-md transition duration-200 flex items-center shadow-md hover:shadow-lg">
                    <i class="fas fa-sign-out-alt mr-1.5 text-xs"></i> Logout
                </button>
            </div>
        </div>
    </nav>

    <div id="sidebarOverlay" class="fixed inset-0 bg-black bg-opacity-60 z-30 hidden md:hidden"></div>

    <div class="flex pt-16">
        <aside id="filterSidebar"
               class="fixed inset-y-0 left-0 z-40 transition-transform duration-300 ease-in-out
                      md:relative md:translate-x-0 md:sticky md:top-16
                      h-screen md:h-[calc(100vh-4rem)] overflow-y-auto
                      p-5 flex flex-col">
            <div class="mb-6">
                <h3 class="text-xs font-semibold mb-3 tracking-wider uppercase" style="color: var(--text-muted);">Navigasi</h3>
                <div class="flex flex-col space-y-1.5">
                     <a href="homepage_admin.html" class="filter-btn"><i class="fas fa-hourglass-half"></i>Antrian Reservasi</a>
                    <button data-target="doctorFormSection" class="filter-btn doctor-nav-btn active"><i class="fas fa-plus-circle"></i> Tambah Dokter</button>
                    <button data-target="doctorListSection" class="filter-btn doctor-nav-btn"><i class="fas fa-list-alt"></i> Daftar Dokter</button>
                    </div>
            </div>

            <div class="mt-auto pt-6 border-t flex flex-col space-y-2" style="border-color: var(--border-color);">
                 <h3 class="text-xs font-semibold mb-3 tracking-wider uppercase" style="color: var(--text-muted);">Pengaturan</h3>
                 <a href="homepage_admin.html" class="filter-btn !bg-indigo-500 !text-white !border-indigo-500 hover:!bg-indigo-600">
                     <i class="fas fa-hospital-user"></i> Kelola Rumah Sakit
                 </a>
            </div>
        </aside>

        <main id="mainContent" class="flex-1 p-4 sm:p-6 md:p-8 overflow-y-auto h-[calc(100vh-4rem)] transition-all duration-300 ease-in-out md:ml-[var(--sidebar-width)]">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-6 pb-4 border-b" style="border-color: var(--border-color);">
                <h1 class="text-2xl sm:text-3xl font-semibold mb-4 sm:mb-0">Kelola Data Dokter</h1>
            </div>

            <div id="doctorFormSection" class="content-section active">
                <div id="doctorCrudFormContainer" class="bg-secondary p-6 rounded-lg shadow-md">
                     <h2 id="doctorFormTitle" class="text-xl font-semibold mb-4" style="color: var(--text-primary);">Tambah Dokter Baru</h2>
                     <form id="doctorCrudForm" class="space-y-4">
                         <input type="hidden" id="doctorId">
                         <div>
                             <label for="doctorNameInput">Nama Dokter <span class="text-red-500">*</span></label>
                             <input type="text" id="doctorNameInput" placeholder="Masukkan nama dokter" required>
                         </div>
                         <div>
                             <label for="doctorSpecializationInput">Spesialisasi (Poli) <span class="text-red-500">*</span></label>
                             <input type="text" id="doctorSpecializationInput" placeholder="Contoh: Umum, Gigi, Anak" required>
                         </div>
                         <div>
                             <label for="doctorHospitalSelect">Rumah Sakit <span class="text-red-500">*</span></label>
                             <select id="doctorHospitalSelect" required>
                                 <option value="">-- Pilih Rumah Sakit --</option>
                                 </select>
                         </div>
                         <div>
                             <label for="doctorPracticeDaysInput">Hari Praktik <span class="text-red-500">*</span></label>
                             <input type="text" id="doctorPracticeDaysInput" placeholder="Contoh: Senin-Jumat, Sabtu" required>
                             <p class="text-xs mt-1" style="color: var(--text-muted);">Masukkan format hari praktik (misal: Senin-Jumat, Sabtu).</p>
                         </div>
                         <div class="flex flex-col sm:flex-row gap-4">
                             <div class="flex-1">
                                 <label for="doctorStartTimeInput">Jam Mulai <span class="text-red-500">*</span></label>
                                 <input type="time" id="doctorStartTimeInput" required>
                             </div>
                             <div class="flex-1">
                                 <label for="doctorEndTimeInput">Jam Selesai <span class="text-red-500">*</span></label>
                                 <input type="time" id="doctorEndTimeInput" required>
                             </div>
                         </div>
                         <div class="flex justify-end pt-4 space-x-3 border-t mt-5" style="border-color: var(--border-color);">
                             <button type="button" id="cancelDoctorEditBtn" class="action-btn px-4 py-2 hidden">
                                 Batal Edit
                             </button>
                             <button type="submit" id="doctorSubmitBtn" class="action-btn btn-tambah px-4 py-2 flex items-center justify-center">
                                 <i class="fas fa-plus mr-2"></i> Tambah Dokter
                             </button>
                         </div>
                     </form>
                </div>
            </div>

            <div id="doctorListSection" class="content-section">
                <div id="doctorListContainer" class="bg-secondary p-6 rounded-lg shadow-md">
                     <h2 class="text-xl font-semibold mb-4" style="color: var(--text-primary);">Daftar Dokter</h2>
                     <div class="table-container">
                         <table id="doctorListTable">
                             <thead>
                                 <tr>
                                     <th>Nama Dokter</th>
                                     <th>Spesialisasi</th>
                                     <th>Rumah Sakit</th>
                                     <th>Hari Praktik</th>
                                     <th>Jam Mulai</th>
                                     <th>Jam Selesai</th>
                                     <th class="text-right">Aksi</th>
                                 </tr>
                             </thead>
                             <tbody id="doctorListTableBody">
                                 <tr><td colspan="6" class="text-center py-4 italic" style="color: var(--text-muted);">Memuat data dokter...</td></tr>
                             </tbody>
                         </table>
                     </div>
                     <p id="noDoctorData" class="text-center py-4 italic hidden" style="color: var(--text-muted);">Belum ada data dokter.</p>
                </div>
            </div>


    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        let firebaseApp;
        let firebaseAuth;
        let firebaseDb;

        const themeToggleButton = document.getElementById('theme-toggle');
        const themeToggleDarkIcon = document.getElementById('theme-toggle-dark-icon');
        const themeToggleLightIcon = document.getElementById('theme-toggle-light-icon');
        const sidebarToggleBtn = document.getElementById('sidebarToggleBtn');
        const filterSidebar = document.getElementById('filterSidebar');
        const mainContent = document.getElementById('mainContent');
        const sidebarOverlay = document.getElementById('sidebarOverlay');

        const doctorNavButtons = document.querySelectorAll('.doctor-nav-btn');
        const doctorFormSection = document.getElementById('doctorFormSection');
        const doctorListSection = document.getElementById('doctorListSection');

        const doctorCrudForm = document.getElementById('doctorCrudForm');
        const doctorFormTitle = document.getElementById('doctorFormTitle');
        const doctorIdInput = document.getElementById('doctorId');
        const doctorNameInput = document.getElementById('doctorNameInput');
        const doctorSpecializationInput = document.getElementById('doctorSpecializationInput');
        const doctorHospitalSelect = document.getElementById('doctorHospitalSelect');
        const doctorPracticeDaysInput = document.getElementById('doctorPracticeDaysInput');
        const doctorStartTimeInput = document.getElementById('doctorStartTimeInput');
        const doctorEndTimeInput = document.getElementById('doctorEndTimeInput');
        const doctorSubmitBtn = document.getElementById('doctorSubmitBtn');
        const cancelDoctorEditBtn = document.getElementById('cancelDoctorEditBtn');

        const doctorListTableBody = document.getElementById('doctorListTableBody');
        const noDoctorDataMsg = document.getElementById('noDoctorData');

        function showErrorMessage(message) {
             console.error("Error:", message);
             Swal.fire('Error', message, 'error');
        }

        function escapeHtml(unsafe) {
            if (unsafe === null || typeof unsafe === 'undefined') return "";
            return unsafe.toString()
                   .replace(/&/g, "&amp;")
                   .replace(/</g, "&lt;")
                   .replace(/>/g, "&gt;")
                   .replace(/"/g, "&quot;")
                   .replace(/'/g, "&#039;");
        }

        async function fetchFirebaseConfig() {
            try {
                const response = await fetch('/api/firebase-config');
                if (!response.ok) throw new Error(`Network response was not ok: ${response.status} ${response.statusText}`);
                console.log("Konfigurasi Firebase berhasil diambil dari API.");
                return await response.json();
            } catch (error) {
                console.error("Error fetching Firebase config:", error);
                showErrorMessage(`Gagal memuat konfigurasi Firebase: ${error.message}. Pastikan API backend berjalan.`);
                return null;
            }
        }

        function initializeFirebase(config) {
            if (!config) {
                console.error("Konfigurasi Firebase tidak valid.");
                return false;
            }
            try {
                if (typeof firebase === 'undefined' || typeof firebase.initializeApp === 'undefined') {
                    throw new Error("Firebase SDK belum dimuat.");
                }
                if (!firebase.apps.length) {
                    firebaseApp = firebase.initializeApp(config);
                    console.log("Firebase App diinisialisasi.");
                } else {
                    firebaseApp = firebase.app();
                    console.log("Menggunakan instance Firebase App yang sudah ada.");
                }
                firebaseAuth = firebase.auth();
                firebaseDb = firebase.database();
                console.log("Firebase Auth dan Database instance didapatkan.");
                return true;
            } catch (error) {
                console.error("Gagal inisialisasi Firebase:", error);
                showErrorMessage(`Gagal inisialisasi Firebase: ${error.message}`);
                return false;
            }
        }

        window.logoutUser = function() {
            if (firebaseAuth && firebaseAuth.currentUser) {
                firebaseAuth.signOut().then(() => {
                    console.log("Logout berhasil.");
                    window.location.href = 'login.html';
                }).catch((error) => {
                    console.error("Error logout:", error);
                    Swal.fire('Error', 'Gagal logout: ' + error.message, 'error');
                });
            } else {
                console.log("Tidak ada pengguna yang login, redirect ke login.");
                window.location.href = 'login.html';
            }
        }

        function applyTheme(theme) {
            if (theme === 'dark') { document.documentElement.classList.add('dark'); themeToggleLightIcon.classList.remove('hidden'); themeToggleDarkIcon.classList.add('hidden'); }
            else { document.documentElement.classList.remove('dark'); themeToggleLightIcon.classList.add('hidden'); themeToggleDarkIcon.classList.remove('hidden'); }
        }

        function toggleTheme() {
            const currentTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            localStorage.setItem('theme', newTheme);
            applyTheme(newTheme);
            console.log(`Tema diubah ke: ${newTheme}`);
        }

        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme');
            const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (savedTheme) { applyTheme(savedTheme); }
            else if (systemPrefersDark) { applyTheme('dark'); }
            else { applyTheme('light'); }
        }

        async function populateHospitalSelect() {
            if (!firebaseDb) { console.error("Database belum siap untuk mengisi dropdown RS."); return; }
            if (!doctorHospitalSelect) { console.error("Elemen #doctorHospitalSelect tidak ditemukan."); return; }

            doctorHospitalSelect.innerHTML = '<option value="">-- Memuat Rumah Sakit --</option>';
            const hospitalRef = firebaseDb.ref('daftar_rumah_sakit');

            try {
                const snapshot = await hospitalRef.once('value');
                doctorHospitalSelect.innerHTML = '<option value="">-- Pilih Rumah Sakit --</option>';

                if (snapshot.exists()) {
                    snapshot.forEach((childSnapshot) => {
                        const hospitalId = childSnapshot.key;
                        const hospitalData = childSnapshot.val();
                        const option = document.createElement('option');
                        option.value = hospitalId;
                        option.textContent = hospitalData.nama || hospitalData.singkatan || 'Tidak diketahui';
                        doctorHospitalSelect.appendChild(option);
                    });
                } else {
                    const option = document.createElement('option');
                    option.value = "";
                    option.textContent = "-- Tidak ada Rumah Sakit tersedia --";
                    doctorHospitalSelect.appendChild(option);
                    doctorHospitalSelect.disabled = true;
                }
            } catch (error) {
                console.error("Gagal memuat daftar rumah sakit untuk dropdown:", error);
                doctorHospitalSelect.innerHTML = '<option value="">-- Gagal memuat RS --</option>';
                doctorHospitalSelect.disabled = true;
                Swal.fire('Error', 'Gagal memuat daftar rumah sakit untuk pilihan dokter.', 'error');
            }
        }

        async function loadAndDisplayDoctors() {
            if (!firebaseDb) { console.error("Database belum siap untuk memuat dokter."); doctorListTableBody.innerHTML = `<tr><td colspan="6" class="text-center py-4 italic" style="color: var(--text-muted);">Memuat data dokter...</td></tr>`; noDoctorDataMsg.classList.add('hidden'); return; }
            if (!doctorListTableBody || !noDoctorDataMsg) { console.error("Elemen tabel dokter atau pesan 'no data' tidak ditemukan."); return; }

            doctorListTableBody.innerHTML = `<tr><td colspan="6" class="text-center py-4 italic" style="color: var(--text-muted);">Memuat data dokter...</td></tr>`;
            noDoctorDataMsg.classList.add('hidden');

            const doctorsRef = firebaseDb.ref('daftar_dokter');

            try {
                const snapshot = await doctorsRef.once('value');
                doctorListTableBody.innerHTML = '';

                if (snapshot.exists()) {
                    let doctorsExist = false;
                    snapshot.forEach((childSnapshot) => {
                        doctorsExist = true;
                        const doctorId = childSnapshot.key;
                        const doctorData = childSnapshot.val();

                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${escapeHtml(doctorData.nama)}</td>
                            <td>${escapeHtml(doctorData.spesialisasi)}</td>
                            <td>${escapeHtml(doctorData.rumah_sakit_nama || 'Tidak diketahui')}</td>
                            <td>${escapeHtml(doctorData.hari_praktik || '-')}</td>
                            <td>${escapeHtml(doctorData.jam_mulai || '-')}</td>
                            <td>${escapeHtml(doctorData.jam_selesai || '-')}</td>
                            <td class="text-right action-buttons whitespace-nowrap">
                                <button onclick="editDoctor('${doctorId}', '${escapeHtml(doctorData.nama)}', '${escapeHtml(doctorData.spesialisasi)}', '${escapeHtml(doctorData.rumah_sakit_id)}', '${escapeHtml(doctorData.hari_praktik || '')}', '${escapeHtml(doctorData.jam_mulai || '')}', '${escapeHtml(doctorData.jam_selesai || '')}') " class="action-btn btn-edit" title="Edit">
                                    <i class="fas fa-pencil-alt !mr-0"></i>
                                </button>
                                <button onclick="confirmDeleteDoctor('${doctorId}', '${escapeHtml(doctorData.nama)}')" class="action-btn btn-hapus" title="Hapus">
                                    <i class="fas fa-trash-alt !mr-0"></i>
                                </button>
                            </td>
                        `;
                        doctorListTableBody.appendChild(tr);
                    });
                    noDoctorDataMsg.classList.toggle('hidden', !doctorsExist);
                } else {
                    noDoctorDataMsg.classList.remove('hidden');
                }
            } catch (error) {
                console.error("Gagal memuat daftar dokter:", error);
                doctorListTableBody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-red-500">Gagal memuat data. Coba lagi nanti.</td></tr>`;
                noDoctorDataMsg.classList.add('hidden');
                Swal.fire('Error', 'Gagal memuat daftar dokter.', 'error');
            }
        }

        window.editDoctor = (id, nama, spesialisasi, rumah_sakit_id, hari_praktik, jam_mulai, jam_selesai) => {
            console.log(`Menyiapkan edit untuk Dokter ID: ${id}`);
            doctorIdInput.value = id;
            doctorNameInput.value = nama;
            doctorSpecializationInput.value = spesialisasi;
            doctorHospitalSelect.value = rumah_sakit_id;
            doctorPracticeDaysInput.value = hari_praktik;
            doctorStartTimeInput.value = jam_mulai;
            doctorEndTimeInput.value = jam_selesai;

            doctorFormTitle.textContent = "Edit Data Dokter";
            doctorSubmitBtn.innerHTML = `<i class="fas fa-save mr-2"></i> Simpan Perubahan`;
            doctorSubmitBtn.classList.remove('btn-tambah');
            doctorSubmitBtn.classList.add('btn-simpan');
            cancelDoctorEditBtn.classList.remove('hidden');

            showSection('doctorFormSection');

            doctorCrudForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function resetDoctorForm() {
            console.log("Mereset form dokter ke mode tambah.");
            if (doctorCrudForm) doctorCrudForm.reset();
            if (doctorIdInput) doctorIdInput.value = '';
            if (doctorFormTitle) doctorFormTitle.textContent = "Tambah Dokter Baru";
            if (doctorSubmitBtn) {
                doctorSubmitBtn.innerHTML = `<i class="fas fa-plus mr-2"></i> Tambah Dokter`;
                doctorSubmitBtn.classList.remove('btn-simpan');
                doctorSubmitBtn.classList.add('btn-tambah');
            }
            if (cancelDoctorEditBtn) cancelDoctorEditBtn.classList.add('hidden');
             if (doctorHospitalSelect) doctorHospitalSelect.value = "";
             if (doctorPracticeDaysInput) doctorPracticeDaysInput.value = "";
             if (doctorStartTimeInput) doctorStartTimeInput.value = "";
             if (doctorEndTimeInput) doctorEndTimeInput.value = "";
        }

        async function handleDoctorFormSubmit(event) {
            event.preventDefault();
            const doctorId = doctorIdInput.value;
            const doctorName = doctorNameInput.value.trim();
            const doctorSpecialization = doctorSpecializationInput.value.trim();
            const doctorHospitalId = doctorHospitalSelect.value;
            const doctorHospitalName = doctorHospitalSelect.selectedIndex >= 0 && doctorHospitalSelect.options[doctorHospitalSelect.selectedIndex] ? doctorHospitalSelect.options[doctorHospitalSelect.selectedIndex].text : '';
            const doctorPracticeDays = doctorPracticeDaysInput.value.trim();
            const doctorStartTime = doctorStartTimeInput.value;
            const doctorEndTime = doctorEndTimeInput.value;

            if (!doctorName || !doctorSpecialization || !doctorHospitalId || !doctorPracticeDays || !doctorStartTime || !doctorEndTime) { Swal.fire('Input Tidak Lengkap', 'Harap isi semua kolom yang bertanda *.', 'warning'); return; }
            if (!firebaseDb) { Swal.fire('Error Koneksi', 'Koneksi database belum siap.', 'error'); return; }

            doctorSubmitBtn.disabled = true;
            doctorSubmitBtn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> Menyimpan...`;

            const doctorData = {
                nama: doctorName,
                spesialisasi: doctorSpecialization,
                rumah_sakit_id: doctorHospitalId,
                rumah_sakit_nama: doctorHospitalName,
                hari_praktik: doctorPracticeDays,
                jam_mulai: doctorStartTime,
                jam_selesai: doctorEndTime
            };

            try {
                let operationPromise;
                let successMessage;

                if (doctorId) {
                    operationPromise = firebaseDb.ref(`daftar_dokter/${doctorId}`).update(doctorData);
                    successMessage = `Data dokter "${doctorName}" berhasil diperbarui.`;
                } else {
                    operationPromise = firebaseDb.ref('daftar_dokter').push(doctorData);
                    successMessage = `Dokter "${doctorName}" berhasil ditambahkan.`;
                }

                await operationPromise;
                Swal.fire('Berhasil!', successMessage, 'success');
                resetDoctorForm();
                await loadAndDisplayDoctors();

            } catch (error) {
                console.error("Gagal menyimpan data dokter:", error);
                Swal.fire('Gagal!', `Terjadi kesalahan: ${error.message}`, 'error');
            } finally {
                doctorSubmitBtn.disabled = false;
                 if (doctorIdInput.value) {
                     doctorSubmitBtn.innerHTML = `<i class="fas fa-save mr-2"></i> Simpan Perubahan`;
                 } else {
                     doctorSubmitBtn.innerHTML = `<i class="fas fa-plus mr-2"></i> Tambah Dokter`;
                 }
            }
        }

        window.confirmDeleteDoctor = (id, name) => {
             if (!firebaseDb) { Swal.fire('Error Koneksi', 'Koneksi database belum siap.', 'error'); return; }
             Swal.fire({
                 title: 'Hapus Dokter?',
                 html: `Anda yakin ingin menghapus dokter <strong>${escapeHtml(name)}</strong>? Tindakan ini tidak dapat diurungkan.`,
                 icon: 'warning', showCancelButton: true,
                 confirmButtonColor: getComputedStyle(document.documentElement).getPropertyValue('--danger-color').trim(),
                 cancelButtonColor: getComputedStyle(document.documentElement).getPropertyValue('--text-muted').trim(),
                 confirmButtonText: 'Ya, Hapus!', cancelButtonText: 'Batal'
             }).then(async (result) => {
                 if (result.isConfirmed) {
                     console.log(`Menghapus Dokter ID: ${id}`);
                     try {
                         await firebaseDb.ref(`daftar_dokter/${id}`).remove();
                         Swal.fire('Dihapus!', `Dokter "${escapeHtml(name)}" telah dihapus.`, 'success');
                         await loadAndDisplayDoctors();
                         if (doctorIdInput.value === id) {
                             resetDoctorForm();
                         }
                     } catch (error) {
                          console.error(`Gagal menghapus Dokter ID ${id}:`, error);
                          Swal.fire('Gagal!', `Gagal menghapus dokter: ${error.message}`, 'error');
                     }
                 }
             });
        }

        function showSection(sectionId) {
            const sections = document.querySelectorAll('.content-section');
            sections.forEach(section => {
                section.classList.remove('active');
                section.style.display = 'none';
            });
            const activeSection = document.getElementById(sectionId);
            if (activeSection) {
                activeSection.classList.add('active');
                activeSection.style.display = 'block';
            }
        }

        function handleDoctorNavClick(event) {
            const targetSectionId = event.target.getAttribute('data-target');
            if (targetSectionId) {
                showSection(targetSectionId);

                doctorNavButtons.forEach(btn => btn.classList.remove('active'));
                event.target.classList.add('active');

                if (targetSectionId === 'doctorListSection') {
                    loadAndDisplayDoctors();
                } else if (targetSectionId === 'doctorFormSection') {
                    resetDoctorForm();
                }
            }
        }

        if (themeToggleButton) {
            themeToggleButton.addEventListener('click', toggleTheme);
        }

        if (sidebarToggleBtn && filterSidebar && mainContent) {
            sidebarToggleBtn.addEventListener('click', () => {
                const isMobile = window.innerWidth < 768;

                if (isMobile) {
                    filterSidebar.classList.toggle('open-mobile');
                    sidebarOverlay.classList.toggle('hidden');
                    document.body.classList.toggle('overflow-hidden-custom');
                } else {
                    filterSidebar.classList.toggle('collapsed');
                    mainContent.classList.toggle('md:ml-[var(--sidebar-width)]');
                    mainContent.classList.toggle('md:ml-0');
                }
                 console.log("Sidebar toggled. Collapsed:", filterSidebar.classList.contains('collapsed'), "Mobile Open:", filterSidebar.classList.contains('open-mobile'));
            });

            if (sidebarOverlay) {
                sidebarOverlay.addEventListener('click', () => {
                     if (window.innerWidth < 768) {
                         filterSidebar.classList.remove('open-mobile');
                         sidebarOverlay.classList.add('hidden');
                         document.body.classList.remove('overflow-hidden-custom');
                         console.log("Mobile sidebar closed via overlay click.");
                     }
                });
            }
        }

        if (doctorNavButtons.length > 0) {
            doctorNavButtons.forEach(button => {
                button.addEventListener('click', handleDoctorNavClick);
            });
        }

        if (doctorCrudForm) {
            doctorCrudForm.addEventListener('submit', handleDoctorFormSubmit);
        }

        if (cancelDoctorEditBtn) {
            cancelDoctorEditBtn.addEventListener('click', resetDoctorForm);
        }

        async function main() {
            initializeTheme();

            const firebaseConfig = await fetchFirebaseConfig();

            if (firebaseConfig && initializeFirebase(firebaseConfig)) {
                firebaseAuth.onAuthStateChanged(async (user) => {
                    if (user) {
                        try {
                            const idTokenResult = await user.getIdTokenResult(true);
                            if (idTokenResult.claims.admin === true) {
                                console.log("Admin terverifikasi.");
                                await populateHospitalSelect();

                                showSection('doctorFormSection');
                                loadAndDisplayDoctors();

                            } else {
                                console.warn("Akses ditolak: Pengguna bukan admin.");
                                showErrorMessage("Anda tidak memiliki hak akses sebagai admin untuk halaman ini.");
                                setTimeout(logoutUser, 4000);
                            }
                        } catch (error) {
                            console.error("Error saat memeriksa custom claims admin:", error);
                            showErrorMessage("Gagal melakukan verifikasi status admin. Silakan coba login kembali.");
                            setTimeout(logoutUser, 4000);
                        }
                    } else {
                        console.log("Tidak ada pengguna yang login. Mengarahkan ke halaman login.");
                        window.location.href = 'login.html';
                    }
                });
            }
        }

        document.addEventListener('DOMContentLoaded', main);

    </script>
</body>
</html>
