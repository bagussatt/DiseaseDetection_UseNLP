<!DOCTYPE html>
<html lang="id" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Antrian & Histori Deteksi | KonsulSehat</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* Definisi Variabel Warna CSS */
        :root {
            --font-primary: 'Inter', 'Poppins', sans-serif;
            --bg-primary: #f4f7f6; /* Light gray background */
            --bg-secondary: #ffffff; /* White cards/elements */
            --bg-muted: #e9ecef; /* Lighter gray for muted backgrounds (e.g., table headers) */
            --text-primary: #212529; /* Dark text for headings, main content */
            --text-secondary: #495057; /* Slightly lighter text for paragraphs, labels */
            --text-muted: #6c757d; /* Muted text for subtle details */
            --border-color: #dee2e6; /* Light border color */
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.04);
            --card-shadow-hover: 0 10px 15px -3px rgba(0, 0, 0, 0.07), 0 4px 6px -4px rgba(0, 0, 0, 0.05);
            --navbar-bg: #2c3e50; /* Dark blue for navbar */
            --navbar-text: #ecf0f1; /* Light text for navbar */
            --active-filter-bg: #3498db; /* Accent blue for active filters */
            --active-filter-text: #ffffff; /* White text on active filters */
            --accent-color: #3498db; /* Primary accent color (blue) */
            --success-color: #2ecc71; /* Green for success/complete actions */
            --warning-color: #f39c12; /* Orange for warning/cancel actions */
            --danger-color: #e74c3c; /* Red for danger/delete actions */
            --info-color: #3498db; /* Blue for info/check-in actions */
            --sidebar-width: 16rem; /* 256px */
            --indigo-color: #6366f1; /* Tailwind indigo-500 */
            --purple-color: #9333ea; /* Tailwind purple-600 */

            /* Status Indicator Colors */
            --status-reg-color: #3498db; /* Blue */
            --status-checkin-color: #f39c12; /* Orange */
            --status-selesai-color: #2ecc71; /* Green */
            --status-text-inactive: #a0aec0; /* Gray for inactive status */
        }
        html.dark {
            --bg-primary: #1a202c; /* Dark primary background */
            --bg-secondary: #2d3748; /* Darker secondary background */
            --bg-muted: #4a5568; /* Even darker muted background */
            --text-primary: #e2e8f0; /* Light text for headings, main content */
            --text-secondary: #a0aec0; /* Slightly darker light text */
            --text-muted: #718096; /* Muted light text */
            --border-color: #4a5568; /* Darker border color */
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            --card-shadow-hover: 0 10px 15px -3px rgba(0, 0, 0, 0.15), 0 4px 6px -4px rgba(0, 0, 0, 0.05);
            --navbar-bg: #171923; /* Darker navy for navbar */
            --navbar-text: #cbd5e0; /* Off-white text for navbar */
            --active-filter-bg: #2b6cb0; /* Darker blue for active filters */
            --active-filter-text: #ffffff; /* White text on active filters */
            --accent-color: #4299e1; /* Lighter blue accent */
            --success-color: #38a169; /* Darker green */
            --warning-color: #d69e2e; /* Darker orange */
            --danger-color: #e53e3e; /* Darker red */
            --info-color: #4299e1; /* Lighter blue info */
            --indigo-color: #7f8cf2; /* Lighter indigo for dark mode */
            --purple-color: #ae75f4; /* Lighter purple for dark mode */

            /* Status Indicator Colors (Dark Mode) */
            --status-reg-color: #63b3ed; /* Lighter Blue */
            --status-checkin-color: #f6ad55; /* Lighter Orange */
            --status-selesai-color: #68d391; /* Lighter Green */
            --status-text-inactive: #718096; /* Gray for inactive status */
        }

        /* Styling Umum */
        body { font-family: var(--font-primary); background-color: var(--bg-primary); color: var(--text-primary); transition: background-color 0.3s ease, color 0.3s ease; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; min-height: 100vh; display: flex; flex-direction: column;} /* Added flex properties */
        nav { background: var(--navbar-bg); color: var(--navbar-text); }
        main h1, main h2, main h3, aside h3 { color: var(--text-primary); font-weight: 600; }
        main p, main span, main label, main td, main th, aside p, aside span, aside label { color: var(--text-secondary); }
        main p i, main span i, aside p i, aside span i { color: var(--text-muted); width: 1rem; text-align: center; }
        main pre { background-color: var(--bg-muted); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 0.375rem; padding: 0.5rem; font-size: 0.875rem;}
        main input, main select, main textarea, aside input, .modal input { background-color: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 0.375rem; padding: 0.5rem 0.75rem; transition: border-color 0.2s ease, box-shadow 0.2s ease; }
        main input:focus, main select:focus, main textarea:focus, aside input:focus, .modal input:focus { outline: none; border-color: var(--accent-color); box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2); }
        html.dark main input:focus, html.dark main select:focus, html.dark main textarea:focus, html.dark aside input:focus, html.dark .modal input:focus { box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.2); }

        main input::placeholder, aside input::placeholder, .modal input::placeholder { color: var(--text-muted); }
        main .border-b, main .border-t, aside .border-t, .modal .border-b, .modal .border-t { border-color: var(--border-color); }

        /* Styling Kartu Reservasi */
        .reservation-card-horizontal { background-color: var(--bg-secondary); border: 1px solid var(--border-color); box-shadow: var(--card-shadow); transition: transform 0.2s ease-out, box-shadow 0.2s ease-out, background-color 0.2s ease-out; border-radius: 0.75rem; }
        .reservation-card-horizontal:hover { transform: translateY(-4px); box-shadow: var(--card-shadow-hover); }
        .reservation-card-horizontal h2 { color: var(--text-primary); font-weight: 600; }
        .reservation-card-horizontal p { color: var(--text-secondary); font-size: 0.875rem; }
        .reservation-card-horizontal p i { color: var(--text-muted); width: 1rem; text-align: center; }

        /* Style untuk scrollable diagnosis box (used within reservation cards) */
        .diagnosis-scroll-container {
            max-height: 120px; /* Keep max height and scrolling for these sections */
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 0.375rem;
            padding: 0.5rem;
            background-color: var(--bg-muted);
        }
        html.dark .diagnosis-scroll-container {
            background-color: var(--bg-primary);
        }
        .diagnosis-scroll-container pre {
            background-color: transparent !important;
            border: none !important;
            padding: 0 !important;
            max-height: none !important;
            font-size: 0.875rem;
        }

        /* Styling Status Chip (Removed from card layout, kept for general use if needed) */
        .status-chip { padding: 0.3rem 0.8rem; border-radius: 0.375rem; font-size: 0.75rem; font-weight: 600; border-width: 1px; letter-spacing: 0.5px; text-transform: uppercase; display: inline-flex; align-items: center; }
        .status-registrasi { background-color: #e7f3fe; color: #3498db; border-color: #aed6f1; }
        .status-checkin { background-color: #fef9e7; color: #f39c12; border-color: #fde3a7; }
        .status-selesai { background-color: #e8f8f5; color: #2ecc71; border-color: #a2d9ce; }
        .status-dibatalkan { background-color: #fdedec; color: #e74c3c; border-color: #f5b7b1; }
        html.dark .status-registrasi { background-color: #2c5282; color: #90cdf4; border-color: #4299e1; }
        html.dark .status-checkin { background-color: #b7791f; color: #f6e05e; border-color: #ecc94b; }
        html.dark .status-selesai { background-color: #2f855a; color: #9ae6b4; border-color: #68d391; }
        html.dark .status-dibatalkan { background-color: #c53030; color: #feb2b2; border-color: #fc8181; }


        /* Styling Status Indicator in Middle Column */
        .status-indicator-bar {
            display: flex;
            justify-content: space-around; /* Atau space-between */
            align-items: center;
            gap: 0.3rem; /* Space between status chips */
            margin-bottom: 1rem; /* Mengurangi space below the status bar */
            padding-bottom: 0.75rem; /* Mengurangi padding below the bar */
            border-bottom: 1px solid var(--border-color); /* Separator line */
            width: 100%;
        }

        .status-indicator-bar .status-item {
            flex-grow: 1;
            text-align: center; /* Center text within the item */
            padding: 0.2rem 0.5rem;
            border-radius: 0.25rem; /* Sedikit lebih kecil */
            font-size: 0.75rem; /* Smaller font for indicators */
            font-weight: 500;
            text-transform: uppercase;
            opacity: 0.4; /* Dim by default */
            transition: opacity 0.2s ease, background-color 0.2s ease, color 0.2s ease;
            border: 1px solid transparent; /* Add border for consistency */
        }

        .status-indicator-bar .status-item.active {
            opacity: 1; /* Full opacity when active */
            font-weight: 700; /* Bolder text */
            border-color: currentColor; /* Border matches text color */
        }

        /* Specific colors for active status indicators */
        .status-indicator-bar .status-item.active.status-registrasi-active {
            background-color: var(--status-reg-color);
            color: white;
            border-color: var(--status-reg-color);
        }
        .status-indicator-bar .status-item.active.status-checkin-active {
            background-color: var(--status-checkin-color);
            color: white;
            border-color: var(--status-checkin-color);
        }
        .status-indicator-bar .status-item.active.status-selesai-active {
            background-color: var(--status-selesai-color);
            color: white;
            border-color: var(--status-selesai-color);
        }
        /* Dark mode specific active colors */
        html.dark .status-indicator-bar .status-item.active.status-registrasi-active {
            background-color: var(--status-reg-color);
            border-color: var(--status-reg-color);
        }
        html.dark .status-indicator-bar .status-item.active.status-checkin-active {
            background-color: var(--status-checkin-color);
            border-color: var(--status-checkin-color);
        }
        html.dark .status-indicator-bar .status-item.active.status-selesai-active {
            background-color: var(--status-selesai-color);
            border-color: var(--status-selesai-color);
        }


        /* Styling Tombol Filter Sidebar */
        #filterSidebar h3 { font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.75rem; color: var(--text-muted); font-weight: 600; }
        .filter-btn { border-width: 1px; transition: background-color 0.15s ease-in-out, border-color 0.15s ease-in-out, color 0.15s ease-in-out, transform 0.1s ease, box-shadow 0.15s ease-in-out; text-align: left; width: 100%; padding: 0.6rem 0.85rem; font-size: 0.875rem; font-weight: 500; border-radius: 0.5rem; display: flex; align-items: center; }
        .filter-btn i { margin-right: 0.6rem; width: 16px; text-align: center; color: var(--text-muted); }
        .filter-btn.active i { color: var(--active-filter-text); }
        .filter-btn:not(.active) { background-color: transparent; border-color: var(--border-color); color: var(--text-secondary); }
        .filter-btn:not(.active):hover { background-color: var(--bg-muted); border-color: var(--border-color); color: var(--text-primary); transform: translateX(2px); }
        .filter-btn.active { background-color: var(--active-filter-bg); color: var(--active-filter-text); border-color: var(--active-filter-bg); box-shadow: 0 2px 4px rgba(52, 152, 219, 0.2); }
        html.dark .filter-btn:not(.active) { border-color: var(--border-color); }
        html.dark .filter-btn:not(.active):hover { background-color: var(--bg-muted); color: var(--text-primary); }

        /* Specific sidebar button colors (overriding filter-btn base styles) */
        .filter-btn.bg-indigo-500-custom { background-color: var(--indigo-color); border-color: var(--indigo-color); color: white; }
        .filter-btn.bg-indigo-500-custom:hover { background-color: color-mix(in srgb, var(--indigo-color) 80%, black); border-color: color-mix(in srgb, var(--indigo-color) 80%, black); }
        html.dark .filter-btn.bg-indigo-500-custom { background-color: var(--indigo-color); border-color: var(--indigo-color); }
        html.dark .filter-btn.bg-indigo-500-custom:hover { background-color: color-mix(in srgb, var(--indigo-color) 80%, black); border-color: color-mix(in srgb, var(--indigo-color) 80%, black); }

        .filter-btn.bg-purple-600-custom { background-color: var(--purple-color); border-color: var(--purple-color); color: white; }
        .filter-btn.bg-purple-600-custom:hover { background-color: color-mix(in srgb, var(--purple-color) 80%, black); border-color: color-mix(in srgb, var(--purple-color) 80%, black); }
        html.dark .filter-btn.bg-purple-600-custom { background-color: var(--purple-color); border-color: var(--purple-color); }
        html.dark .filter-btn.bg-purple-600-custom:hover { background-color: color-mix(in srgb, var(--purple-color) 80%, black); border-color: color-mix(in srgb, var(--purple-color) 80%, black); }

        /* Filter Selesai specific color */
        .filter-btn.status-selesai-filter.active {
            background-color: var(--status-selesai-color);
            border-color: var(--status-selesai-color);
            color: white;
        }
        .filter-btn.status-selesai-filter.active:hover {
            background-color: color-mix(in srgb, var(--status-selesai-color) 80%, black);
            border-color: color-mix(in srgb, var(--status-selesai-color) 80%, black);
        }
        html.dark .filter-btn.status-selesai-filter.active {
            background-color: var(--status-selesai-color);
            border-color: var(--status-selesai-color);
        }
        html.dark .filter-btn.status-selesai-filter.active:hover {
            background-color: color-mix(in srgb, var(--status-selesai-color) 80%, black);
            border-color: color-mix(in srgb, var(--status-selesai-color) 80%, black);
        }


        /* Styling Pesan Loading & Error */
        #loadingMessage p, #noReservationMessage p { color: var(--text-muted); font-size: 1rem; }
        #loadingMessage i, #noReservationMessage i { color: var(--accent-color); font-size: 2.5rem; margin-bottom: 0.75rem; }
        #errorMessage { background-color: var(--danger-color); border: 1px solid var(--danger-color); color: white; border-radius: 0.5rem; }
        html.dark #errorMessage { background-color: var(--danger-color); border-color: var(--danger-color); color: var(--text-primary); }

        /* Styling Tombol Aksi Umum */
        .action-btn { font-size: 0.8rem; font-weight: 600; padding: 0.4rem 0.9rem; border-radius: 0.375rem; transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease; display: inline-flex; align-items: center; justify-content: center; text-transform: uppercase; letter-spacing: 0.5px; border: none; }
        .action-btn i { margin-right: 0.4rem; font-size: 0.8em; }
        .action-btn:hover { transform: translateY(-1px); box-shadow: 0 2px 5px rgba(0,0,0,0.15); }
        .btn-checkin { background-color: var(--info-color); color: white; } .btn-checkin:hover { background-color: color-mix(in srgb, var(--info-color) 80%, black); }
        .btn-selesai { background-color: var(--success-color); color: white; } .btn-selesai:hover { background-color: color-mix(in srgb, var(--success-color) 80%, black); }
        .btn-batalkan { background-color: var(--warning-color); color: white; } .btn-batalkan:hover { background-color: color-mix(in srgb, var(--warning-color) 80%, black); }
        .btn-hapus { background-color: var(--danger-color); color: white; } .btn-hapus:hover { background-color: color-mix(in srgb, var(--danger-color) 80%, black); }
        html.dark .btn-checkin { background-color: #2b6cb0; } html.dark .btn-checkin:hover { background-color: #2c5282; }
        html.dark .btn-selesai { background-color: #2f855a; } html.dark .btn-selesai:hover { background-color: #276749; }
        html.dark .btn-batalkan { background-color: #b7791f; } html.dark .btn-batalkan:hover { background-color: #975a16; }
        html.dark .btn-hapus { background-color: #c53030; } html.dark .btn-hapus:hover { background-color: #9b2c2c; }
        button.checkin-disabled { background-color: #a6cff7 !important; border-color: #a6cff7 !important; color: white !important; opacity: 0.7; cursor: not-allowed !important; }
        html.dark button.checkin-disabled { background-color: #4a5568 !important; border-color: #4a5568 !important; opacity: 0.7;}

        /* Styling untuk tombol Kelola Dokter */
        .btn-kelola-dokter {
            background-color: var(--success-color);
            color: white;
            border-color: var(--success-color);
        }
        .btn-kelola-dokter:hover {
            background-color: color-mix(in srgb, var(--success-color) 80%, black);
            border-color: color-mix(in srgb, var(--success-color) 80%, black);
        }
        html.dark .btn-kelola-dokter {
            background-color: var(--success-color);
            border-color: var(--success-color);
        }
        html.dark .btn-kelola-dokter:hover {
            background-color: color-mix(in srgb, var(--success-color) 80%, black);
            border-color: color-mix(in srgb, var(--success-color) 80%, black);
        }

        /* Animasi & Lain-lain */
        @keyframes spin { to { transform: rotate(360deg); } }
        .animate-spin-slow { animation: spin 1.5s linear infinite; }
        pre.whitespace-pre-wrap { white-space: pre-wrap; word-wrap: break-word; font-family: inherit; }
        button:disabled { opacity: 0.6; cursor: not-allowed; }
        button:disabled:hover { background-color: initial !important; transform: none; box-shadow: none; }
        .card-middle-col { min-width: 0; }
        body.overflow-hidden-custom { overflow: hidden; }

    /* Sidebar Styling & Toggle */
        #filterSidebar { background-color: var(--bg-secondary); border-right: 1px solid var(--border-color); box-shadow: 2px 0 15px -3px rgba(0,0,0,0.05); width: var(--sidebar-width); transition: width 0.3s ease-in-out, transform 0.3s ease-in-out, padding 0.3s ease-in-out, border 0.3s ease-in-out; }
        #filterSidebar.collapsed { width: 0; padding-left: 0; padding-right: 0; overflow: hidden; border-right: none; transform: translateX(-100%); }

        @media (max-width: 767px) {
            #filterSidebar { position: fixed; top: 4rem; bottom: 0; left: 0; transform: translateX(-100%); width: var(--sidebar-width); height: calc(100vh - 4rem); padding: 1.25rem; }
            #filterSidebar.open-mobile { transform: translateX(0); }
            #filterSidebar.collapsed { transform: translateX(-100%); } /* Tetap ada untuk mobile */
            /* On mobile, main content never has left margin from sidebar */
            main { margin-left: 0 !important; } /* Pastikan margin kiri 0 di mobile */
        }
        @media (min-width: 768px) {
            /* Sidebar bisa dibuka/tutup di desktop */
            #filterSidebar { position: sticky; top: 4rem; bottom: 0; left: 0; width: var(--sidebar-width); height: calc(100vh - 4rem); padding: 1.5rem; z-index: 10; box-shadow: none; transition: width 0.3s ease-in-out, transform 0.3s ease-in-out, padding 0.3s ease-in-out, border 0.3s ease-in-out; }
            #filterSidebar.collapsed { width: 0; padding-left: 0; padding-right: 0; overflow: hidden; border-right: none; transform: translateX(-100%); }

            /* Apply desktop margin based on collapsed state */
            main {
                transition: margin-left 0.3s ease-in-out; /* Keep transition for smooth effect */
                margin-left: var(--sidebar-width); /* Default margin when sidebar is NOT collapsed */
            }
            #filterSidebar.collapsed + main { /* Select main when it immediately follows a collapsed sidebar */
                margin-left: 0;
            }
        }

        html.dark #filterSidebar { box-shadow: 2px 0 15px -3px rgba(0,0,0,0.2); }

        /* Modal Styling */
        .modal { display: none; } .modal.active { display: flex; animation: fadeInModal 0.3s ease-out forwards; }
        .modal-overlay { background-color: rgba(0, 0, 0, 0.6); position: absolute; inset: 0; }
        .modal-content { background-color: var(--bg-secondary); max-height: 90vh; transform: scale(0.95); opacity: 0; animation: zoomInModal 0.3s ease-out 0.1s forwards; border-radius: 0.75rem; box-shadow: var(--card-shadow-hover); }
        html.dark .modal-content { background-color: var(--bg-secondary); }
        .modal-content label { font-size: 0.8rem; font-weight: 500; margin-bottom: 0.25rem; color: var(--text-secondary); }
        .modal-content input { font-size: 0.875rem; }
        .modal-content button[type="submit"].btn-simpan { background-color: var(--info-color); color: white; } .modal-content button[type="submit"].btn-simpan:hover { background-color: color-mix(in srgb, var(--info-color) 80%, black); }
        html.dark .modal-content button[type="submit"].btn-simpan { background-color: var(--info-color); } html.dark .modal-content button[type="submit"].btn-simpan:hover { background-color: color-mix(in srgb, var(--info-color) 80%, black); }
        .modal-content button[type="submit"].btn-tambah { background-color: var(--success-color); color: white; } .modal-content button[type="submit"].btn-tambah:hover { background-color: color-mix(in srgb, var(--success-color) 80%, black); }
        html.dark .modal-content button[type="submit"].btn-tambah { background-color: var(--success-color); } html.dark .modal-content button[type="submit"].btn-tambah:hover { background-color: color-mix(in srgb, var(--success-color) 80%, black); }
        .modal-content button[type="button"] { background-color: var(--bg-muted); color: var(--text-secondary); border: 1px solid var(--border-color); }
        .modal-content button[type="button"]:hover { background-color: color-mix(in srgb, var(--bg-muted) 80%, black); }
        html.dark .modal-content button[type="button"] { background-color: var(--bg-muted); color: var(--text-primary); border-color: var(--border-color); }
        html.dark .modal-content button[type="button"]:hover { background-color: color-mix(in srgb, var(--bg-muted) 80%, black); }
        @keyframes fadeInModal { from { opacity: 0; } to { opacity: 1; } }
        @keyframes zoomInModal { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* Table styling */
        #hospitalListTable, #detectionHistoryTable, #doctorListTable, #patientHistoryTable { width: 100%; border-collapse: collapse; }
        #hospitalListTable th, #hospitalListTable td, #detectionHistoryTable th, #detectionHistoryTable td, #doctorListTable th, #doctorListTable td, #patientHistoryTable th, #patientHistoryTable td { padding: 0.75rem 1rem; text-align: left; border-bottom: 1px solid var(--border-color); font-size: 0.875rem; vertical-align: top; }
        #hospitalListTable th, #detectionHistoryTable th, #doctorListTable th, #patientHistoryTable th { font-weight: 600; color: var(--text-primary); background-color: var(--bg-muted); }
        #hospitalListTable td, #detectionHistoryTable td, #doctorListTable td, #patientHistoryTable td { color: var(--text-secondary); }
        #hospitalListTable tr:last-child td, #detectionHistoryTable tr:last-child td, #doctorListTable tr:last-child td, #patientHistoryTable tr:last-child td { border-bottom: none; }
        #hospitalListTable .action-buttons button, #doctorListTable .action-buttons button, #patientHistoryTable .action-buttons button { padding: 0.25rem 0.5rem; font-size: 0.75rem; margin-left: 0.5rem; }
        html.dark #hospitalListTable th, html.dark #detectionHistoryTable th, html.dark #doctorListTable th, html.dark #patientHistoryTable th { background-color: var(--bg-muted); }
        html.dark #hospitalListTable td, html.dark #detectionHistoryTable td, html.dark #doctorListTable td, html.dark #patientHistoryTable td { color: var(--text-secondary); }
        .table-container { max-height: 300px; overflow-y: auto; margin-bottom: 1rem; border: 1px solid var(--border-color); border-radius: 0.5rem; background-color: var(--bg-secondary); box-shadow: var(--card-shadow); }
        html.dark .table-container { background-color: var(--bg-secondary); }

        /* Styling for the inline detection history section */
        #detectionHistorySection, #patientHistorySection {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            box-shadow: var(--card-shadow);
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-top: 2rem;
        }
        #detectionHistorySection h2, #patientHistorySection h2 {
            color: var(--text-primary);
            font-weight: 600;
            font-size: 1.5rem;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border-color);
        }
        #detectionHistorySection .table-container, #patientHistorySection .table-container {
            max-height: 500px;
        }
        #detectionHistorySection .loading-message,
        #detectionHistorySection .no-data-message,
        #patientHistorySection .loading-message,
        #patientHistorySection .no-data-message {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
            font-style: italic;
        }
        #detectionHistorySection .loading-message i,
        #detectionHistorySection .no-data-message i,
        #patientHistorySection .loading-message i,
        #patientHistorySection .no-data-message i {
            font-size: 2rem;
            color: var(--accent-color);
            margin-bottom: 0.5rem;
        }

        /* Specific styling for table cells */
        #detectionHistoryTable td pre, #patientHistoryTable td pre {
            max-height: none !important;
            overflow-y: visible !important;
            padding: 0 !important;
            background-color: transparent !important;
            border: none !important;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 0.875rem; /* Ensure consistent font size */
            color: var(--text-secondary); /* Use secondary text color */
        }
        /* Added specific styling for the diagnosis scroll container within reservation cards */
        .reservation-card-horizontal .diagnosis-scroll-container {
            max-height: 120px; /* Keep max height and scrolling for these sections */
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 0.375rem;
            padding: 0.5rem;
            background-color: var(--bg-muted);
        }
        html.dark .reservation-card-horizontal .diagnosis-scroll-container {
            background-color: var(--bg-primary);
        }
        .reservation-card-horizontal .diagnosis-scroll-container pre {
            background-color: transparent !important;
            border: none !important;
            padding: 0 !important;
            max-height: none !important;
            font-size: 0.875rem;
            color: var(--text-primary); /* Use primary text color for content */
        }

    </style>
</head>
<body class="flex flex-col">
    <nav class="fixed top-0 left-0 right-0 z-50 shadow-lg h-16 flex items-center">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center">
            <button id="sidebarToggleBtn" class="p-2 rounded-md hover:bg-white hover:bg-opacity-20 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-white mr-3" aria-label="Toggle Sidebar">
                <i class="fas fa-bars text-xl text-white"></i>
            </button>
            <a class="text-xl font-bold flex items-center tracking-tight mr-auto" href="#">
                <i class="fas fa-stethoscope mr-2 text-2xl" style="color: var(--accent-color);"></i>
                <span class="text-white">Admin KonsulSehat</span>
            </a>
            <div class="flex items-center space-x-3 sm:space-x-4">
                <button id="theme-toggle" type="button" class="text-gray-300 hover:text-white focus:outline-none text-xl p-1.5 rounded-lg hover:bg-opacity-20 hover:bg-white transition-colors duration-200">
                    <i class="fas fa-moon" id="theme-toggle-dark-icon"></i>
                    <i class="fas fa-sun hidden" id="theme-toggle-light-icon"></i>
                </button>
                <button id="userIconButton" onclick="logoutUser()" aria-label="Logout">
                    <i class="fas fa-user-circle text-2xl"></i>
                </button>
            </div>
        </div>
    </nav>

    <div id="sidebarOverlay" class="fixed inset-0 bg-black bg-opacity-60 z-30 hidden md:hidden"></div>

    <div class="flex flex-grow pt-16">
        <aside id="filterSidebar"
               class="fixed inset-y-0 left-0 z-40 transition-transform duration-300 ease-in-out
                      md:relative md:translate-x-0 md:sticky md:top-16
                      h-screen md:h-[calc(100vh-4rem)] overflow-y-auto
                      p-5 flex flex-col">
            <div class="mb-6">
                <h3 class="text-xs font-semibold mb-3 tracking-wider uppercase" style="color: var(--text-muted);">Filter Status</h3>
                <div class="flex flex-col space-y-1.5 status-filter-buttons-container">
                    <button data-status="semua" class="filter-btn status-filter-btn"><i class="fas fa-list-ul"></i>Semua Status</button>
                    <button data-status="antrian" class="filter-btn status-filter-btn active"><i class="fas fa-hourglass-half"></i>Antrian</button>
                    <button data-status="checkin" class="filter-btn status-filter-btn"><i class="fas fa-user-check"></i>Check-in</button>
                    <button data-status="selesai" class="filter-btn status-filter-btn status-selesai-filter"><i class="fas fa-check-double"></i>Selesai</button>
                    <button data-status="dibatalkan" class="filter-btn status-filter-btn"><i class="fas fa-times-circle"></i>Dibatalkan</button>
                </div>
            </div>

            <div class="mt-auto pt-6 border-t flex flex-col space-y-2" style="border-color: var(--border-color);">
                <h3 class="text-xs font-semibold mb-3 tracking-wider uppercase" style="color: var(--text-muted);">Pengaturan & Data</h3>
                <button id="openHospitalCrudModalBtn" class="filter-btn bg-indigo-500-custom">
                    <i class="fas fa-hospital-user"></i> Kelola Rumah Sakit
                </button>
                <button id="openDoctorCrudModalBtn" class="filter-btn btn-kelola-dokter">
                    <i class="fas fa-user-md"></i> Kelola Dokter
                </button>
                <button id="scrollToDetectionHistoryBtn" class="filter-btn bg-purple-600-custom">
                    <i class="fas fa-history"></i> Histori Deteksi
                </button>
                <button id="openPatientHistorySectionBtn" class="filter-btn bg-purple-600-custom">
                    <i class="fas fa-users"></i> Histori Pasien
                </button>
            </div>
        </aside>

        <main id="mainContent" class="flex-1 overflow-y-auto h-[calc(100vh-4rem)] transition-all duration-300 ease-in-out">
            <div id="reservationSection" class="p-4 sm:p-6 md:p-8">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-6 pb-4 border-b" style="border-color: var(--border-color);">
                    <h1 class="text-2xl sm:text-3xl font-semibold mb-4 sm:mb-0">Antrian Reservasi Pasien</h1>
                </div>

                <div id="loadingMessage" class="text-center py-12 flex flex-col items-center justify-center">
                    <i class="fas fa-spinner animate-spin-slow"></i>
                    <p class="mt-3 text-lg">Memuat data antrian...</p>
                </div>
                <div id="errorMessage" class="hidden px-6 py-4 rounded-lg relative mb-6 text-center" role="alert">
                    <strong class="font-bold block text-lg">Oops! Terjadi Kesalahan</strong>
                    <span class="block sm:inline mt-1" id="errorMessageText"></span>
                </div>

                <div id="reservationList" class="space-y-6">
                </div>

                <div id="noReservationMessage" class="hidden text-center py-12 flex-col items-center justify-center">
                    <i class="fas fa-folder-open"></i>
                    <p class="mt-3 text-lg">Belum ada reservasi yang sesuai dengan filter Anda.</p>
                    <p class="text-sm mt-1" style="color: var(--text-muted);">Coba ubah filter atau tunggu reservasi baru masuk.</p>
                </div>
            </div>

            <div id="detectionHistorySection" class="hidden p-4 sm:p-6 md:p-8">
                <h2 class="text-2xl font-semibold mb-4">Histori Deteksi Penyakit</h2>
                <div id="detectionHistoryTableContainer" class="table-container">
                    <table id="detectionHistoryTable">
                        <thead>
                            <tr>
                                <th class="w-1/6">Waktu</th>
                                <th class="w-1/4">Input Teks</th>
                                <th class="w-1/4">Hasil Deteksi</th>
                                <th class="w-1/4">Gejala Terdeteksi</th>
                            </tr>
                        </thead>
                        <tbody id="detectionHistoryTableBody">
                            <tr><td colspan="4" class="text-center py-4 italic loading-message" style="color: var(--text-muted);"><i class="fas fa-spinner animate-spin-slow mr-2"></i> Memuat data histori...</td></tr>
                        </tbody>
                    </table>
                </div>
                <p id="noDetectionHistoryData" class="no-data-message hidden" style="color: var(--text-muted);">Belum ada data histori deteksi.</p>
            </div>

            <div id="patientHistorySection" class="hidden p-4 sm:p-6 md:p-8">
                <h2 class="text-2xl font-semibold mb-4">Histori Reservasi Pasien</h2>
                <div id="patientHistoryTableContainer" class="table-container">
                    <table id="patientHistoryTable">
                        <thead>
                            <tr>
                                <th>Nama Pasien</th>
                                <th>Telepon</th>
                                <th>Rumah Sakit</th>
                                <th>Dokter</th>
                                <th>Tanggal</th>
                                <th>Waktu</th>
                                <th>Status</th>
                                <th>Diagnosis</th>
                            </tr>
                        </thead>
                        <tbody id="patientHistoryTableBody">
                            <tr><td colspan="8" class="text-center py-4 italic loading-message" style="color: var(--text-muted);"><i class="fas fa-spinner animate-spin-slow mr-2"></i> Memuat data histori pasien...</td></tr>
                        </tbody>
                    </table>
                </div>
                <p id="noPatientHistoryData" class="no-data-message hidden" style="color: var(--text-muted);">Belum ada data histori pasien.</p>
            </div>
        </main>
    </div>

    <div id="hospitalCrudModal" class="modal fixed inset-0 z-50 items-center justify-center p-4">
        <div class="modal-overlay fixed inset-0 cursor-pointer"></div>
        <div class="modal-content relative w-full max-w-2xl p-6 rounded-lg shadow-xl overflow-y-auto">
            <div class="flex justify-between items-center pb-3 border-b mb-4" style="border-color: var(--border-color);">
                <h3 class="text-lg font-semibold" style="color: var(--text-primary);">Kelola Data Rumah Sakit</h3>
                <button id="closeHospitalCrudModalBtn" class="text-xl font-bold hover:text-red-500 transition-colors duration-150" style="color: var(--text-muted);">&times;</button>
            </div>

            <div class="mb-6">
                <h4 class="text-md font-semibold mb-2" style="color: var(--text-primary);">Daftar Rumah Sakit</h4>
                <div id="hospitalListContainer" class="table-container">
                    <table id="hospitalListTable">
                        <thead>
                            <tr>
                                <th>Nama Rumah Sakit</th>
                                <th>Singkatan</th>
                                <th class="text-right">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="hospitalListTableBody">
                            <tr><td colspan="3" class="text-center py-4 italic" style="color: var(--text-muted);">Memuat data...</td></tr>
                        </tbody>
                    </table>
                </div>
                <p id="noHospitalData" class="text-center py-4 italic hidden" style="color: var(--text-muted);">Belum ada data rumah sakit.</p>
            </div>

            <div>
                <h4 id="hospitalFormTitle" class="text-md font-semibold mb-3" style="color: var(--text-primary);">Tambah Rumah Sakit Baru</h4>
                <form id="hospitalCrudForm" class="space-y-4">
                    <input type="hidden" id="hospitalEditId">
                    <div>
                        <label for="hospitalNameInput" class="block">Nama Lengkap RS <span class="text-red-500">*</span></label>
                        <input type="text" id="hospitalNameInput" placeholder="Contoh: RS Sehat Sentosa" required
                                class="block w-full focus:outline-none focus:ring-1 focus:ring-[var(--accent-color)] focus:border-[var(--accent-color)]">
                    </div>
                    <div>
                        <label for="hospitalAbbrInput" class="block">Singkatan (untuk Opsi) <span class="text-red-500">*</span></label>
                        <input type="text" id="hospitalAbbrInput" placeholder="Contoh: RS Sentosa" required
                                class="block w-full focus:outline-none focus:ring-1 focus:ring-[var(--accent-color)] focus:border-[var(--accent-color)]">
                    </div>
                    <div class="flex justify-end pt-4 space-x-3 border-t mt-5" style="border-color: var(--border-color);">
                        <button type="button" id="cancelHospitalEditBtn" class="action-btn px-4 py-2 hidden">
                            Batal Edit
                        </button>
                        <button type="submit" id="hospitalSubmitBtn" class="action-btn btn-tambah px-4 py-2 flex items-center justify-center">
                            <i class="fas fa-plus mr-2"></i> Tambah RS
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="doctorCrudModal" class="modal fixed inset-0 z-50 items-center justify-center p-4">
        <div class="modal-overlay fixed inset-0 cursor-pointer"></div>
        <div class="modal-content relative w-full max-w-4xl p-6 rounded-lg shadow-xl overflow-y-auto">
            <div class="flex justify-between items-center pb-3 border-b mb-4" style="border-color: var(--border-color);">
                <h3 class="text-lg font-semibold" style="color: var(--text-primary);">Kelola Data Dokter</h3>
                <button id="closeDoctorCrudModalBtn" class="text-xl font-bold hover:text-red-500 transition-colors duration-150" style="color: var(--text-muted);">&times;</button>
            </div>

            <div class="mb-6">
                <h4 id="doctorFormTitle" class="text-md font-semibold mb-3" style="color: var(--text-primary);">Tambah Dokter Baru</h4>
                <form id="doctorCrudForm" class="space-y-4">
                    <input type="hidden" id="doctorId">
                    <input type="hidden" id="doctorUid">
                    <div>
                        <label for="doctorNameInput" class="block">Nama Dokter <span class="text-red-500">*</span></label>
                        <input type="text" id="doctorNameInput" placeholder="Masukkan nama dokter" required>
                    </div>
                    <div>
                        <label for="doctorSpecializationInput" class="block">Spesialisasi (Poli) <span class="text-red-500">*</span></label>
                        <input type="text" id="doctorSpecializationInput" placeholder="Contoh: Umum, Gigi, Anak" required>
                    </div>
                    <div>
                        <label for="doctorHospitalSelect" class="block">Rumah Sakit <span class="text-red-500">*</span></label>
                        <select id="doctorHospitalSelect" required>
                            <option value="">-- Pilih Rumah Sakit --</option>
                        </select>
                    </div>
                    <div>
                        <label for="doctorPracticeDaysInput" class="block">Hari Praktik <span class="text-red-500">*</span></label>
                        <input type="text" id="doctorPracticeDaysInput" placeholder="Contoh: Senin-Jumat, Sabtu" required>
                        <p class="text-xs mt-1" style="color: var(--text-muted);">Masukkan format hari praktik (misal: Senin-Jumat, Sabtu).</p>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-4">
                        <div class="flex-1">
                            <label for="doctorStartTimeInput" class="block">Jam Mulai <span class="text-red-500">*</span></label>
                            <input type="time" id="doctorStartTimeInput" required>
                        </div>
                        <div class="flex-1">
                            <label for="doctorEndTimeInput" class="block">Jam Selesai <span class="text-red-500">*</span></label>
                            <input type="time" id="doctorEndTimeInput" required>
                        </div>
                    </div>

                    <div id="authFields" class="space-y-4 pt-4 border-t" style="border-color: var(--border-color);">
                        <h3 class="text-base font-semibold" style="color: var(--text-primary);">Informasi Akun Login</h3>
                        <div>
                            <label for="doctorEmailInput" class="block">Email <span class="text-red-500">*</span></label>
                            <input type="email" id="doctorEmailInput" placeholder="email.dokter@example.com">
                        </div>
                        <div>
                            <label for="doctorPasswordInput" class="block">Password <span class="text-red-500">*</span></label>
                            <input type="password" id="doctorPasswordInput" placeholder="Buat password">
                        </div>
                        <p class="text-xs" style="color: var(--text-muted);">Email dan password ini akan digunakan dokter untuk login.</p>
                        <p class="text-xs font-semibold text-orange-600 dark:text-orange-400">
                            <i class="fas fa-exclamation-triangle mr-1"></i> Sistem akan otomatis mencoba mengatur klaim 'doctor: true' di backend setelah akun dibuat.
                        </p>
                    </div>

                    <div class="flex justify-end pt-4 space-x-3 border-t mt-5" style="border-color: var(--border-color);">
                        <button type="button" id="cancelDoctorEditBtn" class="action-btn px-4 py-2 hidden">
                            Batal Edit
                        </button>
                        <button type="submit" id="doctorSubmitBtn" class="action-btn btn-tambah px-4 py-2 flex items-center justify-center">
                            <i class="fas fa-plus mr-2"></i> Tambah Dokter
                        </button>
                    </div>
                </form>
            </div>

            <div class="mt-8">
                <h4 class="text-md font-semibold mb-3" style="color: var(--text-primary);">Daftar Dokter</h4>
                <div id="doctorListContainer" class="table-container">
                    <table id="doctorListTable">
                        <thead>
                            <tr>
                                <th>Nama Dokter</th>
                                <th>Spesialisasi</th>
                                <th>Rumah Sakit</th>
                                <th>Hari Praktik</th>
                                <th>Jam Mulai</th>
                                <th>Jam Selesai</th>
                                <th class="text-right">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="doctorListTableBody">
                            <tr><td colspan="7" class="text-center py-4 italic" style="color: var(--text-muted);">Memuat data dokter...</td></tr>
                        </tbody>
                    </table>
                </div>
                <p id="noDoctorData" class="text-center py-4 italic hidden" style="color: var(--text-muted);">Belum ada data dokter.</p>
            </div>
        </div>
    </div>


    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        // --- Variabel Global ---
        let firebaseApp;
        let firebaseAuth;
        let firebaseDb;
        const reservationSection = document.getElementById('reservationSection');
        const detectionHistorySection = document.getElementById('detectionHistorySection');
        const patientHistorySection = document.getElementById('patientHistorySection'); // NEW

        const reservationListDiv = document.getElementById('reservationList');
        const loadingMessageDiv = document.getElementById('loadingMessage');
        const errorMessageDiv = document.getElementById('errorMessage');
        const errorMessageText = document.getElementById('errorMessageText');
        const noReservationMessageDiv = document.getElementById('noReservationMessage');
        let statusFilterButtons; // Will be populated after DOM is ready
        let allReservations = {}; // Cache untuk semua data reservasi

        // Elemen UI Tema
        const themeToggleButton = document.getElementById('theme-toggle');
        const themeToggleDarkIcon = document.getElementById('theme-toggle-dark-icon');
        const themeToggleLightIcon = document.getElementById('theme-toggle-light-icon');

        // Elemen UI Sidebar & Main Content
        const sidebarToggleBtn = document.getElementById('sidebarToggleBtn');
        const filterSidebar = document.getElementById('filterSidebar');
        const mainContent = document.getElementById('mainContent');
        const sidebarOverlay = document.getElementById('sidebarOverlay');

        // Elemen UI Modal CRUD RS
        const hospitalCrudModal = document.getElementById('hospitalCrudModal');
        const openHospitalCrudModalBtn = document.getElementById('openHospitalCrudModalBtn'); // Tombol di sidebar
        const closeHospitalCrudModalBtn = document.getElementById('closeHospitalCrudModalBtn'); // Tombol X di modal
        const hospitalCrudForm = document.getElementById('hospitalCrudForm');
        const hospitalFormTitle = document.getElementById('hospitalFormTitle');
        const hospitalEditIdInput = document.getElementById('hospitalEditId');
        const hospitalNameInput = document.getElementById('hospitalNameInput');
        const hospitalAbbrInput = document.getElementById('hospitalAbbrInput');
        const hospitalSubmitBtn = document.getElementById('hospitalSubmitBtn');
        const cancelHospitalEditBtn = document.getElementById('cancelHospitalEditBtn'); // Tombol batal edit
        const hospitalListTableBody = document.getElementById('hospitalListTableBody'); // tbody tabel RS
        const noHospitalDataMsg = document.getElementById('noHospitalData'); // Pesan jika tabel kosong
        const hospitalModalOverlay = hospitalCrudModal ? hospitalCrudModal.querySelector('.modal-overlay') : null;

        // Elemen UI Histori Deteksi Inline
        const scrollToDetectionHistoryBtn = document.getElementById('scrollToDetectionHistoryBtn'); // Tombol di sidebar
        const detectionHistoryTableBody = document.getElementById('detectionHistoryTableBody'); // tbody tabel histori
        const noDetectionHistoryDataMsg = document.getElementById('noDetectionHistoryData'); // Pesan jika tabel histori kosong

        // Elemen UI Modal CRUD Dokter (BARU)
        const doctorCrudModal = document.getElementById('doctorCrudModal');
        const openDoctorCrudModalBtn = document.getElementById('openDoctorCrudModalBtn'); // Tombol di sidebar
        const closeDoctorCrudModalBtn = document.getElementById('closeDoctorCrudModalBtn'); // Tombol X di modal
        const doctorModalOverlay = doctorCrudModal ? doctorCrudModal.querySelector('.modal-overlay') : null;

        // Elemen Form Dokter (dipindahkan ke dalam modal)
        const doctorCrudForm = document.getElementById('doctorCrudForm');
        const doctorFormTitle = document.getElementById('doctorFormTitle');
        const doctorIdInput = document.getElementById('doctorId');
        const doctorUidInput = document.getElementById('doctorUid');
        const doctorNameInput = document.getElementById('doctorNameInput');
        const doctorSpecializationInput = document.getElementById('doctorSpecializationInput');
        const doctorHospitalSelect = document.getElementById('doctorHospitalSelect');
        const doctorPracticeDaysInput = document.getElementById('doctorPracticeDaysInput');
        const doctorStartTimeInput = document.getElementById('doctorStartTimeInput');
        const doctorEndTimeInput = document.getElementById('doctorEndTimeInput');
        const doctorEmailInput = document.getElementById('doctorEmailInput');
        const doctorPasswordInput = document.getElementById('doctorPasswordInput');
        const authFieldsDiv = document.getElementById('authFields');

        const doctorSubmitBtn = document.getElementById('doctorSubmitBtn');
        const cancelDoctorEditBtn = document.getElementById('cancelDoctorEditBtn');

        const doctorListTableBody = document.getElementById('doctorListTableBody');
        const noDoctorDataMsg = document.getElementById('noDoctorData');

        // Elemen UI Histori Pasien (NEW)
        const openPatientHistorySectionBtn = document.getElementById('openPatientHistorySectionBtn');
        const patientHistoryTableBody = document.getElementById('patientHistoryTableBody');
        const noPatientHistoryDataMsg = document.getElementById('noPatientHistoryData');


        // --- Fungsi Utilitas UI ---
        /** Menampilkan atau menyembunyikan pesan loading */
        function showLoading(isLoading) {
            if (loadingMessageDiv) {
                loadingMessageDiv.style.display = isLoading ? 'flex' : 'none';
                loadingMessageDiv.classList.toggle('flex-col', isLoading);
                loadingMessageDiv.classList.toggle('items-center', isLoading);
                loadingMessageDiv.classList.toggle('justify-center', isLoading);
            }
        }

        /** Menampilkan pesan error */
        function showErrorMessage(message) {
            if (errorMessageDiv && errorMessageText) {
                errorMessageText.textContent = message;
                errorMessageDiv.classList.remove('hidden');
                showLoading(false); // Sembunyikan loading jika ada error
            } else {
                console.error("Tidak dapat menampilkan pesan error:", message);
                Swal.fire('Error', message, 'error'); // Fallback SweetAlert2
            }
        }

        /** Menyembunyikan pesan error */
        function hideErrorMessage() {
            if (errorMessageDiv) errorMessageDiv.classList.add('hidden');
        }

        /** Menampilkan atau menyembunyikan pesan "Tidak ada reservasi" */
        function showNoReservations(show) {
            if (noReservationMessageDiv) {
                noReservationMessageDiv.style.display = show ? 'flex' : 'none';
                noReservationMessageDiv.classList.toggle('flex-col', show);
                noReservationMessageDiv.classList.toggle('items-center', show);
                noReservationMessageDiv.classList.toggle('justify-center', show);
            }
        }

        /** Escapes HTML special characters */
        function escapeHtml(unsafe) {
            if (unsafe === null || typeof unsafe === 'undefined') return "";
            return unsafe.toString()
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
        }

        /** Mengambil teks diagnosis dari array hasil deteksi */
        function getDiagnosisText(hasilArray) {
            if (!hasilArray || !Array.isArray(hasilArray) || hasilArray.length === 0) {
                return 'Tidak ada diagnosis terdeteksi.';
            }
            return hasilArray.map(item => {
                let text = `Penyakit: ${item.penyakit || '-'}\n`;
                text += `Skor: ${item.skor || 0}\n`;
                // Corrected to use item.gejala for symptoms
                text += `Gejala: ${Array.isArray(item.gejala) ? item.gejala.join(', ') : '-'}\n`;
                text += `Saran Dokter: ${item.saranDokter || '-'}\n`;
                text += `Saran Obat: ${item.saranObat || '-'}\n`;
                text += `Sumber: ${item.sumber || '-'}`;
                return text;
            }).join('\n\n---\n\n');
        }

        // --- Fungsi Inti Aplikasi (Antrian Reservasi) ---

        /** Membuat elemen HTML untuk kartu reservasi */
        function createReservationCard(reservationId, data, queueNumber, canCheckIn) {
            const card = document.createElement('div');
            // Menyesuaikan padding dan gap untuk tampilan yang lebih rapi
            card.className = 'reservation-card-horizontal p-4 sm:p-5 flex flex-col lg:flex-row items-stretch gap-y-4 lg:gap-y-0 lg:gap-x-4 border-l-[6px]';
            card.setAttribute('data-id', reservationId);

            let statusColorClass = 'border-sky-500'; // Default for 'registrasi'
            const currentStatus = data.status ? data.status.toLowerCase() : 'registrasi';

            if (currentStatus === 'checkin') { statusColorClass = 'border-amber-500'; }
            else if (currentStatus === 'selesai') { statusColorClass = 'border-green-500'; }
            else if (currentStatus === 'dibatalkan') { statusColorClass = 'border-red-500'; }
            card.classList.add(statusColorClass);

            let datePart = data.tanggal || 'Tanggal tidak tersedia';
            let timePart = data.waktu ? ` <span class="font-semibold">${data.waktu}</span>` : '';
            let dateTimeString = datePart + timePart;
            let timestampString = '';
            if (data.timestamp) {
                try { timestampString = new Date(data.timestamp).toLocaleString('id-ID', { day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit', hour12: false }); }
                catch(e){ console.warn("Gagal format timestamp:", data.timestamp, e); }
            }
            // Use data.hasil for diagnosis/gejala in reservation card as per previous logic
            const diagnosisText = getDiagnosisText(data.hasil);
            const catatanText = data.catatan || 'Tidak ada catatan.';

            card.innerHTML = `
                <div class="flex-shrink-0 flex items-start space-x-4 pb-4 lg:pb-0 lg:pr-4 lg:border-r lg:border-b-0 border-b lg:basis-[30%]" style="border-color: var(--border-color);">
                    <span class="bg-blue-600 text-white text-3xl font-bold w-14 h-14 sm:w-16 sm:h-16 flex items-center justify-center rounded-lg shadow-md flex-shrink-0">${queueNumber}</span>
                    <div class="flex-grow min-w-0 pt-0.5">
                        <h2 class="text-lg sm:text-xl font-semibold truncate" style="color: var(--text-primary);" title="${escapeHtml(data.nama || 'Pasien')}">${escapeHtml(data.nama || 'Pasien Tidak Dikenal')}</h2>
                        <p class="text-sm mt-1 truncate flex items-center"><i class="fas fa-phone-alt mr-2"></i> ${escapeHtml(data.telepon || '-')}</p>
                        <p class="text-sm truncate flex items-center"><i class="fas fa-calendar-alt mr-2"></i> ${dateTimeString}</p>
                        <p class="text-sm truncate flex items-center"><i class="fas fa-hospital mr-2"></i> ${escapeHtml(data.rumah_sakit || 'RS Tidak diketahui')}</p>
                        ${data.dokter_nama ? `<p class="text-sm truncate flex items-center"><i class="fas fa-user-md mr-2"></i> ${escapeHtml(data.dokter_nama)}</p>` : ''}
                    </div>
                </div>
                <div class="flex-grow card-middle-col py-4 lg:py-0 lg:px-4 lg:border-r lg:border-b-0 border-b lg:basis-[45%] flex flex-col" style="border-color: var(--border-color);">
                    <div class="status-indicator-bar flex-shrink-0">
                        <span class="status-item status-registrasi ${currentStatus === 'registrasi' ? 'active status-registrasi-active' : ''}">Reservasi</span>
                        <span class="status-item status-checkin ${currentStatus === 'checkin' ? 'active status-checkin-active' : ''}">Check-in</span>
                        <span class="status-item status-selesai ${currentStatus === 'selesai' ? 'active status-selesai-active' : ''}">Selesai</span>
                    </div>

                    ${data.catatan && data.catatan !== '-' ? `
                    <div class="mt-0 pt-3 border-t flex-shrink-0" style="border-color: var(--border-color);">
                        
                    </div>` : ''}
                </div>
                <div class="flex-shrink-0 flex flex-col items-stretch lg:items-end justify-between space-y-3 w-full lg:w-auto pt-4 lg:pt-0 lg:pl-4 lg:basis-[25%]" >
                    <div class="flex flex-col space-y-2 w-full">
                        ${currentStatus === 'registrasi' ? `<button onclick="confirmUpdateStatus('${reservationId}', 'checkin', '${escapeHtml(data.nama || 'pasien ini')}')" class="action-btn btn-checkin ${!canCheckIn ? 'checkin-disabled' : ''}" ${!canCheckIn ? 'disabled title="Hanya 3 antrian registrasi pertama yang bisa check-in"' : ''}> <i class="fas fa-user-check"></i> Check-in </button>` : ''}
                        ${currentStatus === 'checkin' ? `<button onclick="confirmUpdateStatus('${reservationId}', 'selesai', '${escapeHtml(data.nama || 'pasien ini')}')" class="action-btn btn-selesai"> <i class="fas fa-check-double"></i> Selesai </button>` : ''}
                        ${currentStatus !== 'selesai' && currentStatus !== 'dibatalkan' ? `<button onclick="confirmUpdateStatus('${reservationId}', 'dibatalkan', '${escapeHtml(data.nama || 'pasien ini')}')" class="action-btn btn-batalkan"> <i class="fas fa-times"></i> Batalkan </button>` : ''}
                        <button onclick="deleteReservation('${reservationId}', '${escapeHtml(data.nama || 'ini')}')" class="action-btn btn-hapus"> <i class="fas fa-trash-alt"></i> Hapus </button>
                    </div>
                    ${timestampString ? `<p class="text-right text-xs mt-auto pt-2" style="color: var(--text-muted);">Didaftarkan: ${timestampString}</p>`: ''}
                </div>
            `;
            return card;
        }


        /** Menampilkan konfirmasi sebelum update status */
        function confirmUpdateStatus(reservationId, newStatus, patientName) {
            let title = 'Konfirmasi Perubahan Status';
            let text = `Yakin ingin mengubah status reservasi untuk <strong>${escapeHtml(patientName)}</strong> menjadi <strong>${newStatus}</strong>?`;
            let confirmButtonColor = getComputedStyle(document.documentElement).getPropertyValue('--info-color').trim();
            let icon = 'question';

            if (newStatus === 'checkin') { title = 'Konfirmasi Check-in'; text = `Check-in pasien <strong>${escapeHtml(patientName)}</strong>?`; confirmButtonColor = getComputedStyle(document.documentElement).getPropertyValue('--info-color').trim(); icon = 'info'; }
            else if (newStatus === 'selesai') { title = 'Konfirmasi Selesai'; text = `Tandai reservasi <strong>${escapeHtml(patientName)}</strong> sebagai selesai?`; confirmButtonColor = getComputedStyle(document.documentElement).getPropertyValue('--success-color').trim(); icon = 'success'; }
            else if (newStatus === 'dibatalkan') { title = 'Konfirmasi Pembatalan'; text = `Batalkan reservasi <strong>${escapeHtml(patientName)}</strong>?`; confirmButtonColor = getComputedStyle(document.documentElement).getPropertyValue('--warning-color').trim(); icon = 'warning'; }

            Swal.fire({
                title: title, html: text, icon: icon, showCancelButton: true,
                confirmButtonColor: confirmButtonColor,
                cancelButtonColor: getComputedStyle(document.documentElement).getPropertyValue('--text-muted').trim(),
                confirmButtonText: 'Ya, Lanjutkan!', cancelButtonText: 'Tidak',
                customClass: { popup: 'rounded-lg shadow-xl', title: 'text-lg font-semibold', confirmButton: 'action-btn', cancelButton: 'action-btn' }
            }).then((result) => { if (result.isConfirmed) { updateStatus(reservationId, newStatus); } });
        }

        /** Mengupdate status reservasi di Firebase */
        function updateStatus(reservationId, newStatus) {
            if (!firebaseDb) { showErrorMessage("Koneksi database belum siap."); return; }
            firebaseDb.ref(`reservasi/${reservationId}/status`).set(newStatus)
                .then(() => {
                    console.log(`Status ${reservationId} diubah menjadi ${newStatus}`);
                    Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: 'Status berhasil diubah!', showConfirmButton: false, timer: 1800, timerProgressBar: true, customClass: { popup: 'rounded-md shadow-lg' } });
                })
                .catch(error => {
                    console.error(`Gagal update status ${reservationId}:`, error);
                    showErrorMessage("Gagal mengupdate status reservasi.");
                    Swal.fire({ title: 'Gagal!', text: 'Tidak dapat mengubah status reservasi. Coba lagi nanti.', icon: 'error', customClass: { popup: 'rounded-lg shadow-xl' } });
                });
        }

        /** Menghapus reservasi dari Firebase */
        function deleteReservation(reservationId, patientName) {
            if (!firebaseDb) { showErrorMessage("Koneksi database belum siap."); return; }
            Swal.fire({
                title: 'Hapus Reservasi?', html: `Anda yakin ingin menghapus reservasi untuk <strong>${escapeHtml(patientName)}</strong>? Tindakan ini tidak dapat diurungkan.`,
                icon: 'warning',
                showCancelButton: true, confirmButtonColor: getComputedStyle(document.documentElement).getPropertyValue('--danger-color').trim(),
                cancelButtonColor: getComputedStyle(document.documentElement).getPropertyValue('--text-muted').trim(),
                confirmButtonText: 'Ya, Hapus!', cancelButtonText: 'Batal',
                customClass: { popup: 'rounded-lg shadow-xl', title: 'text-lg font-semibold', confirmButton: 'action-btn', cancelButton: 'action-btn' }
            }).then((result) => {
                if (result.isConfirmed) {
                    firebaseDb.ref(`reservasi/${reservationId}`).remove()
                        .then(() => {
                            console.log(`Reservasi ${reservationId} dihapus.`);
                            Swal.fire({ title: 'Dihapus!', text: 'Reservasi telah berhasil dihapus.', icon: 'success', customClass: { popup: 'rounded-lg shadow-xl' } });
                        })
                        .catch(error => {
                            console.error(`Gagal hapus ${reservationId}:`, error);
                            showErrorMessage("Gagal menghapus reservasi.");
                            Swal.fire({ title: 'Gagal!', text: 'Tidak dapat menghapus reservasi. Coba lagi nanti.', icon: 'error', customClass: { popup: 'rounded-lg shadow-xl' } });
                        });
                }
            });
        }

        /** Memfilter dan menampilkan data reservasi */
        function displayFilteredReservations() {
            if (!reservationListDiv) { console.error("#reservationList tidak ditemukan."); return; }
            showLoading(true);
            setTimeout(() => { // Jeda untuk feedback loading
                const reservations = Object.entries(allReservations || {});
                if (reservations.length === 0) {
                    reservationListDiv.innerHTML = '';
                    showNoReservations(true);
                    showLoading(false);
                    return;
                }

                reservationListDiv.innerHTML = '';
                let queueCounter = 0;
                let displayedCount = 0;
                let registrasiCountForCheckin = 0;

                const dataArray = reservations
                    .map(([key, value]) => {
                        if (value && typeof value === 'object') {
                            // Use timestamp for sorting if available, fallback to date/time
                            const sortableTimestamp = value.timestamp || new Date(`${value.tanggal || '01/01/1970'} ${value.waktu || '00:00'}`).getTime();
                            // Ensure tanggal is inYYYY-MM-DD for consistent Date parsing if timestamp is missing
                            const dateParts = value.tanggal ? value.tanggal.split('/') : ['01', '01', '1970'];
                            const formattedDate = `${dateParts[2]}-${dateParts[1]}-${dateParts[0]}`;
                            const sortableDateTime = new Date(`${formattedDate}T${value.waktu || '00:00'}`).getTime();

                            return [key, { ...value, sortableValue: value.timestamp ? sortableTimestamp : sortableDateTime }];
                        }
                        console.warn("Mengabaikan entri reservasi tidak valid:", key, value);
                        return [key, null];
                    })
                    .filter(entry => entry[1] !== null);

                const statusFilterToApply = document.querySelector('.status-filter-btn.active').getAttribute('data-status');

                let filteredData = dataArray.filter(([key, value]) => {
                    const itemStatus = (value.status || 'registrasi').toLowerCase();
                    // Updated filtering logic to include 'selesai'
                    const matchesStatusFilter = (statusFilterToApply === 'semua' || (statusFilterToApply === 'antrian' && itemStatus === 'registrasi') || itemStatus === statusFilterToApply);
                    return matchesStatusFilter;
                });

                // Sort logic: If 'semua' filter is active, sort by status order, otherwise sort by date/time
                if (statusFilterToApply === 'semua') {
                    const statusOrder = ['registrasi', 'checkin', 'selesai', 'dibatalkan'];
                    filteredData.sort(([, a], [, b]) => {
                        const statusA = (a.status || 'registrasi').toLowerCase();
                        const statusB = (b.status || 'registrasi').toLowerCase();
                        const orderA = statusOrder.indexOf(statusA);
                        const orderB = statusOrder.indexOf(statusB);

                        if (orderA < orderB) return -1;
                        if (orderA > orderB) return 1;

                        // If statuses are the same, sort by date/time (newest first for 'semua')
                        if (a.sortableValue < b.sortableValue) return 1;
                        if (a.sortableValue > b.sortableValue) return -1;
                        return 0;
                    });
                } else {
                    // Keep existing date/time sorting for other filters (oldest first for 'antrian', 'checkin', 'dibatalkan')
                    filteredData.sort(([, a], [, b]) => {
                        if (a.sortableValue < b.sortableValue) return -1;
                        if (a.sortableValue > b.sortableValue) return 1;
                        return 0;
                    });
                }


                filteredData.forEach(([key, value]) => {
                    const itemStatus = (value.status || 'registrasi').toLowerCase();
                    // Only count for queue number if status is 'registrasi' or 'checkin' AND the filter is 'antrian' or 'checkin' or 'semua'
                    // Queue number should reset based on the *filtered* list, not the overall list.
                    // Let's refine queue numbering to be simpler - just a sequential number for the *displayed* items.
                    queueCounter++; // Simple sequential numbering for displayed items

                    let canCheckIn = false;
                    if (itemStatus === 'registrasi') {
                        registrasiCountForCheckin++;
                        if (registrasiCountForCheckin <= 3) { canCheckIn = true; }
                    }
                    const cardElement = createReservationCard(key, value, queueCounter, canCheckIn);
                    reservationListDiv.appendChild(cardElement);
                    displayedCount++;
                });
                showNoReservations(displayedCount === 0);
                showLoading(false);
            }, 100);
        }


        /** Memulai listener untuk perubahan data reservasi */
        function listenReservations() {
            if (!firebaseDb) {
                showErrorMessage("Koneksi database Firebase belum siap untuk mendengarkan data.");
                showLoading(false);
                return;
            }
            const reservationsRef = firebaseDb.ref('reservasi');
            reservationsRef.on('value', (snapshot) => {
                hideErrorMessage();
                allReservations = snapshot.val() || {};
                console.log("Data reservasi diterima/diperbarui:", Object.keys(allReservations).length + " item");
                displayFilteredReservations();
                // Also trigger update for patient history if it's currently visible
                if (!patientHistorySection.classList.contains('hidden')) {
                    loadAndDisplayPatientHistory();
                }
            }, (error) => {
                console.error("Error saat mendengarkan data reservasi:", error);
                showErrorMessage(`Gagal memuat data reservasi secara real-time: ${error.message}`);
                showLoading(false);
                allReservations = {};
                displayFilteredReservations();
            });
        }

        // --- Fungsi Firebase & Auth ---
        /** Mengambil konfigurasi Firebase dari API backend */
        async function fetchFirebaseConfig() {
            try {
                const response = await fetch('/api/firebase-config');
                if (!response.ok) throw new Error(`Network response was not ok: ${response.status} ${response.statusText}`);
                console.log("Konfigurasi Firebase berhasil diambil dari API.");
                return await response.json();
            } catch (error) {
                console.error("Error fetching Firebase config:", error);
                showErrorMessage(`Gagal memuat konfigurasi Firebase: ${error.message}. Pastikan API backend berjalan.`);
                return null;
            }
        }

        /** Menginisialisasi Firebase */
        function initializeFirebase(config) {
            if (!config) {
                console.error("Konfigurasi Firebase tidak valid.");
                return false;
            }
            try {
                if (typeof firebase === 'undefined' || typeof firebase.initializeApp === 'undefined') {
                    throw new Error("Firebase SDK belum dimuat.");
                }
                if (!firebase.apps.length) {
                    firebaseApp = firebase.initializeApp(config);
                    console.log("Firebase App diinisialisasi.");
                } else {
                    firebaseApp = firebase.app();
                    console.log("Menggunakan instance Firebase App yang sudah ada.");
                }
                firebaseAuth = firebase.auth();
                firebaseDb = firebase.database();
                console.log("Firebase Auth dan Database instance didapatkan.");
                return true;
            } catch (error) {
                console.error("Gagal inisialisasi Firebase:", error);
                showErrorMessage(`Gagal inisialisasi Firebase: ${error.message}`);
                return false;
            }
        }

        /** Fungsi Logout Pengguna */
        window.logoutUser = function() {
            if (firebaseAuth && firebaseAuth.currentUser) {
                firebaseAuth.signOut().then(() => {
                    console.log("Logout berhasil.");
                    window.location.href = 'login.html';
                }).catch((error) => {
                    console.error("Error logout:", error);
                    Swal.fire('Error', 'Gagal logout: ' + error.message, 'error');
                });
            } else {
                console.log("Tidak ada pengguna yang login, redirect ke login.");
                window.location.href = 'login.html';
            }
        }

        // --- Fungsi Tema ---
        /** Menerapkan tema terang/gelap */
        function applyTheme(theme) {
            if (theme === 'dark') { document.documentElement.classList.add('dark'); themeToggleLightIcon.classList.remove('hidden'); themeToggleDarkIcon.classList.add('hidden'); }
            else { document.documentElement.classList.remove('dark'); themeToggleLightIcon.classList.add('hidden'); themeToggleDarkIcon.classList.remove('hidden'); }
        }
        /** Mengganti tema dan menyimpannya */
        function toggleTheme() {
            const currentTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            localStorage.setItem('theme', newTheme);
            applyTheme(newTheme);
            console.log(`Tema diubah ke: ${newTheme}`);
        }
        /** Menginisialisasi tema saat halaman dimuat */
        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme');
            const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (savedTheme) { applyTheme(savedTheme); }
            else if (systemPrefersDark) { applyTheme('dark'); }
            else { applyTheme('light'); }
        }

        // --- Fungsi CRUD Rumah Sakit ---

        /** Memuat dan menampilkan daftar rumah sakit di dalam modal */
        async function loadAndDisplayHospitals() {
            if (!firebaseDb) { console.error("Database belum siap untuk memuat RS."); hospitalListTableBody.innerHTML = `<tr><td colspan="3" class="text-center py-4 text-red-500">Koneksi database gagal.</td></tr>`; noHospitalDataMsg.classList.add('hidden'); return; }
            if (!hospitalListTableBody || !noHospitalDataMsg) { console.error("Elemen tabel RS atau pesan 'no data' tidak ditemukan."); return; }

            hospitalListTableBody.innerHTML = `<tr><td colspan="3" class="text-center py-4 italic" style="color: var(--text-muted);">Memuat data rumah sakit...</td></tr>`;
            noHospitalDataMsg.classList.add('hidden');

            const hospitalRef = firebaseDb.ref('daftar_rumah_sakit'); // Path ke data RS

            try {
                const snapshot = await hospitalRef.once('value');
                hospitalListTableBody.innerHTML = ''; // Kosongkan tabel

                if (snapshot.exists()) {
                    let hospitalsExist = false;
                    const hospitalsArray = [];
                    snapshot.forEach((childSnapshot) => {
                            hospitalsExist = true;
                            const hospitalId = childSnapshot.key;
                            const hospitalData = childSnapshot.val();
                            if (hospitalData && typeof hospitalData === 'object') {
                                hospitalsArray.push({ id: hospitalId, ...hospitalData });
                            } else {
                                console.warn("Mengabaikan entri rumah sakit tidak valid:", hospitalId, hospitalData);
                            }
                    });

                    hospitalsArray.sort((a, b) => {
                            const nameA = (a.nama || '').toLowerCase();
                            const nameB = (b.nama || '').toLowerCase();
                            if (nameA < nameB) return -1;
                            if (nameA > nameB) return 1;
                            return 0;
                    });


                    hospitalsArray.forEach(hospital => {
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td>${escapeHtml(hospital.nama || '-')}</td>
                                <td>${escapeHtml(hospital.singkatan || '-')}</td>
                                <td class="text-right action-buttons whitespace-nowrap">
                                    <button onclick="editHospital('${hospital.id}', '${escapeHtml(hospital.nama || '')}', '${escapeHtml(hospital.singkatan || '')}')" class="action-btn btn-checkin" title="Edit">
                                        <i class="fas fa-pencil-alt !mr-0"></i>
                                    </button>
                                    <button onclick="confirmDeleteHospital('${hospital.id}', '${escapeHtml(hospital.nama || '')}')" class="action-btn btn-hapus" title="Hapus">
                                        <i class="fas fa-trash-alt !mr-0"></i>
                                    </button>
                                </td>
                            `;
                            hospitalListTableBody.appendChild(tr);
                    });

                    noHospitalDataMsg.classList.toggle('hidden', hospitalsArray.length > 0); // Toggle berdasarkan jumlah data
                } else {
                    noHospitalDataMsg.classList.remove('hidden');
                }
            } catch (error) {
                console.error("Gagal memuat daftar rumah sakit:", error);
                hospitalListTableBody.innerHTML = `<tr><td colspan="3" class="text-center py-4 text-red-500">Koneksi database gagal.</td></tr>`;
                noHospitalDataMsg.classList.add('hidden');
                    Swal.fire('Error', 'Gagal memuat daftar rumah sakit.', 'error');
            }
        }

        /** Menyiapkan form untuk mode edit */
        window.editHospital = (id, name, abbr) => {
            console.log(`Menyiapkan edit untuk RS ID: ${id}`);
            hospitalEditIdInput.value = id;
            hospitalNameInput.value = name;
            hospitalAbbrInput.value = abbr;
            hospitalFormTitle.textContent = "Edit Rumah Sakit";
            hospitalSubmitBtn.innerHTML = `<i class="fas fa-save mr-2"></i> Simpan Perubahan`;
            hospitalSubmitBtn.classList.remove('btn-tambah');
            hospitalSubmitBtn.classList.add('btn-simpan');
            cancelHospitalEditBtn.classList.remove('hidden');
            hospitalNameInput.focus();
            hospitalCrudForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        /** Mereset form ke mode tambah */
        function resetHospitalForm() {
            console.log("Mereset form RS ke mode tambah.");
            if (hospitalCrudForm) hospitalCrudForm.reset();
            if (hospitalEditIdInput) hospitalEditIdInput.value = '';
            if (hospitalFormTitle) hospitalFormTitle.textContent = "Tambah Rumah Sakit Baru";
            if (hospitalSubmitBtn) {
                hospitalSubmitBtn.innerHTML = `<i class="fas fa-plus mr-2"></i> Tambah RS`;
                hospitalSubmitBtn.classList.remove('btn-simpan');
                hospitalSubmitBtn.classList.add('btn-tambah');
            }
            if (cancelHospitalEditBtn) cancelHospitalEditBtn.classList.add('hidden');
        }

        /** Menangani submit form tambah/edit rumah sakit */
        async function handleHospitalFormSubmit(event) {
            event.preventDefault();
            const hospitalId = hospitalEditIdInput.value;
            const hospitalName = hospitalNameInput.value.trim();
            const hospitalAbbr = hospitalAbbrInput.value.trim();

            if (!hospitalName || !hospitalAbbr) { Swal.fire('Input Tidak Lengkap', 'Harap isi Nama Lengkap dan Singkatan.', 'warning'); return; }
            if (!firebaseDb) { Swal.fire('Error Koneksi', 'Koneksi database belum siap.', 'error'); return; }

            hospitalSubmitBtn.disabled = true;
            hospitalSubmitBtn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> Menyimpan...`;

            const hospitalData = { nama: hospitalName, singkatan: hospitalAbbr };

            try {
                let operationPromise;
                let successMessage;

                if (hospitalId) { // Mode Edit
                    operationPromise = firebaseDb.ref(`daftar_rumah_sakit/${hospitalId}`).update(hospitalData);
                    successMessage = `Rumah sakit "${hospitalName}" berhasil diperbarui.`;
                } else { // Mode Tambah
                    operationPromise = firebaseDb.ref('daftar_rumah_sakit').push(hospitalData);
                    successMessage = `Rumah sakit "${hospitalName}" berhasil ditambahkan.`;
                }

                await operationPromise;
                Swal.fire('Berhasil!', successMessage, 'success');
                resetHospitalForm();
                await loadAndDisplayHospitals(); // Muat ulang daftar

            } catch (error) {
                console.error("Gagal menyimpan data rumah sakit:", error);
                Swal.fire('Gagal!', `Terjadi kesalahan: ${error.message}`, 'error');
            } finally {
                hospitalSubmitBtn.disabled = false;
                    if (hospitalEditIdInput.value) {
                        hospitalSubmitBtn.innerHTML = `<i class="fas fa-save mr-2"></i> Simpan Perubahan`;
                    } else {
                        hospitalSubmitBtn.innerHTML = `<i class="fas fa-plus mr-2"></i> Tambah RS`;
                    }
            }
        }

        /** Konfirmasi sebelum menghapus rumah sakit */
        window.confirmDeleteHospital = (id, name) => {
             if (!firebaseDb) { Swal.fire('Error Koneksi', 'Koneksi database belum siap.', 'error'); return; }
             Swal.fire({
                 title: 'Hapus Rumah Sakit?',
                 html: `Anda yakin ingin menghapus <strong>${escapeHtml(name)}</strong>? Tindakan ini tidak dapat diurungkan.`,
                 icon: 'warning', showCancelButton: true,
                 confirmButtonColor: getComputedStyle(document.documentElement).getPropertyValue('--danger-color').trim(),
                 cancelButtonColor: getComputedStyle(document.documentElement).getPropertyValue('--text-muted').trim(),
                 confirmButtonText: 'Ya, Hapus!', cancelButtonText: 'Batal'
             }).then(async (result) => {
                 if (result.isConfirmed) {
                     console.log(`Menghapus RS ID: ${id}`);
                     try {
                         await firebaseDb.ref(`daftar_rumah_sakit/${id}`).remove();
                         Swal.fire('Dihapus!', `Rumah sakit "${escapeHtml(name)}" telah dihapus.`, 'success');
                         await loadAndDisplayHospitals();
                         if (hospitalEditIdInput.value === id) { // Jika yang dihapus sedang diedit
                             resetHospitalForm();
                             }
                     } catch (error) {
                             console.error(`Gagal menghapus RS ID ${id}:`, error);
                             Swal.fire('Gagal!', `Gagal menghapus rumah sakit: ${error.message}`, 'error');
                     }
                 }
             });
         }


        // --- Fungsi Histori Deteksi ---

        /** Memuat dan menampilkan data histori deteksi di dalam tabel inline */
        async function loadAndDisplayDetectionHistory() {
            if (!firebaseDb) { console.error("Database belum siap untuk memuat histori deteksi."); detectionHistoryTableBody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-red-500">Koneksi database gagal.</td></tr>`; noDetectionHistoryDataMsg.classList.add('hidden'); return; }
            if (!detectionHistoryTableBody || !noDetectionHistoryDataMsg) { console.error("Elemen tabel histori deteksi atau pesan 'no data' tidak ditemukan."); return; }

            detectionHistoryTableBody.innerHTML = `<tr><td colspan="4" class="text-center py-4 italic loading-message" style="color: var(--text-muted);"><i class="fas fa-spinner animate-spin-slow mr-2"></i> Memuat data histori...</td></tr>`;
            noDetectionHistoryDataMsg.classList.add('hidden');

            const historyRef = firebaseDb.ref('deteksiPenyakit'); // Path ke data histori deteksi

            try {
                const snapshot = await historyRef.once('value');
                detectionHistoryTableBody.innerHTML = ''; // Kosongkan tabel

                if (snapshot.exists()) {
                    let historyExists = false;
                    const historyDataArray = [];
                    snapshot.forEach((childSnapshot) => {
                            historyExists = true;
                            const entry = childSnapshot.val();
                            if (entry && entry.timestamp) {
                                historyDataArray.push({
                                    id: childSnapshot.key,
                                    timestamp: entry.timestamp,
                                    inputText: entry.inputText || 'Tidak ada input teks',
                                    hasil: entry.hasil || [], // Keep 'hasil' as it contains the structured diagnosis
                                    gejala: entry.gejala || [] // Assuming 'gejala' might also be stored separately or is part of 'hasil'
                                });
                            } else {
                                console.warn("Mengabaikan entri histori deteksi tidak valid:", childSnapshot.key, entry);
                            }
                    });

                    historyDataArray.sort((a, b) => {
                            const parseDate = (dateStr) => {
                                if (!dateStr) return new Date(0);
                                const parts = dateStr.split('/');
                                if (parts.length === 3) {
                                    const [day, month, year] = parts.map(Number);
                                    return new Date(year, month - 1, day);
                                }
                                const dateObj = new Date(dateStr);
                                return isNaN(dateObj.getTime()) ? new Date(0) : dateObj;
                            };

                            const dateA = parseDate(a.timestamp);
                            const dateB = parseDate(b.timestamp);

                            if (dateA < dateB) return 1; // Sort descending by date
                            if (dateA > dateB) return -1;
                            if (a.id < b.id) return -1;
                            if (a.id > b.id) return 1;
                            return 0;
                    });


                    historyDataArray.forEach(entry => {
                            const tr = document.createElement('tr');

                            let displayTimestamp = entry.timestamp || '-';
                            try {
                                    const dateObj = new Date(entry.timestamp);
                                    if (!isNaN(dateObj.getTime())) {
                                        displayTimestamp = dateObj.toLocaleString('id-ID', { day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit', hour12: false });
                                    }
                            } catch(e) {
                                    console.warn("Gagal format timestamp histori:", entry.timestamp, e);
                                    displayTimestamp = entry.timestamp || '-';
                            }

                            // Use getDiagnosisText for the 'Hasil Deteksi' column
                            const diagnosisText = getDiagnosisText(entry.hasil);

                            // Extract gejala specifically for the 'Gejala Terdeteksi' column
                            // Assuming gejala might be a separate array or part of the 'hasil' objects
                            const gejalaText = entry.gejala && Array.isArray(entry.gejala) && entry.gejala.length > 0
                                    ? entry.gejala.join(', ')
                                    : (entry.hasil && Array.isArray(entry.hasil) && entry.hasil.length > 0
                                        ? entry.hasil.flatMap(item => Array.isArray(item.gejala) ? item.gejala : []).filter(g => g).join(', ')
                                        : 'Tidak terdeteksi');


                            tr.innerHTML = `
                                <td>${escapeHtml(displayTimestamp)}</td>
                                <td><pre class="whitespace-pre-wrap">${escapeHtml(entry.inputText)}</pre></td>
                                <td><pre class="whitespace-pre-wrap">${escapeHtml(diagnosisText)}</pre></td>
                                <td><pre class="whitespace-pre-wrap">${escapeHtml(gejalaText)}</pre></td>
                            `;
                            detectionHistoryTableBody.appendChild(tr);
                    });

                    noDetectionHistoryDataMsg.classList.toggle('hidden', historyDataArray.length > 0);
                } else {
                    noDetectionHistoryDataMsg.classList.remove('hidden');
                }
            } catch (error) {
                console.error("Gagal memuat data histori deteksi:", error);
                detectionHistoryTableBody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-red-500">Gagal memuat data histori. Coba lagi nanti.</td></tr>`;
                noDetectionHistoryDataMsg.classList.add('hidden');
                    Swal.fire('Error', 'Gagal memuat histori deteksi.', 'error');
            }
        }

        // --- Fungsi Histori Pasien (NEW) ---
        /** Memuat dan menampilkan data histori pasien (reservasi) di dalam tabel inline */
        async function loadAndDisplayPatientHistory() {
            if (!firebaseDb) { console.error("Database belum siap untuk memuat histori pasien."); patientHistoryTableBody.innerHTML = `<tr><td colspan="8" class="text-center py-4 text-red-500">Koneksi database gagal.</td></tr>`; noPatientHistoryDataMsg.classList.add('hidden'); return; }
            if (!patientHistoryTableBody || !noPatientHistoryDataMsg) { console.error("Elemen tabel histori pasien atau pesan 'no data' tidak ditemukan."); return; }

            patientHistoryTableBody.innerHTML = `<tr><td colspan="8" class="text-center py-4 italic loading-message" style="color: var(--text-muted);"><i class="fas fa-spinner animate-spin-slow mr-2"></i> Memuat data histori pasien...</td></tr>`;
            noPatientHistoryDataMsg.classList.add('hidden');

            // Use the already loaded allReservations data
            const reservations = Object.entries(allReservations || {});

            try {
                patientHistoryTableBody.innerHTML = ''; // Clear loading message

                if (reservations.length > 0) {
                    const patientHistoryArray = reservations
                        .map(([key, value]) => {
                            if (value && typeof value === 'object') {
                                // Ensure tanggal is in YYYY-MM-DD for consistent Date parsing
                                const dateParts = value.tanggal ? value.tanggal.split('/') : ['01', '01', '1970'];
                                const formattedDate = `${dateParts[2]}-${dateParts[1]}-${dateParts[0]}`;
                                const sortableDateTime = new Date(`${formattedDate}T${value.waktu || '00:00'}`).getTime();

                                return {
                                    id: key,
                                    nama: value.nama || 'Tidak Dikenal',
                                    telepon: value.telepon || '-',
                                    rumah_sakit: value.rumah_sakit || 'Tidak diketahui',
                                    dokter_nama: value.dokter_nama || '-',
                                    tanggal: value.tanggal || '-',
                                    waktu: value.waktu || '-',
                                    status: value.status || 'registrasi',
                                    diagnosis: value.diagnosis, // Use existing diagnosis function
                                    sortableValue: sortableDateTime
                                };
                            }
                            console.warn("Mengabaikan entri reservasi tidak valid untuk histori pasien:", key, value);
                            return null;
                        })
                        .filter(entry => entry !== null);

                    // Sort by patient name, then by reservation date (newest first)
                    patientHistoryArray.sort((a, b) => {
                        const nameCompare = a.nama.localeCompare(b.nama);
                        if (nameCompare !== 0) return nameCompare;
                        return b.sortableValue - a.sortableValue; // Newest first
                    });

                    patientHistoryArray.forEach(entry => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${escapeHtml(entry.nama)}</td>
                            <td>${escapeHtml(entry.telepon)}</td>
                            <td>${escapeHtml(entry.rumah_sakit)}</td>
                            <td>${escapeHtml(entry.dokter_nama)}</td>
                            <td>${escapeHtml(entry.tanggal)}</td>
                            <td>${escapeHtml(entry.waktu)}</td>
                            <td>${escapeHtml(entry.status)}</td>
                            <td><pre class="whitespace-pre-wrap">${escapeHtml(entry.diagnosis)}</pre></td>
                        `;
                        patientHistoryTableBody.appendChild(tr);
                    });

                    noPatientHistoryDataMsg.classList.toggle('hidden', patientHistoryArray.length > 0);
                } else {
                    noPatientHistoryDataMsg.classList.remove('hidden');
                }
            } catch (error) {
                console.error("Gagal memuat data histori pasien:", error);
                patientHistoryTableBody.innerHTML = `<tr><td colspan="8" class="text-center py-4 text-red-500">Gagal memuat data histori pasien. Coba lagi nanti.</td></tr>`;
                noPatientHistoryDataMsg.classList.add('hidden');
                Swal.fire('Error', 'Gagal memuat histori pasien.', 'error');
            }
        }


        // --- Fungsi Pengaturan Tampilan Bagian Utama ---
        /** Menampilkan bagian Reservasi dan menyembunyikan bagian Histori Deteksi dan Histori Pasien */
        function showReservationSection() {
            if (reservationSection && detectionHistorySection && patientHistorySection) {
                reservationSection.classList.remove('hidden');
                detectionHistorySection.classList.add('hidden');
                patientHistorySection.classList.add('hidden'); // Hide patient history
                console.log("Showing Reservation Section, hiding History Sections.");
                displayFilteredReservations();
            }
        }

        /** Menampilkan bagian Histori Deteksi dan menyembunyikan bagian Reservasi dan Histori Pasien */
        function showDetectionHistorySection() {
             if (reservationSection && detectionHistorySection && patientHistorySection) {
                 reservationSection.classList.add('hidden');
                 detectionHistorySection.classList.remove('hidden');
                 patientHistorySection.classList.add('hidden'); // Hide patient history
                 console.log("Showing History Section, hiding Reservation and Patient History Sections.");
                 loadAndDisplayDetectionHistory();
             }
        }

        /** Menampilkan bagian Histori Pasien dan menyembunyikan bagian Reservasi dan Histori Deteksi */
        function showPatientHistorySection() { // NEW
            if (reservationSection && detectionHistorySection && patientHistorySection) {
                reservationSection.classList.add('hidden');
                detectionHistorySection.classList.add('hidden');
                patientHistorySection.classList.remove('hidden'); // Show patient history
                console.log("Showing Patient History Section, hiding other sections.");
                loadAndDisplayPatientHistory();
            }
        }


        // --- Event Listener UI ---

        /** Event Listener untuk Tombol Filter Status */
        function addStatusFilterListeners() {
             statusFilterButtons = document.querySelectorAll('.status-filter-btn'); // Get buttons after DOM is ready
             statusFilterButtons.forEach(button => {
                 button.addEventListener('click', () => {
                     showReservationSection(); // Always show reservation section for status filters

                     statusFilterButtons.forEach(btn => btn.classList.remove('active'));
                     button.classList.add('active');
                     console.log(`Filter status diubah menjadi: ${button.getAttribute('data-status')}. Displaying reservations.`);
                     displayFilteredReservations();
                 });
             });
        }


        /** Event Listener untuk Tombol Tema */
        if (themeToggleButton) {
            themeToggleButton.addEventListener('click', toggleTheme);
        } else {
             console.warn("Tombol tema tidak ditemukan.");
        }

        /** Event Listener dan Logika untuk Toggle Sidebar */
        if (sidebarToggleBtn && filterSidebar && mainContent) {
            sidebarToggleBtn.addEventListener('click', () => {
                const isMobile = window.innerWidth < 768;

                if (isMobile) {
                    // Logika toggle hanya untuk mobile
                    filterSidebar.classList.toggle('open-mobile');
                    sidebarOverlay.classList.toggle('hidden');
                    document.body.classList.toggle('overflow-hidden-custom');
                    console.log("Sidebar toggled (Mobile). Open:", filterSidebar.classList.contains('open-mobile'));
                } else {
                    // Di desktop, toggle kelas collapsed pada sidebar
                    filterSidebar.classList.toggle('collapsed');
                    // Toggle kelas sidebar-collapsed-desktop pada mainContent
                    // Note: mainContent's margin is now controlled by CSS selector #filterSidebar.collapsed + main
                    // So, no direct class toggle on mainContent needed here.
                    console.log("Sidebar toggled (Desktop). Collapsed:", filterSidebar.classList.contains('collapsed'));
                }
            });

            if (sidebarOverlay) {
                sidebarOverlay.addEventListener('click', () => {
                     if (window.innerWidth < 768) {
                         filterSidebar.classList.remove('open-mobile');
                         sidebarOverlay.classList.add('hidden');
                         document.body.classList.remove('overflow-hidden-custom');
                         console.log("Mobile sidebar closed via overlay click.");
                     }
                    });
            }
        } else {
            console.warn("Elemen penting untuk toggle sidebar tidak ditemukan.");
        }

        // --- Modal RS Event Listeners ---
        /** Membuka modal CRUD RS */
        function openHospitalCrudModal() {
            if (hospitalCrudModal) {
                hospitalCrudModal.classList.add('active');
                document.body.classList.add('overflow-hidden-custom');
                console.log("Modal CRUD RS dibuka.");
                loadAndDisplayHospitals(); // Muat daftar RS saat modal dibuka
                resetHospitalForm(); // Pastikan form dalam mode tambah saat dibuka
            } else {
                console.error("Elemen modal #hospitalCrudModal tidak ditemukan.");
            }
        }

        /** Menutup modal CRUD RS */
        function closeHospitalCrudModal() {
            if (hospitalCrudModal) {
                 hospitalCrudModal.classList.remove('active');
                 document.body.classList.remove('overflow-hidden-custom');
                 console.log("Modal CRUD RS ditutup.");
            }
        }

        // Listener untuk tombol buka modal RS
        if (openHospitalCrudModalBtn) {
            openHospitalCrudModalBtn.addEventListener('click', openHospitalCrudModal);
        } else {
             console.warn("Tombol #openHospitalCrudModalBtn tidak ditemukan.");
        }

        // Listener untuk tombol close (X) di modal RS
        if (closeHospitalCrudModalBtn) {
            closeHospitalCrudModalBtn.addEventListener('click', closeHospitalCrudModal);
        }

        // Listener untuk tombol batal di form modal RS
        if (cancelHospitalEditBtn) {
             cancelHospitalEditBtn.addEventListener('click', resetHospitalForm);
        }

        // Listener untuk klik overlay modal RS
        if (hospitalModalOverlay) {
            hospitalModalOverlay.addEventListener('click', closeHospitalCrudModal);
        }

        // Listener untuk submit form CRUD RS
        if (hospitalCrudForm) {
            hospitalCrudForm.addEventListener('submit', handleHospitalFormSubmit);
        } else {
             console.warn("Form #hospitalCrudForm di dalam modal tidak ditemukan.");
        }

        // --- Modal Dokter Event Listeners (BARU) ---

        /** Membuka modal CRUD Dokter */
        function openDoctorCrudModal() {
            if (doctorCrudModal) {
                doctorCrudModal.classList.add('active');
                document.body.classList.add('overflow-hidden-custom');
                console.log("Modal CRUD Dokter dibuka.");
                populateHospitalSelect(); // Muat ulang dropdown RS di form dokter
                loadAndDisplayDoctors(); // Muat daftar dokter saat modal dibuka
                resetDoctorForm(); // Pastikan form dalam mode tambah saat dibuka
            } else {
                console.error("Elemen modal #doctorCrudModal tidak ditemukan.");
            }
        }

        /** Menutup modal CRUD Dokter */
        function closeDoctorCrudModal() {
            if (doctorCrudModal) {
                doctorCrudModal.classList.remove('active');
                document.body.classList.remove('overflow-hidden-custom');
                console.log("Modal CRUD Dokter ditutup.");
            }
        }

        // Listener untuk tombol buka modal Dokter
        if (openDoctorCrudModalBtn) {
            openDoctorCrudModalBtn.addEventListener('click', openDoctorCrudModal);
        } else {
            console.warn("Tombol #openDoctorCrudModalBtn tidak ditemukan.");
        }

        // Listener untuk tombol close (X) di modal Dokter
        if (closeDoctorCrudModalBtn) {
            closeDoctorCrudModalBtn.addEventListener('click', closeDoctorCrudModal);
        }

        // Listener untuk tombol batal di form modal Dokter
        if (cancelDoctorEditBtn) {
            cancelDoctorEditBtn.addEventListener('click', resetDoctorForm);
        }

        // Listener untuk klik overlay modal Dokter
        if (doctorModalOverlay) {
            doctorModalOverlay.addEventListener('click', closeDoctorCrudModal);
        }

        // Listener untuk submit form CRUD Dokter
        if (doctorCrudForm) {
            doctorCrudForm.addEventListener('submit', handleDoctorFormSubmit);
        } else {
            console.warn("Form #doctorCrudForm di dalam modal tidak ditemukan.");
        }


        // --- Fungsi CRUD Dokter (diadaptasi untuk modal) ---

        /**
         * Populates the hospital select dropdown from Firebase Realtime Database.
         */
        async function populateHospitalSelect() {
            if (!firebaseDb) { console.error("Database belum siap untuk mengisi dropdown RS."); return; }
            if (!doctorHospitalSelect) { console.error("Elemen #doctorHospitalSelect tidak ditemukan."); return; }

            // Show loading state
            doctorHospitalSelect.innerHTML = '<option value="">-- Memuat Rumah Sakit --</option>';
            doctorHospitalSelect.disabled = true; // Disable while loading

            const hospitalRef = firebaseDb.ref('daftar_rumah_sakit');

            try {
                const snapshot = await hospitalRef.once('value');
                // Clear previous options and add default
                doctorHospitalSelect.innerHTML = '<option value="">-- Pilih Rumah Sakit --</option>';
                doctorHospitalSelect.disabled = false; // Enable after loading

                if (snapshot.exists()) {
                    snapshot.forEach((childSnapshot) => {
                        const hospitalId = childSnapshot.key;
                        const hospitalData = childSnapshot.val();
                        const option = document.createElement('option');
                        option.value = hospitalId;
                        // Use nama or singkatan, fallback to key if needed
                        option.textContent = escapeHtml(hospitalData.nama || hospitalData.singkatan || hospitalId);
                        doctorHospitalSelect.appendChild(option);
                    });
                } else {
                    // No hospitals found
                    const option = document.createElement('option');
                    option.value = "";
                    option.textContent = "-- Tidak ada Rumah Sakit tersedia --";
                    doctorHospitalSelect.appendChild(option);
                    doctorHospitalSelect.disabled = true; // Keep disabled if no options
                }
            } catch (error) {
                console.error("Gagal memuat daftar rumah sakit untuk dropdown:", error);
                doctorHospitalSelect.innerHTML = '<option value="">-- Gagal memuat RS --</option>';
                doctorHospitalSelect.disabled = true; // Keep disabled on error
                Swal.fire('Error', 'Gagal memuat daftar rumah sakit untuk pilihan dokter.', 'error');
            }
        }

        /**
         * Loads and displays the list of doctors from Firebase Realtime Database.
         * Doctors are stored using their Auth UID as the key.
         */
        async function loadAndDisplayDoctors() {
            // Adjusted colspan to 7 because we implicitly link to Auth UID
            if (!firebaseDb) { console.error("Database belum siap untuk memuat dokter."); doctorListTableBody.innerHTML = `<tr><td colspan="7" class="text-center py-4 italic" style="color: var(--text-muted);">Memuat data dokter...</td></tr>`; noDoctorDataMsg.classList.add('hidden'); return; }
            if (!doctorListTableBody || !noDoctorDataMsg) { console.error("Elemen tabel dokter atau pesan 'no data' tidak ditemukan."); return; }

            // Show loading state in table
            doctorListTableBody.innerHTML = `<tr><td colspan="7" class="text-center py-4 italic" style="color: var(--text-muted);">Memuat data dokter...</td></tr>`; // Adjusted colspan
            noDoctorDataMsg.classList.add('hidden'); // Hide "no data" message

            // Doctors are now stored under 'daftar_dokter' using UID as key
            const doctorsRef = firebaseDb.ref('daftar_dokter');

            try {
                const snapshot = await doctorsRef.once('value');
                doctorListTableBody.innerHTML = ''; // Clear loading message

                if (snapshot.exists()) {
                    let doctorsExist = false;
                    const doctorsArray = [];
                    snapshot.forEach((childSnapshot) => {
                        doctorsExist = true;
                        const doctorUid = childSnapshot.key; // The key is the UID
                        const doctorData = childSnapshot.val();
                        if (doctorData && typeof doctorData === 'object') {
                            doctorsArray.push({ id: doctorUid, ...doctorData });
                        } else {
                            console.warn("Mengabaikan entri dokter tidak valid:", doctorUid, doctorData);
                        }
                    });

                    // Sort doctors by name
                    doctorsArray.sort((a, b) => {
                        const nameA = (a.nama || '').toLowerCase();
                        const nameB = (b.nama || '').toLowerCase();
                        if (nameA < nameB) return -1;
                        if (nameA > nameB) return 1;
                        return 0;
                    });


                    doctorsArray.forEach(doctor => {
                        const tr = document.createElement('tr');
                        // Pass the UID to the editDoctor function
                        tr.innerHTML = `
                            <td>${escapeHtml(doctor.nama)}</td>
                            <td>${escapeHtml(doctor.spesialisasi)}</td>
                            <td>${escapeHtml(doctor.rumah_sakit_nama || 'Tidak diketahui')}</td>
                            <td>${escapeHtml(doctor.hari_praktik || '-')}</td>
                            <td>${escapeHtml(doctor.jam_mulai || '-')}</td>
                            <td>${escapeHtml(doctor.jam_selesai || '-')}</td>
                            <td class="text-right action-buttons whitespace-nowrap">
                                <button onclick="editDoctor('${doctor.id}', '${escapeHtml(doctor.nama)}', '${escapeHtml(doctor.spesialisasi)}', '${escapeHtml(doctor.rumah_sakit_id)}', '${escapeHtml(doctor.hari_praktik || '')}', '${escapeHtml(doctor.jam_mulai || '')}', '${escapeHtml(doctor.jam_selesai || '')}', '${doctor.id}')" class="action-btn btn-checkin" title="Edit">
                                    <i class="fas fa-pencil-alt !mr-0"></i>
                                </button>
                                <button onclick="confirmDeleteDoctor('${doctor.id}', '${escapeHtml(doctor.nama)}')" class="action-btn btn-hapus" title="Hapus">
                                    <i class="fas fa-trash-alt !mr-0"></i>
                                </button>
                            </td>
                        `;
                        doctorListTableBody.appendChild(tr);
                    });
                    // Show/hide "no data" message based on whether any doctors were found
                    noDoctorDataMsg.classList.toggle('hidden', doctorsArray.length > 0);
                } else {
                    // No doctors found
                    noDoctorDataMsg.classList.remove('hidden');
                }
            } catch (error) {
                console.error("Gagal memuat daftar dokter:", error);
                doctorListTableBody.innerHTML = `<tr><td colspan="7" class="text-center py-4 text-red-500">Gagal memuat data. Coba lagi nanti.</td></tr>`; // Adjusted colspan
                noDoctorDataMsg.classList.add('hidden'); // Hide "no data" message on error
                Swal.fire('Error', 'Gagal memuat daftar dokter.', 'error');
            }
        }

        /**
         * Populates the form for editing an existing doctor.
         * @param {string} id - The Realtime Database key (which is the UID) of the doctor.
         * @param {string} nama - Doctor's name.
         * @param {string} spesialisasi - Doctor's specialization.
         * @param {string} rumah_sakit_id - The ID of the associated hospital.
         * @param {string} hari_praktik - Practice days.
         * @param {string} jam_mulai - Start time.
         * @param {string} jam_selesai - End time.
         * @param {string} uid - The Firebase Auth UID associated with the doctor (same as id).
         */
        window.editDoctor = (id, nama, spesialisasi, rumah_sakit_id, hari_praktik, jam_mulai, jam_selesai, uid) => {
            console.log(`Menyiapkan edit untuk Dokter ID (UID): ${id}`);
            // Populate form fields
            doctorIdInput.value = id; // Store UID here
            doctorUidInput.value = uid; // Also store UID here for clarity, though redundant with doctorIdInput
            doctorNameInput.value = nama;
            doctorSpecializationInput.value = spesialisasi;
            doctorHospitalSelect.value = rumah_sakit_id;
            doctorPracticeDaysInput.value = hari_praktik;
            doctorStartTimeInput.value = jam_mulai;
            doctorEndTimeInput.value = jam_selesai;

            // Update form title and submit button for edit mode
            doctorFormTitle.textContent = "Edit Data Dokter";
            doctorSubmitBtn.innerHTML = `<i class="fas fa-save mr-2"></i> Simpan Perubahan`;
            doctorSubmitBtn.classList.remove('btn-tambah');
            doctorSubmitBtn.classList.add('btn-simpan');
            cancelDoctorEditBtn.classList.remove('hidden'); // Show cancel button

            // Hide email/password fields in edit mode
            if (authFieldsDiv) {
                authFieldsDiv.style.display = 'none';
                // Remove required attribute from email/password in edit mode
                if(doctorEmailInput) doctorEmailInput.required = false;
                if(doctorPasswordInput) doctorPasswordInput.required = false;
                // Clear email/password values just in case
                if(doctorEmailInput) doctorEmailInput.value = '';
                if(doctorPasswordInput) doctorPasswordInput.value = '';
            }

            // Ensure the modal is open and scroll to the form
            openDoctorCrudModal(); // This will also reload hospitals and doctors
            doctorCrudForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        /**
         * Resets the doctor form to the "Add New Doctor" state.
         */
        function resetDoctorForm() {
            console.log("Mereset form dokter ke mode tambah.");
            // Reset form fields
            if (doctorCrudForm) doctorCrudForm.reset();
            if (doctorIdInput) doctorIdInput.value = ''; // Clear ID
            if (doctorUidInput) doctorUidInput.value = ''; // Clear UID field
            if (doctorFormTitle) doctorFormTitle.textContent = "Tambah Dokter Baru";
            if (doctorSubmitBtn) {
                doctorSubmitBtn.innerHTML = `<i class="fas fa-plus mr-2"></i> Tambah Dokter`;
                doctorSubmitBtn.classList.remove('btn-simpan');
                doctorSubmitBtn.classList.add('btn-tambah');
            }
            if (cancelDoctorEditBtn) cancelDoctorEditBtn.classList.add('hidden'); // Hide cancel button

            // Show email/password fields in add mode and make them required
            if (authFieldsDiv) {
                authFieldsDiv.style.display = 'block';
                if(doctorEmailInput) doctorEmailInput.required = true;
                if(doctorPasswordInput) doctorPasswordInput.required = true;
            }

            // Reset select/input values explicitly if needed (form.reset() should handle this)
            if (doctorHospitalSelect) doctorHospitalSelect.value = "";
            if (doctorPracticeDaysInput) doctorPracticeDaysInput.value = "";
            if (doctorStartTimeInput) doctorStartTimeInput.value = "";
            if (doctorEndTimeInput) doctorEndTimeInput.value = "";
            if (doctorEmailInput) doctorEmailInput.value = "";
            if (doctorPasswordInput) doctorPasswordInput.value = "";
        }

        /**
         * Handles the submission of the doctor form (Add or Edit).
         * Includes Firebase Authentication user creation for new doctors
         * and calling backend to set custom claim.
         * @param {Event} event - The form submit event.
         */
        async function handleDoctorFormSubmit(event) {
            event.preventDefault(); // Prevent default form submission

            const doctorId = doctorIdInput.value; // Realtime Database Key (which is the UID)
            // In edit mode, doctorId will be the UID. In add mode, it's empty.
            const doctorName = doctorNameInput.value.trim();
            const doctorSpecialization = doctorSpecializationInput.value.trim();
            const doctorHospitalSelectElement = doctorHospitalSelect; // Get the select element
            const doctorHospitalId = doctorHospitalSelectElement.value;
            const doctorHospitalName = doctorHospitalSelectElement.selectedIndex >= 0 && doctorHospitalSelectElement.options[doctorHospitalSelectElement.selectedIndex] ? doctorHospitalSelectElement.options[doctorHospitalSelectElement.selectedIndex].text : '';
            const doctorPracticeDays = doctorPracticeDaysInput.value.trim();
            const doctorStartTime = doctorStartTimeInput.value;
            const doctorEndTime = doctorEndTimeInput.value;
            const doctorEmail = doctorEmailInput.value.trim(); // Get email
            const doctorPassword = doctorPasswordInput.value; // Get password

            // Basic input validation for all modes
            if (!doctorName || !doctorSpecialization || !doctorHospitalId || !doctorPracticeDays || !doctorStartTime || !doctorEndTime) {
                Swal.fire('Input Tidak Lengkap', 'Harap isi semua kolom yang bertanda *.', 'warning');
                return;
            }

            // Validation specific to adding a new doctor (when doctorId is empty)
            if (!doctorId) { // This is 'Add New Doctor' mode
                if (!doctorEmail || !doctorPassword) {
                    Swal.fire('Input Tidak Lengkap', 'Harap isi Email dan Password untuk akun dokter baru.', 'warning');
                    return;
                }
                if (doctorPassword.length < 6) { // Firebase Auth requires minimum 6 characters for password
                    Swal.fire('Password Lemah', 'Password minimal 6 karakter.', 'warning');
                    return;
                }
            }


            // Check Firebase readiness
            if (!firebaseDb || !firebaseAuth) {
                Swal.fire('Error Koneksi', 'Koneksi database atau autentikasi belum siap.', 'error');
                return;
            }

            // Disable submit button and show loading state
            doctorSubmitBtn.disabled = true;
            doctorSubmitBtn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> Menyimpan...`;

            try {
                let finalDoctorData = {
                    nama: doctorName,
                    spesialisasi: doctorSpecialization,
                    rumah_sakit_id: doctorHospitalId,
                    rumah_sakit_nama: doctorHospitalName,
                    hari_praktik: doctorPracticeDays,
                    jam_mulai: doctorStartTime,
                    jam_selesai: doctorEndTime
                    // UID will be added below for new doctors
                };

                let successMessage;
                let targetDoctorUid = doctorId; // In edit mode, doctorId will be the UID

                if (!doctorId) {
                    // --- ADD NEW DOCTOR ---
                    console.log(`Menambah dokter baru dengan email: ${doctorEmail}`);
                    // 1. Create user in Firebase Authentication
                    const userCredential = await firebaseAuth.createUserWithEmailAndPassword(doctorEmail, doctorPassword);
                    targetDoctorUid = userCredential.user.uid; // Get the UID of the newly created user
                    console.log(`User Authentication berhasil dibuat dengan UID: ${targetDoctorUid}`);

                    // Add the UID to the doctor data
                    finalDoctorData.uid = targetDoctorUid; // Store UID in DB data

                    // 2. Save doctor data to Realtime Database using UID as key
                    // Use .set() with the UID key to ensure one entry per doctor UID
                    await firebaseDb.ref(`daftar_dokter/${targetDoctorUid}`).set(finalDoctorData);
                    console.log(`Data dokter berhasil disimpan ke RTDB dengan key UID: ${targetDoctorUid}`);

                    // 3. Call backend endpoint to set 'doctor: true' custom claim
                    console.log(`Memanggil backend untuk menetapkan klaim dokter untuk UID: ${targetDoctorUid}`);

                    // Ambil ID Token admin yang sedang login untuk otentikasi backend
                    const adminUser = firebaseAuth.currentUser;
                    if (!adminUser) {
                        // This should ideally not happen if verifyAdmin on backend works, but good fallback
                        throw new Error("Admin user not logged in to set doctor claim.");
                    }
                    const idToken = await adminUser.getIdToken(); // Dapatkan ID Token admin

                    const setClaimResponse = await fetch('/api/set-doctor-claim', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${idToken}` // Kirim ID Token admin untuk otentikasi
                        },
                        body: JSON.stringify({ uid: targetDoctorUid })
                    });

                    const setClaimResult = await setClaimResponse.json();

                    if (!setClaimResponse.ok) {
                        // Jika backend gagal mengatur klaim
                        console.error("Backend failed to set doctor claim:", setClaimResult.message);
                        // Tampilkan pesan peringatan, tapi proses penambahan dokter (Auth & DB) sudah berhasil
                        Swal.fire({
                            title: 'Dokter Ditambahkan (Klaim Gagal)',
                            html: `Dokter "${escapeHtml(doctorName)}" berhasil ditambahkan, dan akun login dibuat.<br><strong>Namun, gagal mengatur klaim 'doctor: true' di backend:</strong> ${escapeHtml(setClaimResult.message || 'Unknown error')}.<br>Dokter mungkin tidak bisa login sebagai dokter sampai klaim diperbaiki secara manual di backend.`,
                            icon: 'warning',
                            confirmButtonText: 'OK'
                        });
                    } else {
                        // Jika backend berhasil mengatur klaim
                        console.log("Backend successfully set doctor claim:", setClaimResult.message);
                        Swal.fire({
                            title: 'Dokter Berhasil Ditambahkan',
                            html: `Dokter "${escapeHtml(doctorName)}" berhasil ditambahkan.<br>Akun login dibuat dengan email: <strong>${escapeHtml(doctorEmail)}</strong>.<br>berhasil diatur.`,
                            icon: 'success',
                            confirmButtonText: 'OK'
                        });
                    }

                } else {
                    // --- EDIT EXISTING DOCTOR ---
                    console.log(`Memperbarui data dokter ID (UID): ${doctorId}`);
                    // In edit mode, we only update the data in Realtime Database
                    // We don't change the email/password or create a new Auth user here
                    // Ensure UID is still in the data if it was there
                    if (!finalDoctorData.uid) { // If UID wasn't loaded for some reason, use the ID (which is the UID)
                            finalDoctorData.uid = doctorId;
                    }
                    await firebaseDb.ref(`daftar_dokter/${doctorId}`).update(finalDoctorData);
                    successMessage = `Data dokter "${doctorName}" berhasil diperbarui.`;
                    Swal.fire('Berhasil!', successMessage, 'success'); // Tampilkan pesan sukses edit
                }

                // Reset form and reload the list after successful operation (add or edit)
                resetDoctorForm();
                await loadAndDisplayDoctors(); // Reload list
                // Close the modal after successful operation if it's an add operation
                if (!doctorId) {
                    closeDoctorCrudModal();
                }

            } catch (error) {
                // Tangani error saat menyimpan data dokter atau membuat user/mengatur klaim
                console.error("Gagal menyimpan data dokter, membuat user, atau mengatur klaim:", error);
                let errorMessage = `Terjadi kesalahan: ${error.message}`;

                    // Handle specific Firebase Auth errors during user creation (only for add mode)
                    if (!doctorId && error.code) { // Only check auth errors if adding a new doctor
                        switch (error.code) {
                            case 'auth/email-already-in-use':
                                errorMessage = 'Email sudah digunakan oleh akun lain.';
                                break;
                            case 'auth/invalid-email':
                                errorMessage = 'Format email tidak valid.';
                                break;
                            case 'auth/operation-not-allowed':
                                errorMessage = 'Pembuatan akun email/password tidak diaktifkan di Firebase Console.';
                                break;
                            case 'auth/weak-password':
                                errorMessage = 'Password terlalu lemah (minimal 6 karakter).';
                                break;
                            default:
                                // Use the default error message
                                break;
                        }
                    } else if (error.message.includes("Failed to fetch") || error.message.includes("Network response was not ok") || error.message.includes("Gagal memuat konfigurasi layanan")) {
                        // Handle network/config errors during backend call or initial fetch
                        errorMessage = `Kesalahan jaringan atau konfigurasi: ${error.message}`;
                    }


                Swal.fire('Gagal!', errorMessage, 'error');

            } finally {
                // Re-enable submit button and restore original text
                doctorSubmitBtn.disabled = false;
                if (doctorIdInput.value) {
                    doctorSubmitBtn.innerHTML = `<i class="fas fa-save mr-2"></i> Simpan Perubahan`;
                } else {
                    doctorSubmitBtn.innerHTML = `<i class="fas fa-plus mr-2"></i> Tambah Dokter`;
                }
            }
        }

        /**
         * Prompts the user to confirm deletion of a doctor and deletes if confirmed.
         * This function only deletes the data from Realtime Database.
         * Deleting the corresponding Auth user must be done separately (preferably from backend).
         * @param {string} id - The Realtime Database key (which is the UID) of the doctor to delete.
         * @param {string} name - The name of the doctor (for confirmation message).
         */
        window.confirmDeleteDoctor = (id, name) => {
             if (!firebaseDb) { Swal.fire('Error Koneksi', 'Koneksi database belum siap.', 'error'); return; }

             Swal.fire({
                 title: 'Hapus Dokter?',
                 html: `Anda yakin ingin menghapus data dokter <strong>${escapeHtml(name)}</strong> dari daftar? Tindakan ini tidak dapat diurungkan.<br><br><strong>Penting:</strong> Ini hanya menghapus data dokter dari database. Akun login dokter di Firebase Authentication (UID: ${escapeHtml(id)}) <strong>tidak otomatis terhapus</strong>. Anda perlu menghapusnya secara manual di Firebase Console atau melalui Admin SDK di backend jika diperlukan.`,
                 icon: 'warning',
                 showCancelButton: true,
                 // Use CSS variables for button colors
                 confirmButtonColor: getComputedStyle(document.documentElement).getPropertyValue('--danger-color').trim(),
                 cancelButtonColor: getComputedStyle(document.documentElement).getPropertyValue('--text-muted').trim(),
                 confirmButtonText: 'Ya, Hapus Data Dokter!',
                 cancelButtonText: 'Batal'
             }).then(async (result) => {
                 if (result.isConfirmed) {
                     console.log(`Menghapus data Dokter ID (UID): ${id} dari database.`);
                     try {
                         // Delete data from Realtime Database using the UID as the key
                         await firebaseDb.ref(`daftar_dokter/${id}`).remove();

                         console.warn(`PENTING: Data dokter dengan UID ${id} dihapus dari RTDB. User Authentication dengan UID ini TIDAK otomatis terhapus.`);


                         Swal.fire('Dihapus!', `Data dokter "${escapeHtml(name)}" telah dihapus dari daftar.`, 'success');

                         // If the deleted doctor was being edited, reset the form
                         if (doctorIdInput.value === id) {
                             resetDoctorForm();
                         }

                         // Reload the doctor list
                         await loadAndDisplayDoctors();

                     } catch (error) {
                             console.error(`Gagal menghapus data Dokter ID (UID) ${id}:`, error);
                             Swal.fire('Gagal!', `Gagal menghapus data dokter: ${error.message}`, 'error');
                     }
                 }
             });
         }


        // Listener untuk tombol Histori Deteksi
        if (scrollToDetectionHistoryBtn) {
            scrollToDetectionHistoryBtn.addEventListener('click', (event) => {
                event.preventDefault();
                showDetectionHistorySection();

                const targetElement = document.getElementById('detectionHistorySection');
                if (targetElement) {
                    targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    console.log("Scrolling to Detection History Section.");
                } else {
                    console.warn("Detection History Section element not found for scrolling.");
                }

                if (window.innerWidth < 768 && filterSidebar.classList.contains('open-mobile')) {
                        filterSidebar.classList.remove('open-mobile');
                        sidebarOverlay.classList.add('hidden');
                        document.body.classList.remove('overflow-hidden-custom');
                    }
                // Remove active class from all filter buttons in sidebar
                document.querySelectorAll('#filterSidebar .filter-btn').forEach(btn => btn.classList.remove('active'));
                // Add active class to the history button
                scrollToDetectionHistoryBtn.classList.add('active');
            });
        } else {
             console.warn("Tombol #scrollToDetectionHistoryBtn tidak ditemukan.");
        }

        // Listener untuk tombol Histori Pasien (NEW)
        if (openPatientHistorySectionBtn) {
            openPatientHistorySectionBtn.addEventListener('click', (event) => {
                event.preventDefault();
                showPatientHistorySection();

                const targetElement = document.getElementById('patientHistorySection');
                if (targetElement) {
                    targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    console.log("Scrolling to Patient History Section.");
                } else {
                    console.warn("Patient History Section element not found for scrolling.");
                }

                if (window.innerWidth < 768 && filterSidebar.classList.contains('open-mobile')) {
                    filterSidebar.classList.remove('open-mobile');
                    sidebarOverlay.classList.add('hidden');
                    document.body.classList.remove('overflow-hidden-custom');
                }
                // Remove active class from all filter buttons in sidebar
                document.querySelectorAll('#filterSidebar .filter-btn').forEach(btn => btn.classList.remove('active'));
                // Add active class to the patient history button
                openPatientHistorySectionBtn.classList.add('active');
            });
        } else {
            console.warn("Tombol #openPatientHistorySectionBtn tidak ditemukan.");
        }


        // --- Alur Utama Aplikasi ---
        /** Fungsi utama yang dijalankan saat halaman dimuat */
        async function main() {
            initializeTheme();
            showLoading(true);

            const firebaseConfig = await fetchFirebaseConfig();

            if (firebaseConfig && initializeFirebase(firebaseConfig)) {
                firebaseAuth.onAuthStateChanged(async (user) => {
                    if (user) {
                        try {
                            const idTokenResult = await user.getIdTokenResult(true);
                            if (idTokenResult.claims.admin === true) {
                                console.log("Admin terverifikasi.");
                                addStatusFilterListeners(); // Add listeners after buttons exist
                                showReservationSection(); // Default view is reservations
                                listenReservations(); // Start listening for real-time updates
                                loadAndDisplayDetectionHistory(); // Load history initially
                                // No need to load patient history here, it will be loaded when its button is clicked.
                            } else {
                                console.warn("Akses ditolak: Pengguna bukan admin.");
                                showErrorMessage("Anda tidak memiliki hak akses sebagai admin untuk halaman ini.");
                                setTimeout(logoutUser, 4000);
                            }
                        } catch (error) {
                            console.error("Error saat memeriksa custom claims admin:", error);
                            showErrorMessage("Gagal melakukan verifikasi status admin. Silakan coba login kembali.");
                            setTimeout(logoutUser, 4000);
                        }
                    } else {
                        console.log("Tidak ada pengguna yang login. Mengarahkan ke halaman login.");
                        window.location.href = 'login.html';
                    }
                });
            } else {
                showLoading(false);
            }
        }

        // Jalankan fungsi utama saat DOM siap
        document.addEventListener('DOMContentLoaded', main);

    </script>
</body>
</html>